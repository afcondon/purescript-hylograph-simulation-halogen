// Generated by purs version 0.15.15
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Control_Monad_State_Class from "../Control.Monad.State.Class/index.js";
import * as Control_Monad_State_Trans from "../Control.Monad.State.Trans/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as Data_String_Common from "../Data.String.Common/index.js";
import * as Data_Traversable from "../Data.Traversable/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Effect from "../Effect/index.js";
import * as PSD3_AST from "../PSD3.AST/index.js";
import * as PSD3_Internal_Attribute from "../PSD3.Internal.Attribute/index.js";
import * as PSD3_Internal_Selection_Types from "../PSD3.Internal.Selection.Types/index.js";
var bindStateT = /* #__PURE__ */ Control_Monad_State_Trans.bindStateT(Effect.monadEffect);
var applicativeStateT = /* #__PURE__ */ Control_Monad_State_Trans.applicativeStateT(Effect.monadEffect);
var bind = /* #__PURE__ */ Control_Bind.bind(bindStateT);
var monadStateStateT = /* #__PURE__ */ Control_Monad_State_Trans.monadStateStateT(Effect.monadEffect);
var get = /* #__PURE__ */ Control_Monad_State_Class.get(monadStateStateT);
var show = /* #__PURE__ */ Data_Show.show(Data_Show.showInt);
var discard = /* #__PURE__ */ Control_Bind.discard(Control_Bind.discardUnit);
var discard1 = /* #__PURE__ */ discard(bindStateT);
var modify_ = /* #__PURE__ */ Control_Monad_State_Class.modify_(monadStateStateT);
var pure = /* #__PURE__ */ Control_Applicative.pure(applicativeStateT);
var MermaidTreeM = function (x) {
    return x;
};
var showElement = function (v) {
    if (v instanceof PSD3_Internal_Selection_Types.SVG) {
        return "svg";
    };
    if (v instanceof PSD3_Internal_Selection_Types.Group) {
        return "g";
    };
    if (v instanceof PSD3_Internal_Selection_Types.Circle) {
        return "circle";
    };
    if (v instanceof PSD3_Internal_Selection_Types.Rect) {
        return "rect";
    };
    if (v instanceof PSD3_Internal_Selection_Types.Line) {
        return "line";
    };
    if (v instanceof PSD3_Internal_Selection_Types.Polygon) {
        return "polygon";
    };
    if (v instanceof PSD3_Internal_Selection_Types.Path) {
        return "path";
    };
    if (v instanceof PSD3_Internal_Selection_Types.Text) {
        return "text";
    };
    if (v instanceof PSD3_Internal_Selection_Types.Div) {
        return "div";
    };
    if (v instanceof PSD3_Internal_Selection_Types.Span) {
        return "span";
    };
    if (v instanceof PSD3_Internal_Selection_Types.Table) {
        return "table";
    };
    if (v instanceof PSD3_Internal_Selection_Types.Tr) {
        return "tr";
    };
    if (v instanceof PSD3_Internal_Selection_Types.Td) {
        return "td";
    };
    if (v instanceof PSD3_Internal_Selection_Types.Th) {
        return "th";
    };
    if (v instanceof PSD3_Internal_Selection_Types.Thead) {
        return "thead";
    };
    if (v instanceof PSD3_Internal_Selection_Types.Tbody) {
        return "tbody";
    };
    if (v instanceof PSD3_Internal_Selection_Types.Defs) {
        return "defs";
    };
    if (v instanceof PSD3_Internal_Selection_Types.LinearGradient) {
        return "linearGradient";
    };
    if (v instanceof PSD3_Internal_Selection_Types.Stop) {
        return "stop";
    };
    if (v instanceof PSD3_Internal_Selection_Types.PatternFill) {
        return "pattern";
    };
    throw new Error("Failed pattern match at PSD3.Interpreter.Mermaid (line 71, column 1 - line 71, column 37): " + [ v.constructor.name ]);
};
var monadMermaidTreeM = /* #__PURE__ */ Control_Monad_State_Trans.monadStateT(Effect.monadEffect);
var generateStyleDefinitions = /* #__PURE__ */ (function () {
    return "\x0a    %% Style definitions\x0a" + ("    classDef elementNode fill:#e6f598,stroke:#abdda4,stroke-width:2px\x0a" + ("    classDef joinNode fill:#f46d43,stroke:#d53e4f,stroke-width:2px\x0a" + ("    classDef nestedJoinNode fill:#fdae61,stroke:#f46d43,stroke-width:2px\x0a" + ("    classDef templateNode fill:#abdda4,stroke:#66c2a5,stroke-width:2px\x0a" + "    classDef decomposeNode fill:#fee08b,stroke:#fdae61,stroke-width:2px\x0a"))));
})();
var functorMermaidTreeM = /* #__PURE__ */ Control_Monad_State_Trans.functorStateT(Effect.functorEffect);
var formatAttrSource = function (name) {
    return function (v) {
        if (v instanceof PSD3_Internal_Attribute.UnknownSource) {
            return name + "(d)";
        };
        if (v instanceof PSD3_Internal_Attribute.StaticSource) {
            return name;
        };
        if (v instanceof PSD3_Internal_Attribute.FieldSource) {
            return name + ("=d." + v.value0);
        };
        if (v instanceof PSD3_Internal_Attribute.ExprSource) {
            return name + ("=(" + (v.value0 + ")"));
        };
        if (v instanceof PSD3_Internal_Attribute.IndexSource) {
            return name + "=i";
        };
        if (v instanceof PSD3_Internal_Attribute.OpaqueSource) {
            return name + "=OPAQUE";
        };
        throw new Error("Failed pattern match at PSD3.Interpreter.Mermaid (line 104, column 25 - line 110, column 36): " + [ v.constructor.name ]);
    };
};
var formatAttribute = function (v) {
    if (v instanceof PSD3_Internal_Attribute.StaticAttr) {
        return v.value0;
    };
    if (v instanceof PSD3_Internal_Attribute.DataAttr) {
        return formatAttrSource(v.value0)(v.value1);
    };
    if (v instanceof PSD3_Internal_Attribute.IndexedAttr) {
        return formatAttrSource(v.value0)(v.value1);
    };
    if (v instanceof PSD3_Internal_Attribute.AnimatedAttr) {
        return v.value0.name + "(anim)";
    };
    if (v instanceof PSD3_Internal_Attribute.AnimatedCompound) {
        return v.value0.name + "(compound-anim)";
    };
    throw new Error("Failed pattern match at PSD3.Interpreter.Mermaid (line 95, column 19 - line 100, column 91): " + [ v.constructor.name ]);
};
var formatAttributeList = function (attrs) {
    if (attrs.length === 0) {
        return "";
    };
    return Data_Array.foldl(function (acc) {
        return function (attr) {
            var $57 = acc === "";
            if ($57) {
                return formatAttribute(attr);
            };
            return acc + (", " + formatAttribute(attr));
        };
    })("")(attrs);
};
var escapeLabel = /* #__PURE__ */ Data_String_Common.replaceAll("\"")("'");
var bindMermaidTreeM = bindStateT;
var bind2 = /* #__PURE__ */ Control_Bind.bind(bindMermaidTreeM);
var discard2 = /* #__PURE__ */ discard(bindMermaidTreeM);
var applyMermaidTreeM = /* #__PURE__ */ Control_Monad_State_Trans.applyStateT(Effect.monadEffect);
var applicativeMermaidTreeM = applicativeStateT;
var traverse = /* #__PURE__ */ Data_Traversable.traverse(Data_Traversable.traversableArray)(applicativeMermaidTreeM);
var pure2 = /* #__PURE__ */ Control_Applicative.pure(applicativeMermaidTreeM);
var addNode = function (label) {
    return function (styleClass) {
        return bind(get)(function (state) {
            var nodeName = "n" + show(state.nodeCounter);
            var escapedLabel = escapeLabel(label);
            var line = "    " + (nodeName + ("[\"" + (escapedLabel + ("\"]:::" + (styleClass + "\x0a")))));
            return discard1(modify_(function (s) {
                var $58 = {};
                for (var $59 in s) {
                    if ({}.hasOwnProperty.call(s, $59)) {
                        $58[$59] = s[$59];
                    };
                };
                $58.nodeCounter = s.nodeCounter + 1 | 0;
                $58.mermaidCode = s.mermaidCode + line;
                return $58;
            }))(function () {
                return pure(state.nodeCounter);
            });
        });
    };
};
var addEdge = function (fromId) {
    return function (toId) {
        var toName = "n" + show(toId);
        var fromName = "n" + show(fromId);
        var line = "    " + (fromName + (" --> " + (toName + "\x0a")));
        return modify_(function (s) {
            var $61 = {};
            for (var $62 in s) {
                if ({}.hasOwnProperty.call(s, $62)) {
                    $61[$62] = s[$62];
                };
            };
            $61.mermaidCode = s.mermaidCode + line;
            return $61;
        });
    };
};
var renderTree = function (tree) {
    return function (parentId) {
        var traverseWithParent = function (pid) {
            return function (children) {
                return bind2(traverse(function (child) {
                    return renderTree(child)(new Data_Maybe.Just(pid));
                })(children))(function () {
                    return pure2(Data_Unit.unit);
                });
            };
        };
        if (tree instanceof PSD3_AST.Node) {
            var nodeLabel = (function () {
                if (tree.value0.name instanceof Data_Maybe.Just) {
                    return "<" + (showElement(tree.value0.elemType) + (" \"" + (tree.value0.name.value0 + "\">")));
                };
                if (tree.value0.name instanceof Data_Maybe.Nothing) {
                    return showElement(tree.value0.elemType);
                };
                throw new Error("Failed pattern match at PSD3.Interpreter.Mermaid (line 124, column 21 - line 126, column 47): " + [ tree.value0.name.constructor.name ]);
            })();
            var attrSuffix = (function () {
                var $67 = Data_Array.length(tree.value0.attrs) > 0;
                if ($67) {
                    return " + [" + (formatAttributeList(tree.value0.attrs) + "]");
                };
                return "";
            })();
            var fullLabel = nodeLabel + attrSuffix;
            return bind2(addNode(fullLabel)("elementNode"))(function (nodeId) {
                return discard2((function () {
                    if (parentId instanceof Data_Maybe.Just) {
                        return addEdge(parentId.value0)(nodeId);
                    };
                    if (parentId instanceof Data_Maybe.Nothing) {
                        return pure2(Data_Unit.unit);
                    };
                    throw new Error("Failed pattern match at PSD3.Interpreter.Mermaid (line 135, column 5 - line 137, column 27): " + [ parentId.constructor.name ]);
                })())(function () {
                    return bind2(traverseWithParent(nodeId)(tree.value0.children))(function () {
                        return pure2(nodeId);
                    });
                });
            });
        };
        if (tree instanceof PSD3_AST.Join) {
            var joinLabel = "JOIN \"" + (tree.value0.name + ("\" (" + (tree.value0.key + (") [" + (show(Data_Array.length(tree.value0.joinData)) + " items]")))));
            return bind2(addNode(joinLabel)("joinNode"))(function (joinId) {
                return discard2((function () {
                    if (parentId instanceof Data_Maybe.Just) {
                        return addEdge(parentId.value0)(joinId);
                    };
                    if (parentId instanceof Data_Maybe.Nothing) {
                        return pure2(Data_Unit.unit);
                    };
                    throw new Error("Failed pattern match at PSD3.Interpreter.Mermaid (line 149, column 5 - line 151, column 27): " + [ parentId.constructor.name ]);
                })())(function () {
                    return bind2(addNode("template(datum) \u2192")("templateNode"))(function (templateLabel) {
                        return discard2(addEdge(joinId)(templateLabel))(function () {
                            return discard2((function () {
                                var v = Data_Array.uncons(tree.value0.joinData);
                                if (v instanceof Data_Maybe.Nothing) {
                                    return pure2(Data_Unit.unit);
                                };
                                if (v instanceof Data_Maybe.Just) {
                                    var templateTree = tree.value0.template(v.value0.head);
                                    return bind2(renderTree(templateTree)(new Data_Maybe.Just(templateLabel)))(function () {
                                        return pure2(Data_Unit.unit);
                                    });
                                };
                                throw new Error("Failed pattern match at PSD3.Interpreter.Mermaid (line 158, column 5 - line 163, column 18): " + [ v.constructor.name ]);
                            })())(function () {
                                return pure2(joinId);
                            });
                        });
                    });
                });
            });
        };
        if (tree instanceof PSD3_AST.NestedJoin) {
            var joinLabel = "NESTED JOIN \"" + (tree.value0.name + ("\" (" + (tree.value0.key + (") [" + (show(Data_Array.length(tree.value0.joinData)) + " items]")))));
            return bind2(addNode(joinLabel)("nestedJoinNode"))(function (joinId) {
                return discard2((function () {
                    if (parentId instanceof Data_Maybe.Just) {
                        return addEdge(parentId.value0)(joinId);
                    };
                    if (parentId instanceof Data_Maybe.Nothing) {
                        return pure2(Data_Unit.unit);
                    };
                    throw new Error("Failed pattern match at PSD3.Interpreter.Mermaid (line 173, column 5 - line 175, column 27): " + [ parentId.constructor.name ]);
                })())(function () {
                    return bind2(addNode("decompose(datum) \u2192")("decomposeNode"))(function (decomposeId) {
                        return discard2(addEdge(joinId)(decomposeId))(function () {
                            return bind2(addNode("template(innerDatum) \u2192")("templateNode"))(function (templateId) {
                                return discard2(addEdge(decomposeId)(templateId))(function () {
                                    return discard2((function () {
                                        var v = Data_Array.uncons(tree.value0.joinData);
                                        if (v instanceof Data_Maybe.Nothing) {
                                            return pure2(Data_Unit.unit);
                                        };
                                        if (v instanceof Data_Maybe.Just) {
                                            var innerData = tree.value0.decompose(v.value0.head);
                                            var v1 = Data_Array.uncons(innerData);
                                            if (v1 instanceof Data_Maybe.Nothing) {
                                                return pure2(Data_Unit.unit);
                                            };
                                            if (v1 instanceof Data_Maybe.Just) {
                                                var templateTree = tree.value0.template(v1.value0.head);
                                                return bind2(renderTree(templateTree)(new Data_Maybe.Just(templateId)))(function () {
                                                    return pure2(Data_Unit.unit);
                                                });
                                            };
                                            throw new Error("Failed pattern match at PSD3.Interpreter.Mermaid (line 190, column 9 - line 195, column 22): " + [ v1.constructor.name ]);
                                        };
                                        throw new Error("Failed pattern match at PSD3.Interpreter.Mermaid (line 186, column 5 - line 195, column 22): " + [ v.constructor.name ]);
                                    })())(function () {
                                        return pure2(joinId);
                                    });
                                });
                            });
                        });
                    });
                });
            });
        };
        if (tree instanceof PSD3_AST.UpdateJoin) {
            var behaviorInfo = (function () {
                var $86 = Data_Maybe.isJust(tree.value0.behaviors.enter);
                if ($86) {
                    return "E";
                };
                return "";
            })() + ((function () {
                var $87 = Data_Maybe.isJust(tree.value0.behaviors.update);
                if ($87) {
                    return "U";
                };
                return "";
            })() + (function () {
                var $88 = Data_Maybe.isJust(tree.value0.behaviors.exit);
                if ($88) {
                    return "X";
                };
                return "";
            })());
            var joinLabel = "UPDATE JOIN \"" + (tree.value0.name + ("\" (" + (tree.value0.key + (") [" + (show(Data_Array.length(tree.value0.joinData)) + (" items] {" + (behaviorInfo + "}")))))));
            return bind2(addNode(joinLabel)("updateJoinNode"))(function (joinId) {
                return discard2((function () {
                    if (parentId instanceof Data_Maybe.Just) {
                        return addEdge(parentId.value0)(joinId);
                    };
                    if (parentId instanceof Data_Maybe.Nothing) {
                        return pure2(Data_Unit.unit);
                    };
                    throw new Error("Failed pattern match at PSD3.Interpreter.Mermaid (line 210, column 5 - line 212, column 27): " + [ parentId.constructor.name ]);
                })())(function () {
                    return bind2(addNode("template(datum) \u2192")("templateNode"))(function (templateLabel) {
                        return discard2(addEdge(joinId)(templateLabel))(function () {
                            return discard2((function () {
                                var v = Data_Array.uncons(tree.value0.joinData);
                                if (v instanceof Data_Maybe.Nothing) {
                                    return pure2(Data_Unit.unit);
                                };
                                if (v instanceof Data_Maybe.Just) {
                                    var templateTree = tree.value0.template(v.value0.head);
                                    return bind2(renderTree(templateTree)(new Data_Maybe.Just(templateLabel)))(function () {
                                        return pure2(Data_Unit.unit);
                                    });
                                };
                                throw new Error("Failed pattern match at PSD3.Interpreter.Mermaid (line 219, column 5 - line 224, column 18): " + [ v.constructor.name ]);
                            })())(function () {
                                return pure2(joinId);
                            });
                        });
                    });
                });
            });
        };
        if (tree instanceof PSD3_AST.UpdateNestedJoin) {
            var behaviorInfo = (function () {
                var $95 = Data_Maybe.isJust(tree.value0.behaviors.enter);
                if ($95) {
                    return "E";
                };
                return "";
            })() + ((function () {
                var $96 = Data_Maybe.isJust(tree.value0.behaviors.update);
                if ($96) {
                    return "U";
                };
                return "";
            })() + (function () {
                var $97 = Data_Maybe.isJust(tree.value0.behaviors.exit);
                if ($97) {
                    return "X";
                };
                return "";
            })());
            var joinLabel = "UPDATE NESTED JOIN \"" + (tree.value0.name + ("\" (" + (tree.value0.key + (") [" + (show(Data_Array.length(tree.value0.joinData)) + (" items] {" + (behaviorInfo + "}")))))));
            return bind2(addNode(joinLabel)("updateNestedJoinNode"))(function (joinId) {
                return discard2((function () {
                    if (parentId instanceof Data_Maybe.Just) {
                        return addEdge(parentId.value0)(joinId);
                    };
                    if (parentId instanceof Data_Maybe.Nothing) {
                        return pure2(Data_Unit.unit);
                    };
                    throw new Error("Failed pattern match at PSD3.Interpreter.Mermaid (line 239, column 5 - line 241, column 27): " + [ parentId.constructor.name ]);
                })())(function () {
                    return bind2(addNode("decompose(datum) \u2192")("decomposeNode"))(function (decomposeId) {
                        return discard2(addEdge(joinId)(decomposeId))(function () {
                            return bind2(addNode("template(innerDatum) \u2192")("templateNode"))(function (templateLabel) {
                                return discard2(addEdge(decomposeId)(templateLabel))(function () {
                                    return discard2((function () {
                                        var v = Data_Array.uncons(tree.value0.joinData);
                                        if (v instanceof Data_Maybe.Nothing) {
                                            return pure2(Data_Unit.unit);
                                        };
                                        if (v instanceof Data_Maybe.Just) {
                                            var innerData = tree.value0.decompose(v.value0.head);
                                            var v1 = Data_Array.uncons(innerData);
                                            if (v1 instanceof Data_Maybe.Nothing) {
                                                return pure2(Data_Unit.unit);
                                            };
                                            if (v1 instanceof Data_Maybe.Just) {
                                                var templateTree = tree.value0.template(v1.value0.head);
                                                return bind2(renderTree(templateTree)(new Data_Maybe.Just(templateLabel)))(function () {
                                                    return pure2(Data_Unit.unit);
                                                });
                                            };
                                            throw new Error("Failed pattern match at PSD3.Interpreter.Mermaid (line 256, column 9 - line 261, column 22): " + [ v1.constructor.name ]);
                                        };
                                        throw new Error("Failed pattern match at PSD3.Interpreter.Mermaid (line 252, column 5 - line 261, column 22): " + [ v.constructor.name ]);
                                    })())(function () {
                                        return pure2(joinId);
                                    });
                                });
                            });
                        });
                    });
                });
            });
        };
        if (tree instanceof PSD3_AST.ConditionalRender) {
            var condLabel = "CONDITIONAL RENDER [" + (show(Data_Array.length(tree.value0.cases)) + " cases]");
            return bind2(addNode(condLabel)("conditionalNode"))(function (condId) {
                return discard2((function () {
                    if (parentId instanceof Data_Maybe.Just) {
                        return addEdge(parentId.value0)(condId);
                    };
                    if (parentId instanceof Data_Maybe.Nothing) {
                        return pure2(Data_Unit.unit);
                    };
                    throw new Error("Failed pattern match at PSD3.Interpreter.Mermaid (line 271, column 5 - line 273, column 27): " + [ parentId.constructor.name ]);
                })())(function () {
                    return bind2(traverse(function (i) {
                        return bind2(addNode("case " + (show(i + 1 | 0) + ": predicate \u2192 spec"))("caseNode"))(function (caseLabel) {
                            return discard2(addEdge(condId)(caseLabel))(function () {
                                return pure2(caseLabel);
                            });
                        });
                    })(Data_Array.range(0)(Data_Array.length(tree.value0.cases) - 1 | 0)))(function () {
                        return pure2(condId);
                    });
                });
            });
        };
        if (tree instanceof PSD3_AST.LocalCoordSpace) {
            return bind2(addNode("LOCAL COORD SPACE")("coordSpaceNode"))(function (coordId) {
                return discard2((function () {
                    if (parentId instanceof Data_Maybe.Just) {
                        return addEdge(parentId.value0)(coordId);
                    };
                    if (parentId instanceof Data_Maybe.Nothing) {
                        return pure2(Data_Unit.unit);
                    };
                    throw new Error("Failed pattern match at PSD3.Interpreter.Mermaid (line 289, column 5 - line 291, column 27): " + [ parentId.constructor.name ]);
                })())(function () {
                    return bind2(renderTree(tree.value0.child)(new Data_Maybe.Just(coordId)))(function () {
                        return pure2(coordId);
                    });
                });
            });
        };
        throw new Error("Failed pattern match at PSD3.Interpreter.Mermaid (line 121, column 28 - line 296, column 17): " + [ tree.constructor.name ]);
    };
};
var runMermaidTree = function (tree) {
    var initialState = {
        nodeCounter: 0,
        mermaidCode: ""
    };
    var v = renderTree(tree)(Data_Maybe.Nothing.value);
    return function __do() {
        var v1 = Control_Monad_State_Trans.runStateT(v)(initialState)();
        return "%%{init: {'theme':'base', 'themeVariables': {'fontFamily':'monospace'}, 'look':'handDrawn', 'flowchart':{'curve':'basis'}}}%%\x0a" + ("graph TD\x0a" + (v1.value1.mermaidCode + generateStyleDefinitions));
    };
};
export {
    MermaidTreeM,
    escapeLabel,
    addNode,
    addEdge,
    showElement,
    formatAttribute,
    formatAttributeList,
    renderTree,
    generateStyleDefinitions,
    runMermaidTree,
    functorMermaidTreeM,
    applyMermaidTreeM,
    applicativeMermaidTreeM,
    bindMermaidTreeM,
    monadMermaidTreeM
};
//# sourceMappingURL=index.js.map
