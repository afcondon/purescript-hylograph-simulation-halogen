// Generated by purs version 0.15.15
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Semigroup from "../Data.Semigroup/index.js";
import * as Data_Traversable from "../Data.Traversable/index.js";
import * as Effect from "../Effect/index.js";
import * as Effect_Ref from "../Effect.Ref/index.js";
import * as PSD3_Transition_RAF from "../PSD3.Transition.RAF/index.js";
var when = /* #__PURE__ */ Control_Applicative.when(Effect.applicativeEffect);
var for_ = /* #__PURE__ */ Data_Foldable.for_(Effect.applicativeEffect);
var for_1 = /* #__PURE__ */ for_(Data_Foldable.foldableMaybe);
var append = /* #__PURE__ */ Data_Semigroup.append(Data_Semigroup.semigroupArray);
var $$for = /* #__PURE__ */ Data_Traversable["for"](Effect.applicativeEffect)(Data_Traversable.traversableArray);
var for_2 = /* #__PURE__ */ for_(Data_Foldable.foldableArray);
var unless = /* #__PURE__ */ Control_Applicative.unless(Effect.applicativeEffect);
var StillRunning = /* #__PURE__ */ (function () {
    function StillRunning() {

    };
    StillRunning.value = new StillRunning();
    return StillRunning;
})();
var Completed = /* #__PURE__ */ (function () {
    function Completed() {

    };
    Completed.value = new Completed();
    return Completed;
})();
var Converged = /* #__PURE__ */ (function () {
    function Converged(value0) {
        this.value0 = value0;
    };
    Converged.create = function (value0) {
        return new Converged(value0);
    };
    return Converged;
})();
var ConsumerId = function (x) {
    return x;
};
var Coordinator = function (x) {
    return x;
};
var eqConsumerId = {
    eq: function (x) {
        return function (y) {
            return x === y;
        };
    }
};
var notEq = /* #__PURE__ */ Data_Eq.notEq(eqConsumerId);
var unregister = function (v) {
    return function (consumerId) {
        return Effect_Ref.modify_(function (s) {
            return {
                frameId: s.frameId,
                lastTimestamp: s.lastTimestamp,
                nextId: s.nextId,
                running: s.running,
                consumers: Data_Array.filter(function (c) {
                    return notEq(c.id)(consumerId);
                })(s.consumers)
            };
        })(v);
    };
};
var stop = function (v) {
    return function __do() {
        var state = Effect_Ref.read(v)();
        return when(state.running)(function __do() {
            for_1(state.frameId)(PSD3_Transition_RAF.cancelAnimationFrame)();
            return Effect_Ref.modify_(function (v1) {
                return {
                    consumers: v1.consumers,
                    lastTimestamp: v1.lastTimestamp,
                    nextId: v1.nextId,
                    running: false,
                    frameId: Data_Maybe.Nothing.value
                };
            })(v)();
        })();
    };
};
var register = function (v) {
    return function (spec) {
        return function __do() {
            var state = Effect_Ref.read(v)();
            var consumer = {
                id: state.nextId,
                tick: spec.tick,
                onComplete: spec.onComplete
            };
            Effect_Ref.write({
                frameId: state.frameId,
                lastTimestamp: state.lastTimestamp,
                running: state.running,
                consumers: append(state.consumers)([ consumer ]),
                nextId: state.nextId + 1 | 0
            })(v)();
            return state.nextId;
        };
    };
};
var isRunning = function (v) {
    return function __do() {
        var state = Effect_Ref.read(v)();
        return state.running;
    };
};
var isCompleted = function (v) {
    if (v instanceof Completed) {
        return true;
    };
    return false;
};
var scheduleFrame = function (v) {
    return function __do() {
        var frameId = PSD3_Transition_RAF.requestAnimationFrame(runFrame(v))();
        return Effect_Ref.modify_(function (v1) {
            return {
                consumers: v1.consumers,
                lastTimestamp: v1.lastTimestamp,
                nextId: v1.nextId,
                running: v1.running,
                frameId: new Data_Maybe.Just(frameId)
            };
        })(v)();
    };
};
var runFrame = function (v) {
    return function (timestamp) {
        return function __do() {
            var state = Effect_Ref.read(v)();
            return when(state.running)((function () {
                var deltaMs = timestamp - state.lastTimestamp;
                return function __do() {
                    Effect_Ref.modify_(function (v1) {
                        return {
                            consumers: v1.consumers,
                            frameId: v1.frameId,
                            nextId: v1.nextId,
                            running: v1.running,
                            lastTimestamp: timestamp
                        };
                    })(v)();
                    var results = $$for(state.consumers)(function (consumer) {
                        return function __do() {
                            var result = consumer.tick(deltaMs)();
                            return {
                                consumer: consumer,
                                result: result
                            };
                        };
                    })();
                    var completed = Data_Array.filter(function (r) {
                        return isCompleted(r.result);
                    })(results);
                    for_2(completed)(function (r) {
                        return function __do() {
                            r.consumer.onComplete();
                            return unregister(v)(r.consumer.id)();
                        };
                    })();
                    var newState = Effect_Ref.read(v)();
                    var $47 = Data_Array["null"](newState.consumers);
                    if ($47) {
                        return scheduleFrame(v)();
                    };
                    return scheduleFrame(v)();
                };
            })())();
        };
    };
};
var start = function (v) {
    return function __do() {
        var state = Effect_Ref.read(v)();
        return unless(state.running)(function __do() {
            var now = PSD3_Transition_RAF.performanceNow();
            Effect_Ref.modify_(function (v1) {
                return {
                    consumers: v1.consumers,
                    frameId: v1.frameId,
                    nextId: v1.nextId,
                    running: true,
                    lastTimestamp: now
                };
            })(v)();
            return scheduleFrame(v)();
        })();
    };
};
var create = function __do() {
    var ref = Effect_Ref["new"]({
        consumers: [  ],
        running: false,
        lastTimestamp: 0.0,
        nextId: 0,
        frameId: Data_Maybe.Nothing.value
    })();
    return ref;
};
export {
    create,
    start,
    stop,
    isRunning,
    StillRunning,
    Completed,
    Converged,
    register,
    unregister,
    eqConsumerId
};
//# sourceMappingURL=index.js.map
