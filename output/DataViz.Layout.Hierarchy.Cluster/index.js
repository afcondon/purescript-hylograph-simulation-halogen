// Generated by purs version 0.15.15
import * as Control_Comonad_Cofree from "../Control.Comonad.Cofree/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Int from "../Data.Int/index.js";
import * as Data_List from "../Data.List/index.js";
import * as Data_List_Types from "../Data.List.Types/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Tree from "../Data.Tree/index.js";
var compare = /* #__PURE__ */ Data_Ord.compare(Data_Ord.ordInt);
var map = /* #__PURE__ */ Data_Functor.map(Data_List_Types.functorList);
var fromFoldable = /* #__PURE__ */ Data_Array.fromFoldable(Data_List_Types.foldableList);
var fromFoldable1 = /* #__PURE__ */ Data_List.fromFoldable(Data_Foldable.foldableArray);
var fromFoldable2 = /* #__PURE__ */ Data_Array.fromFoldable(/* #__PURE__ */ Control_Comonad_Cofree.foldableCofree(Data_List_Types.foldableList));
var map1 = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var maximum = /* #__PURE__ */ Data_Foldable.maximum(Data_Ord.ordNumber)(Data_Foldable.foldableArray);
var minimum = /* #__PURE__ */ Data_Foldable.minimum(Data_Ord.ordNumber)(Data_Foldable.foldableArray);
var maximum1 = /* #__PURE__ */ Data_Foldable.maximum(Data_Ord.ordInt)(Data_Foldable.foldableArray);
var foldl = /* #__PURE__ */ Data_Foldable.foldl(Data_Foldable.foldableArray);
var sortByHeight = function (t) {
    var compareByHeight = function (t1) {
        return function (t2) {
            return compare((Control_Comonad_Cofree.head(t2)).height)((Control_Comonad_Cofree.head(t1)).height);
        };
    };
    var val = Control_Comonad_Cofree.head(t);
    var children = Control_Comonad_Cofree.tail(t);
    var sortedGrandchildren = map(sortByHeight)(children);
    var childArray = fromFoldable(sortedGrandchildren);
    var sortedArray = Data_Array.sortBy(compareByHeight)(childArray);
    var sortedChildrenList = fromFoldable1(sortedArray);
    return Data_Tree.mkTree(val)(sortedChildrenList);
};
var scaleToPixels = function (config) {
    return function (inputTree) {
        var allNodes = fromFoldable2(inputTree);
        var allX = map1(function (n) {
            return n.x;
        })(allNodes);
        var maxX = Data_Maybe.fromMaybe(1.0)(maximum(allX));
        var minX = Data_Maybe.fromMaybe(0.0)(minimum(allX));
        var xRange = (function () {
            var $30 = maxX - minX === 0.0;
            if ($30) {
                return 1.0;
            };
            return maxX - minX;
        })();
        var scaleX = function (x) {
            return ((x - minX) / xRange) * config.size.width;
        };
        var allHeights = map1(function (n) {
            return n.height;
        })(allNodes);
        var maxHeight = Data_Maybe.fromMaybe(1)(maximum1(allHeights));
        var scaleY = function (height) {
            return (1.0 - Data_Int.toNumber(height) / Data_Int.toNumber(maxHeight)) * config.size.height;
        };
        var go = function (t) {
            var val = Control_Comonad_Cofree.head(t);
            var children = Control_Comonad_Cofree.tail(t);
            return Data_Tree.mkTree((function () {
                var $31 = {};
                for (var $32 in val) {
                    if ({}.hasOwnProperty.call(val, $32)) {
                        $31[$32] = val[$32];
                    };
                };
                $31.x = scaleX(val.x);
                $31.y = scaleY(val.height);
                return $31;
            })())(map(go)(children));
        };
        return go(inputTree);
    };
};
var render = function (minSep) {
    return function (inputTree) {
        var foldl1 = function (f) {
            return function (init) {
                return function (arr) {
                    return foldl(f)(init)(arr);
                };
            };
        };
        var findExtent = function (t) {
            var val = Control_Comonad_Cofree.head(t);
            var children = Control_Comonad_Cofree.tail(t);
            var v = fromFoldable(children);
            if (v.length === 0) {
                return {
                    minX: val.x,
                    maxX: val.x
                };
            };
            var childExtents = map1(findExtent)(v);
            var maxX = Data_Maybe.fromMaybe(val.x)(maximum(map1(function (e) {
                return e.maxX;
            })(childExtents)));
            var minX = Data_Maybe.fromMaybe(val.x)(minimum(map1(function (e) {
                return e.minX;
            })(childExtents)));
            return {
                minX: minX,
                maxX: maxX
            };
        };
        var renderInternal = function (currentLeafX) {
            return function (t) {
                var val = Control_Comonad_Cofree.head(t);
                var children = Control_Comonad_Cofree.tail(t);
                var v = fromFoldable(children);
                if (v.length === 0) {
                    var leafNode = Data_Tree.mkTree((function () {
                        var $36 = {};
                        for (var $37 in val) {
                            if ({}.hasOwnProperty.call(val, $37)) {
                                $36[$37] = val[$37];
                            };
                        };
                        $36.x = currentLeafX;
                        return $36;
                    })())(Data_List_Types.Nil.value);
                    return {
                        tree: leafNode,
                        lastLeafX: currentLeafX + minSep
                    };
                };
                var processChildren = foldl1(function (acc) {
                    return function (child) {
                        var result = renderInternal(acc.lastLeafX)(child);
                        return {
                            trees: Data_Array.snoc(acc.trees)(result.tree),
                            lastLeafX: result.lastLeafX
                        };
                    };
                })({
                    trees: [  ],
                    lastLeafX: currentLeafX
                })(v);
                var childrenList = fromFoldable1(processChildren.trees);
                var allChildExtents = map1(findExtent)(processChildren.trees);
                var maxX = Data_Maybe.fromMaybe(0.0)(maximum(map1(function (e) {
                    return e.maxX;
                })(allChildExtents)));
                var minX = Data_Maybe.fromMaybe(0.0)(minimum(map1(function (e) {
                    return e.minX;
                })(allChildExtents)));
                var centerX = (minX + maxX) / 2.0;
                var internalNode = Data_Tree.mkTree((function () {
                    var $39 = {};
                    for (var $40 in val) {
                        if ({}.hasOwnProperty.call(val, $40)) {
                            $39[$40] = val[$40];
                        };
                    };
                    $39.x = centerX;
                    return $39;
                })())(childrenList);
                return {
                    tree: internalNode,
                    lastLeafX: processChildren.lastLeafX
                };
            };
        };
        return renderInternal(0.0)(inputTree);
    };
};
var defaultClusterConfig = {
    size: {
        width: 800.0,
        height: 600.0
    },
    minSeparation: 1.0
};
var centerRoot = function (tree) {
    var root = Control_Comonad_Cofree.head(tree);
    var allNodes = fromFoldable2(tree);
    var leaves = Data_Array.filter(function (n) {
        return n.height === 0;
    })(allNodes);
    var firstLeaf = Data_Array.head(leaves);
    var minX = (function () {
        if (firstLeaf instanceof Data_Maybe.Just) {
            return firstLeaf.value0.x;
        };
        if (firstLeaf instanceof Data_Maybe.Nothing) {
            return 0.0;
        };
        throw new Error("Failed pattern match at DataViz.Layout.Hierarchy.Cluster (line 92, column 12 - line 94, column 21): " + [ firstLeaf.constructor.name ]);
    })();
    var lastLeaf = Data_Array.last(leaves);
    var maxX = (function () {
        if (lastLeaf instanceof Data_Maybe.Just) {
            return lastLeaf.value0.x;
        };
        if (lastLeaf instanceof Data_Maybe.Nothing) {
            return 0.0;
        };
        throw new Error("Failed pattern match at DataViz.Layout.Hierarchy.Cluster (line 96, column 12 - line 98, column 21): " + [ lastLeaf.constructor.name ]);
    })();
    var targetX = (minX + maxX) / 2.0;
    var offset = targetX - root.x;
    var shiftTree = function (t) {
        var val = Control_Comonad_Cofree.head(t);
        var children = Control_Comonad_Cofree.tail(t);
        return Data_Tree.mkTree((function () {
            var $46 = {};
            for (var $47 in val) {
                if ({}.hasOwnProperty.call(val, $47)) {
                    $46[$47] = val[$47];
                };
            };
            $46.x = val.x + offset;
            return $46;
        })())(map(shiftTree)(children));
    };
    return shiftTree(tree);
};
var addYCoordinates = function (t) {
    var val = Control_Comonad_Cofree.head(t);
    var nodeY = Data_Int.toNumber(val.height);
    var children = Control_Comonad_Cofree.tail(t);
    var childrenWithY = map(addYCoordinates)(children);
    return Data_Tree.mkTree((function () {
        var $49 = {};
        for (var $50 in val) {
            if ({}.hasOwnProperty.call(val, $50)) {
                $49[$50] = val[$50];
            };
        };
        $49.y = nodeY;
        return $49;
    })())(childrenWithY);
};
var addHeight = function (t) {
    var val = Control_Comonad_Cofree.head(t);
    var children = Control_Comonad_Cofree.tail(t);
    var childrenWithHeight = map(addHeight)(children);
    var nodeHeight = (function () {
        var v = fromFoldable(childrenWithHeight);
        if (v.length === 0) {
            return 0;
        };
        var childHeights = map1(function (c) {
            return (Control_Comonad_Cofree.head(c)).height;
        })(v);
        var maxChildHeight = Data_Maybe.fromMaybe(0)(maximum1(childHeights));
        return 1 + maxChildHeight | 0;
    })();
    return Data_Tree.mkTree((function () {
        var $53 = {};
        for (var $54 in val) {
            if ({}.hasOwnProperty.call(val, $54)) {
                $53[$54] = val[$54];
            };
        };
        $53.height = nodeHeight;
        return $53;
    })())(childrenWithHeight);
};
var cluster = function (config) {
    return function (inputTree) {
        var withHeight = addHeight(inputTree);
        var sorted = sortByHeight(withHeight);
        var rendered = render(config.minSeparation)(sorted);
        var centered = centerRoot(rendered.tree);
        var withCoords = addYCoordinates(centered);
        var scaled = scaleToPixels(config)(withCoords);
        return scaled;
    };
};
export {
    defaultClusterConfig,
    cluster
};
//# sourceMappingURL=index.js.map
