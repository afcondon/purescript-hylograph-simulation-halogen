// Generated by purs version 0.15.15
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Effect from "../Effect/index.js";
import * as Effect_Console from "../Effect.Console/index.js";
import * as Effect_Ref from "../Effect.Ref/index.js";
import * as PSD3_ForceEngine_Setup from "../PSD3.ForceEngine.Setup/index.js";
import * as PSD3_ForceEngine_Simulation from "../PSD3.ForceEngine.Simulation/index.js";
import * as PSD3_ForceEngine_WASM from "../PSD3.ForceEngine.WASM/index.js";
var pure = /* #__PURE__ */ Control_Applicative.pure(Effect.applicativeEffect);
var eq = /* #__PURE__ */ Data_Eq.eq(PSD3_ForceEngine_Setup.eqForceType);
var for_ = /* #__PURE__ */ Data_Foldable.for_(Effect.applicativeEffect)(Data_Foldable.foldableMaybe);
var when = /* #__PURE__ */ Control_Applicative.when(Effect.applicativeEffect);
var warnIfFiltered = function (fc) {
    return function (name) {
        if (fc.filter instanceof Data_Maybe.Just) {
            return Effect_Console.warn("WASM Setup: " + (name + " filter is ignored by WASM kernel"));
        };
        if (fc.filter instanceof Data_Maybe.Nothing) {
            return pure(Data_Unit.unit);
        };
        throw new Error("Failed pattern match at PSD3.ForceEngine.Setup.WASM (line 285, column 26 - line 287, column 23): " + [ fc.filter.constructor.name ]);
    };
};
var warnIfDynamic = function (v) {
    return function (v1) {
        if (v instanceof PSD3_ForceEngine_Setup.Dynamic) {
            return Effect_Console.warn("WASM Setup: " + (v1 + " uses dynamic value, falling back to static"));
        };
        if (v instanceof PSD3_ForceEngine_Setup.Static) {
            return pure(Data_Unit.unit);
        };
        throw new Error("Failed pattern match at PSD3.ForceEngine.Setup.WASM (line 278, column 1 - line 278, column 70): " + [ v.constructor.name, v1.constructor.name ]);
    };
};
var tickN = function (n) {
    return function (sim) {
        return function __do() {
            var alpha = PSD3_ForceEngine_WASM.tickN(sim.wasmSim)(n)();
            var nodes = Effect_Ref.read(sim.nodesRef)();
            var updatedNodes = PSD3_ForceEngine_WASM.syncPositionsFromWasm(sim.wasmSim)(nodes)();
            Effect_Ref.write(updatedNodes)(sim.nodesRef)();
            return alpha;
        };
    };
};
var tick = function (sim) {
    return function __do() {
        var alpha = PSD3_ForceEngine_WASM.tick(sim.wasmSim)();
        var nodes = Effect_Ref.read(sim.nodesRef)();
        var updatedNodes = PSD3_ForceEngine_WASM.syncPositionsFromWasm(sim.wasmSim)(nodes)();
        Effect_Ref.write(updatedNodes)(sim.nodesRef)();
        return alpha;
    };
};
var reheat = function (sim) {
    return PSD3_ForceEngine_WASM.reheat(sim.wasmSim);
};
var isWasmReady = PSD3_ForceEngine_WASM.isWasmReady;
var isRunning = function (sim) {
    return PSD3_ForceEngine_WASM.isRunning(sim.wasmSim);
};
var initWasm = PSD3_ForceEngine_WASM.initWasm;
var getNodes = function (sim) {
    return function __do() {
        var nodes = Effect_Ref.read(sim.nodesRef)();
        return PSD3_ForceEngine_WASM.syncPositionsFromWasm(sim.wasmSim)(nodes)();
    };
};
var getAlpha = function (sim) {
    return PSD3_ForceEngine_WASM.getAlpha(sim.wasmSim);
};
var free = function (sim) {
    return PSD3_ForceEngine_WASM.free(sim.wasmSim);
};
var createEmpty = function __do() {
    var wasmSim = PSD3_ForceEngine_WASM.create(0)();
    var nodesRef = Effect_Ref["new"]([  ])();
    var linksRef = Effect_Ref["new"]([  ])();
    return {
        wasmSim: wasmSim,
        nodesRef: nodesRef,
        linksRef: linksRef
    };
};
var create = function (nodes) {
    return function (links) {
        return function __do() {
            var wasmSim = PSD3_ForceEngine_WASM.create(Data_Array.length(nodes))();
            PSD3_ForceEngine_WASM.syncPositionsToWasm(wasmSim)(nodes)();
            PSD3_ForceEngine_WASM.setLinksFromRecords(wasmSim)(links)();
            var nodesRef = Effect_Ref["new"](nodes)();
            var linksRef = Effect_Ref["new"](links)();
            return {
                wasmSim: wasmSim,
                nodesRef: nodesRef,
                linksRef: linksRef
            };
        };
    };
};
var configureManyBody = function (wasmSim) {
    return function (fc) {
        return function __do() {
            warnIfDynamic(fc.strength)("ManyBody strength")();
            warnIfFiltered(fc)("ManyBody")();
            return PSD3_ForceEngine_WASM.configureManyBody(wasmSim)({
                strength: PSD3_ForceEngine_Setup.valueToNumber(fc.strength),
                theta: fc.theta,
                distanceMin: fc.distanceMin,
                distanceMax: fc.distanceMax
            })();
        };
    };
};
var configureLinks = function (wasmSim) {
    return function (fc) {
        return function __do() {
            warnIfDynamic(fc.distance)("Link distance")();
            warnIfDynamic(fc.strength)("Link strength")();
            return PSD3_ForceEngine_WASM.configureLinks(wasmSim)({
                distance: PSD3_ForceEngine_Setup.valueToNumber(fc.distance),
                strength: PSD3_ForceEngine_Setup.valueToNumber(fc.strength),
                iterations: fc.iterations
            })();
        };
    };
};
var configureForceY = function (_wasmSim) {
    return function (fc) {
        return function __do() {
            warnIfDynamic(fc.y)("ForceY target")();
            warnIfDynamic(fc.strength)("ForceY strength")();
            return Data_Unit.unit;
        };
    };
};
var configureForceX = function (_wasmSim) {
    return function (fc) {
        return function __do() {
            warnIfDynamic(fc.x)("ForceX target")();
            warnIfDynamic(fc.strength)("ForceX strength")();
            return Data_Unit.unit;
        };
    };
};
var configureCollide = function (_wasmSim) {
    return function (fc) {
        return function __do() {
            warnIfDynamic(fc.radius)("Collide radius")();
            warnIfDynamic(fc.strength)("Collide strength")();
            return Effect_Console.warn("WASM Setup: Collide force not yet implemented in FFI")();
        };
    };
};
var configureCenter = function (wasmSim) {
    return function (fc) {
        return function __do() {
            warnIfDynamic(fc.x)("Center x")();
            warnIfDynamic(fc.y)("Center y")();
            warnIfDynamic(fc.strength)("Center strength")();
            return PSD3_ForceEngine_WASM.configureCenter(wasmSim)({
                x: PSD3_ForceEngine_Setup.valueToNumber(fc.x),
                y: PSD3_ForceEngine_Setup.valueToNumber(fc.y),
                strength: PSD3_ForceEngine_Setup.valueToNumber(fc.strength)
            })();
        };
    };
};
var applySetup = function (setupConfig) {
    return function (sim) {
        var forces = PSD3_ForceEngine_Setup.getForces(setupConfig);
        var manyBodyForce = Data_Array.find(function (f) {
            return eq(f.forceType)(PSD3_ForceEngine_Setup.ForceManyBody.value);
        })(forces);
        var collideForce = Data_Array.find(function (f) {
            return eq(f.forceType)(PSD3_ForceEngine_Setup.ForceCollide.value);
        })(forces);
        var linkForce = Data_Array.find(function (f) {
            return eq(f.forceType)(PSD3_ForceEngine_Setup.ForceLink.value);
        })(forces);
        var centerForce = Data_Array.find(function (f) {
            return eq(f.forceType)(PSD3_ForceEngine_Setup.ForceCenter.value);
        })(forces);
        var posXForce = Data_Array.find(function (f) {
            return eq(f.forceType)(PSD3_ForceEngine_Setup.ForcePositionX.value);
        })(forces);
        var posYForce = Data_Array.find(function (f) {
            return eq(f.forceType)(PSD3_ForceEngine_Setup.ForcePositionY.value);
        })(forces);
        var radialForce = Data_Array.find(function (f) {
            return eq(f.forceType)(PSD3_ForceEngine_Setup.ForceRadial.value);
        })(forces);
        return function __do() {
            for_(radialForce)(function (v) {
                return Effect_Console.warn("WASM Setup: ForceRadial is not supported by WASM kernel");
            })();
            for_(manyBodyForce)(configureManyBody(sim.wasmSim))();
            for_(collideForce)(configureCollide(sim.wasmSim))();
            for_(linkForce)(configureLinks(sim.wasmSim))();
            for_(centerForce)(configureCenter(sim.wasmSim))();
            for_(posXForce)(configureForceX(sim.wasmSim))();
            for_(posYForce)(configureForceY(sim.wasmSim))();
            PSD3_ForceEngine_WASM.enableForces(sim.wasmSim)({
                manyBody: Data_Array.any(function (f) {
                    return eq(f.forceType)(PSD3_ForceEngine_Setup.ForceManyBody.value);
                })(forces),
                links: Data_Array.any(function (f) {
                    return eq(f.forceType)(PSD3_ForceEngine_Setup.ForceLink.value);
                })(forces),
                center: Data_Array.any(function (f) {
                    return eq(f.forceType)(PSD3_ForceEngine_Setup.ForceCenter.value);
                })(forces)
            })();
            var params = PSD3_ForceEngine_Setup.getParams(setupConfig);
            PSD3_ForceEngine_WASM.setAlpha(sim.wasmSim)(params.alpha)();
            PSD3_ForceEngine_WASM.setAlphaDecay(sim.wasmSim)(params.alphaDecay)();
            return PSD3_ForceEngine_WASM.setVelocityDecay(sim.wasmSim)(params.velocityDecay)();
        };
    };
};
var applySetupWithData = function (setupConfig) {
    return function (desiredNodes) {
        return function (desiredLinks) {
            return function (sim) {
                return function __do() {
                    var currentNodes = Effect_Ref.read(sim.nodesRef)();
                    var currentLinks = Effect_Ref.read(sim.linksRef)();
                    var nodeResult = PSD3_ForceEngine_Setup.computeNodeGUP(currentNodes)(desiredNodes);
                    Effect_Ref.write(nodeResult.merged)(sim.nodesRef)();
                    var currentCount = Data_Array.length(currentNodes);
                    var newCount = Data_Array.length(nodeResult.merged);
                    when(currentCount !== newCount)(PSD3_ForceEngine_WASM.setNodeCount(sim.wasmSim)(newCount))();
                    PSD3_ForceEngine_WASM.syncPositionsToWasm(sim.wasmSim)(nodeResult.merged)();
                    var linkResult = PSD3_ForceEngine_Setup.computeLinkGUP(currentLinks)(desiredLinks);
                    Effect_Ref.write(desiredLinks)(sim.linksRef)();
                    PSD3_ForceEngine_WASM.setLinksFromRecords(sim.wasmSim)(desiredLinks)();
                    applySetup(setupConfig)(sim)();
                    return {
                        nodes: {
                            entered: nodeResult.entered,
                            updated: nodeResult.updated,
                            exited: nodeResult.exited
                        },
                        links: {
                            entered: linkResult.entered,
                            updated: linkResult.updated,
                            exited: linkResult.exited
                        }
                    };
                };
            };
        };
    };
};
export {
    initWasm,
    isWasmReady,
    create,
    createEmpty,
    free,
    applySetup,
    applySetupWithData,
    tick,
    tickN,
    getNodes,
    getAlpha,
    reheat,
    isRunning
};
export {
    ForceCenter,
    ForceCollide,
    ForceLink,
    ForceManyBody,
    ForcePositionX,
    ForcePositionY,
    ForceRadial,
    Dynamic,
    Static,
    computeLinkGUP,
    computeNodeGUP,
    getForces,
    getParams,
    valueToNumber
} from "../PSD3.ForceEngine.Setup/index.js";
//# sourceMappingURL=index.js.map
