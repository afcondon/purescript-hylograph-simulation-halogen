// Generated by purs version 0.15.15
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Map_Internal from "../Data.Map.Internal/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Semigroup from "../Data.Semigroup/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as Data_Tuple from "../Data.Tuple/index.js";
var show = /* #__PURE__ */ Data_Show.show(Data_Show.showInt);
var map = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var foldl = /* #__PURE__ */ Data_Foldable.foldl(Data_Foldable.foldableArray);
var lookup = /* #__PURE__ */ Data_Map_Internal.lookup(Data_Ord.ordString);
var insert = /* #__PURE__ */ Data_Map_Internal.insert(Data_Ord.ordString);
var append1 = /* #__PURE__ */ Data_Semigroup.append(Data_Semigroup.semigroupArray);
var fromFoldable = /* #__PURE__ */ Data_Map_Internal.fromFoldable(Data_Ord.ordString)(Data_Foldable.foldableArray);
var Link = function (x) {
    return x;
};
var BilinkedNode = /* #__PURE__ */ (function () {
    function BilinkedNode(value0) {
        this.value0 = value0;
    };
    BilinkedNode.create = function (value0) {
        return new BilinkedNode(value0);
    };
    return BilinkedNode;
})();
var showLink = {
    show: function (v) {
        return v.source + (" -> " + v.target);
    }
};
var showBilinkedNode = function (dictShow) {
    return {
        show: function (v) {
            return "BilinkedNode { fullName: " + (v.value0.fullName + (", outgoing: " + (show(Data_Array.length(v.value0.outgoing)) + (", incoming: " + (show(Data_Array.length(v.value0.incoming)) + " }")))));
        }
    };
};
var nodeToLinks = function (getImports) {
    return function (v) {
        if (v.value0.data_ instanceof Data_Maybe.Nothing) {
            return [  ];
        };
        if (v.value0.data_ instanceof Data_Maybe.Just) {
            var imports = getImports(v.value0.data_.value0);
            return map(function (target) {
                return {
                    source: v.value0.fullName,
                    target: target
                };
            })(imports);
        };
        throw new Error("Failed pattern match at DataViz.Layout.Hierarchy.EdgeBundle.Bilink (line 175, column 3 - line 181, column 69): " + [ v.value0.data_.constructor.name ]);
    };
};
var getOutgoing = function (v) {
    return v.value0.outgoing;
};
var getIncoming = function (v) {
    return v.value0.incoming;
};
var getBilinkedFullName = function (v) {
    return v.value0.fullName;
};
var getBilinkedData = function (v) {
    return v.value0.data_;
};
var getBilinkedChildren = function (v) {
    return v.value0.children;
};
var eqLink = {
    eq: function (x) {
        return function (y) {
            return x.source === y.source && x.target === y.target;
        };
    }
};
var convertToBilinked = function (v) {
    return new BilinkedNode({
        name: v.value0.name,
        fullName: v.value0.fullName,
        children: map(convertToBilinked)(v.value0.children),
        data_: v.value0.data_,
        depth: v.value0.depth,
        height: v.value0.height,
        outgoing: [  ],
        incoming: [  ]
    });
};
var collectLinks = function (getImports) {
    return function (leafNodes) {
        return Data_Array.concatMap(nodeToLinks(getImports))(leafNodes);
    };
};
var buildLinkMap = function (getKey) {
    return function (links) {
        return foldl(function (acc) {
            return function (link) {
                var key = getKey(link);
                var existing = Data_Maybe.fromMaybe([  ])(lookup(key)(acc));
                return insert(key)(Data_Array.snoc(existing)(link))(acc);
            };
        })(Data_Map_Internal.empty)(links);
    };
};
var applyLinks = function (outgoingMap) {
    return function (incomingMap) {
        return function (v) {
            var outgoing = Data_Maybe.fromMaybe([  ])(lookup(v.value0.fullName)(outgoingMap));
            var incoming = Data_Maybe.fromMaybe([  ])(lookup(v.value0.fullName)(incomingMap));
            var childrenWithLinks = map(applyLinks(outgoingMap)(incomingMap))(v.value0.children);
            return new BilinkedNode({
                name: v.value0.name,
                fullName: v.value0.fullName,
                data_: v.value0.data_,
                depth: v.value0.depth,
                height: v.value0.height,
                outgoing: outgoing,
                incoming: incoming,
                children: childrenWithLinks
            });
        };
    };
};
var allBilinkedNodes = function (v) {
    return append1([ v ])(Data_Array.concatMap(allBilinkedNodes)(v.value0.children));
};
var getLinks = function (root) {
    var allNodes = allBilinkedNodes(root);
    return Data_Array.concatMap(getOutgoing)(allNodes);
};
var allBilinkedLeaves = function (v) {
    var $60 = Data_Array["null"](v.value0.children);
    if ($60) {
        return [ v ];
    };
    return Data_Array.concatMap(allBilinkedLeaves)(v.value0.children);
};
var bilink = function (getImports) {
    return function (tree) {
        var initialBilinked = convertToBilinked(tree);
        var leafNodes = allBilinkedLeaves(initialBilinked);
        var nameMap = fromFoldable(map(function (n) {
            return new Data_Tuple.Tuple(getBilinkedFullName(n), n);
        })(leafNodes));
        var allLinks = collectLinks(getImports)(leafNodes);
        var incomingMap = buildLinkMap(function (v) {
            return v.target;
        })(allLinks);
        var outgoingMap = buildLinkMap(function (v) {
            return v.source;
        })(allLinks);
        var withLinks = applyLinks(outgoingMap)(incomingMap)(initialBilinked);
        return withLinks;
    };
};
export {
    BilinkedNode,
    Link,
    bilink,
    getLinks,
    getOutgoing,
    getIncoming,
    getBilinkedData,
    getBilinkedChildren,
    getBilinkedFullName,
    allBilinkedNodes,
    allBilinkedLeaves,
    eqLink,
    showLink,
    showBilinkedNode
};
//# sourceMappingURL=index.js.map
