// Generated by purs version 0.15.15
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Effect from "../Effect/index.js";
import * as Effect_Ref from "../Effect.Ref/index.js";
import * as PSD3_Scene_Types from "../PSD3.Scene.Types/index.js";
import * as PSD3_Transition_Tick from "../PSD3.Transition.Tick/index.js";
var pure = /* #__PURE__ */ Control_Applicative.pure(Effect.applicativeEffect);
var map = /* #__PURE__ */ Data_Functor.map(Data_Maybe.functorMaybe);
var min = /* #__PURE__ */ Data_Ord.min(Data_Ord.ordNumber);
var transitionTo = function (targetScene) {
    return function (engineRef) {
        return function __do() {
            var state = Effect_Ref.read(engineRef)();
            if (state.transition instanceof Data_Maybe.Just) {
                return Data_Unit.unit;
            };
            if (state.transition instanceof Data_Maybe.Nothing) {
                state.adapter.applyRulesInPlace(targetScene.initRules)();
                var nodesAfterInit = state.adapter.getNodes();
                var startPositions = state.adapter.capturePositions(nodesAfterInit);
                var targetPositions = targetScene.layout(nodesAfterInit);
                Effect_Ref.write({
                    adapter: state.adapter,
                    currentScene: state.currentScene,
                    transitionDelta: state.transitionDelta,
                    transition: new Data_Maybe.Just({
                        targetScene: targetScene,
                        startPositions: startPositions,
                        targetPositions: targetPositions,
                        progress: 0.0
                    })
                })(engineRef)();
                return state.adapter.reheat();
            };
            throw new Error("Failed pattern match at PSD3.Scene.Engine (line 182, column 3 - line 209, column 27): " + [ state.transition.constructor.name ]);
        };
    };
};
var setCurrentScene = function (scene) {
    return function (engineRef) {
        return Effect_Ref.modify_(function (v) {
            return {
                adapter: v.adapter,
                transition: v.transition,
                transitionDelta: v.transitionDelta,
                currentScene: new Data_Maybe.Just(scene)
            };
        })(engineRef);
    };
};
var runStableEngine = function (_state) {
    return pure(Data_Unit.unit);
};
var isTransitioning = function (engineRef) {
    return function __do() {
        var state = Effect_Ref.read(engineRef)();
        return Data_Maybe.isJust(state.transition);
    };
};
var getTransitionProgress = function (engineRef) {
    return function __do() {
        var state = Effect_Ref.read(engineRef)();
        return map(function (v) {
            return v.progress;
        })(state.transition);
    };
};
var getCurrentScene = function (engineRef) {
    return function __do() {
        var state = Effect_Ref.read(engineRef)();
        return state.currentScene;
    };
};
var defaultTransitionDelta = /* #__PURE__ */ PSD3_Transition_Tick.ticksForDuration(2000);
var createEngine = function (adapter) {
    return Effect_Ref["new"]({
        adapter: adapter,
        currentScene: Data_Maybe.Nothing.value,
        transition: Data_Maybe.Nothing.value,
        transitionDelta: defaultTransitionDelta
    });
};
var completeTransition = function (t) {
    return function (engineRef) {
        return function (state) {
            return function __do() {
                state.adapter.updatePositions(t.targetPositions)();
                var nodes = state.adapter.getNodes();
                var rules = t.targetScene.finalRules(nodes);
                state.adapter.applyRulesInPlace(rules)();
                state.adapter.reinitializeForces();
                (function () {
                    if (t.targetScene.stableMode instanceof PSD3_Scene_Types.Physics) {
                        return state.adapter.reheat();
                    };
                    if (t.targetScene.stableMode instanceof PSD3_Scene_Types.Static) {
                        return Data_Unit.unit;
                    };
                    throw new Error("Failed pattern match at PSD3.Scene.Engine (line 280, column 3 - line 282, column 30): " + [ t.targetScene.stableMode.constructor.name ]);
                })();
                return Effect_Ref.write({
                    adapter: state.adapter,
                    transitionDelta: state.transitionDelta,
                    currentScene: new Data_Maybe.Just(t.targetScene),
                    transition: Data_Maybe.Nothing.value
                })(engineRef)();
            };
        };
    };
};
var runInterpolationEngine = function (t) {
    return function (engineRef) {
        return function (state) {
            var newProgress = min(1.0)(t.progress + state.transitionDelta);
            var $17 = newProgress >= 1.0;
            if ($17) {
                return completeTransition(t)(engineRef)(state);
            };
            var easedProgress = PSD3_Transition_Tick.easeInOutCubic(newProgress);
            return function __do() {
                state.adapter.interpolatePositions(t.startPositions)(t.targetPositions)(easedProgress)();
                return Effect_Ref.write({
                    adapter: state.adapter,
                    currentScene: state.currentScene,
                    transitionDelta: state.transitionDelta,
                    transition: new Data_Maybe.Just({
                        startPositions: t.startPositions,
                        targetPositions: t.targetPositions,
                        targetScene: t.targetScene,
                        progress: newProgress
                    })
                })(engineRef)();
            };
        };
    };
};
var tick = function (engineRef) {
    return function __do() {
        var state = Effect_Ref.read(engineRef)();
        if (state.transition instanceof Data_Maybe.Just) {
            runInterpolationEngine(state.transition.value0)(engineRef)(state)();
            return true;
        };
        if (state.transition instanceof Data_Maybe.Nothing) {
            runStableEngine(state)();
            return false;
        };
        throw new Error("Failed pattern match at PSD3.Scene.Engine (line 223, column 3 - line 230, column 17): " + [ state.transition.constructor.name ]);
    };
};
export {
    createEngine,
    transitionTo,
    tick,
    getCurrentScene,
    isTransitioning,
    getTransitionProgress,
    setCurrentScene,
    defaultTransitionDelta
};
export {
    Physics,
    Static
} from "../PSD3.Scene.Types/index.js";
//# sourceMappingURL=index.js.map
