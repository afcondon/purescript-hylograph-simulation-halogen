// Generated by purs version 0.15.15
import * as $foreign from "./foreign.js";
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Map_Internal from "../Data.Map.Internal/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Semigroup from "../Data.Semigroup/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as Data_Tuple from "../Data.Tuple/index.js";
import * as Data_Unfoldable from "../Data.Unfoldable/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Effect from "../Effect/index.js";
import * as Effect_Ref from "../Effect.Ref/index.js";
import * as PSD3_Internal_Attribute from "../PSD3.Internal.Attribute/index.js";
import * as PSD3_Transition_Coordinator from "../PSD3.Transition.Coordinator/index.js";
var show = /* #__PURE__ */ Data_Show.show(Data_Show.showInt);
var compare = /* #__PURE__ */ Data_Ord.compare(Data_Ord.ordInt);
var lookup = /* #__PURE__ */ Data_Map_Internal.lookup(Data_Ord.ordString);
var pure = /* #__PURE__ */ Control_Applicative.pure(Effect.applicativeEffect);
var insert = /* #__PURE__ */ Data_Map_Internal.insert(Data_Ord.ordString);
var ordRecord = /* #__PURE__ */ Data_Ord.ordRecord()(/* #__PURE__ */ Data_Ord.ordRecordCons(/* #__PURE__ */ Data_Ord.ordRecordCons(Data_Ord.ordRecordNil)()({
    reflectSymbol: function () {
        return "elementId";
    }
})(Data_Ord.ordString))()({
    reflectSymbol: function () {
        return "attrName";
    }
})(Data_Ord.ordString));
var insert1 = /* #__PURE__ */ Data_Map_Internal.insert(ordRecord);
var map = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var toUnfoldable = /* #__PURE__ */ Data_Map_Internal.toUnfoldable(Data_Unfoldable.unfoldableArray);
var for_ = /* #__PURE__ */ Data_Foldable.for_(Effect.applicativeEffect)(Data_Foldable.foldableArray);
var max = /* #__PURE__ */ Data_Ord.max(Data_Ord.ordNumber);
var min = /* #__PURE__ */ Data_Ord.min(Data_Ord.ordNumber);
var show1 = /* #__PURE__ */ Data_Show.show(Data_Show.showNumber);
var append1 = /* #__PURE__ */ Data_Semigroup.append(Data_Semigroup.semigroupArray);
var $$delete = /* #__PURE__ */ Data_Map_Internal["delete"](ordRecord);
var update = /* #__PURE__ */ Data_Map_Internal.update(ordRecord);
var TransitionId = function (x) {
    return x;
};
var SingleTransition = /* #__PURE__ */ (function () {
    function SingleTransition(value0) {
        this.value0 = value0;
    };
    SingleTransition.create = function (value0) {
        return new SingleTransition(value0);
    };
    return SingleTransition;
})();
var CompoundTransition = /* #__PURE__ */ (function () {
    function CompoundTransition(value0) {
        this.value0 = value0;
    };
    CompoundTransition.create = function (value0) {
        return new CompoundTransition(value0);
    };
    return CompoundTransition;
})();
var ElementTransitionManager = function (x) {
    return x;
};
var showTransitionId = {
    show: function (v) {
        return "TransitionId(" + (show(v) + ")");
    }
};
var eqTransitionId = {
    eq: function (x) {
        return function (y) {
            return x === y;
        };
    }
};
var ordTransitionId = {
    compare: function (x) {
        return function (y) {
            return compare(x)(y);
        };
    },
    Eq0: function () {
        return eqTransitionId;
    }
};
var registerTransitionInternal = function (v) {
    return function (element) {
        return function (attrName) {
            return function (transitionType) {
                return function (onComplete) {
                    return function __do() {
                        var state = Effect_Ref.read(v)();
                        var elemRef = $foreign.unsafeElementRef(element);
                        var v1 = (function () {
                            var v1 = lookup(elemRef)(state.elementIds);
                            if (v1 instanceof Data_Maybe.Just) {
                                return new Data_Tuple.Tuple(v1.value0, state);
                            };
                            if (v1 instanceof Data_Maybe.Nothing) {
                                var eid = "elem-" + show(state.nextElementId);
                                var newIds = insert(elemRef)(eid)(state.elementIds);
                                return new Data_Tuple.Tuple(eid, {
                                    nextId: state.nextId,
                                    transitions: state.transitions,
                                    elementIds: newIds,
                                    nextElementId: state.nextElementId + 1 | 0
                                });
                            };
                            throw new Error("Failed pattern match at PSD3.Internal.Transition.Manager (line 194, column 31 - line 199, column 96): " + [ v1.constructor.name ]);
                        })();
                        var key = {
                            elementId: v1.value0,
                            attrName: attrName
                        };
                        var transition = {
                            id: v1.value1.nextId,
                            element: element,
                            attrName: attrName,
                            transitionType: transitionType,
                            elapsed: 0.0,
                            onComplete: onComplete
                        };
                        var newTransitions = insert1(key)(transition)(v1.value1.transitions);
                        Effect_Ref.write({
                            elementIds: v1.value1.elementIds,
                            nextElementId: v1.value1.nextElementId,
                            transitions: newTransitions,
                            nextId: v1.value1.nextId + 1 | 0
                        })(v)();
                        return v1.value1.nextId;
                    };
                };
            };
        };
    };
};
var registerTransitionWithCallback = function (manager) {
    return function (element) {
        return function (attrName) {
            return function (spec) {
                return function (onComplete) {
                    return registerTransitionInternal(manager)(element)(attrName)(new SingleTransition(spec))(onComplete);
                };
            };
        };
    };
};
var registerTransition = function (manager) {
    return function (element) {
        return function (attrName) {
            return function (spec) {
                return registerTransitionWithCallback(manager)(element)(attrName)(spec)(pure(Data_Unit.unit));
            };
        };
    };
};
var pi = 3.141592653589793;
var lerp = function (from) {
    return function (to) {
        return function (t) {
            return from + (to - from) * t;
        };
    };
};
var evalAnimatedValue = function (v) {
    return function (v1) {
        return function (v2) {
            if (v instanceof PSD3_Internal_Attribute.StaticAnimValue) {
                return v.value0;
            };
            if (v instanceof PSD3_Internal_Attribute.DataAnimValue) {
                return v.value0(v1);
            };
            if (v instanceof PSD3_Internal_Attribute.IndexedAnimValue) {
                return v.value0(v1)(v2);
            };
            throw new Error("Failed pattern match at PSD3.Internal.Transition.Manager (line 296, column 1 - line 296, column 81): " + [ v.constructor.name, v1.constructor.name, v2.constructor.name ]);
        };
    };
};
var registerAnimatedAttr = function (manager) {
    return function (element) {
        return function (datum) {
            return function (index) {
                return function (attrName) {
                    return function (maybeFrom) {
                        return function (toValue) {
                            return function (config) {
                                return function (onComplete) {
                                    var to = evalAnimatedValue(toValue)(datum)(index);
                                    return function __do() {
                                        var from = (function () {
                                            if (maybeFrom instanceof Data_Maybe.Just) {
                                                return evalAnimatedValue(maybeFrom.value0)(datum)(index);
                                            };
                                            if (maybeFrom instanceof Data_Maybe.Nothing) {
                                                return $foreign.readAttributeNumber(element)(attrName)();
                                            };
                                            throw new Error("Failed pattern match at PSD3.Internal.Transition.Manager (line 245, column 11 - line 247, column 52): " + [ maybeFrom.constructor.name ]);
                                        })();
                                        var spec = {
                                            from: from,
                                            to: to,
                                            duration: config.duration,
                                            easing: config.easing,
                                            delay: config.delay
                                        };
                                        return registerTransitionWithCallback(manager)(element)(attrName)(spec)(onComplete)();
                                    };
                                };
                            };
                        };
                    };
                };
            };
        };
    };
};
var registerAnimatedCompound = function (manager) {
    return function (element) {
        return function (datum) {
            return function (index) {
                return function (attrName) {
                    return function (fromValues) {
                        return function (toValues) {
                            return function (generator) {
                                return function (config) {
                                    return function (onComplete) {
                                        var evaluatedFroms = map(function (av) {
                                            return evalAnimatedValue(av)(datum)(index);
                                        })(fromValues);
                                        var evaluatedTos = map(function (av) {
                                            return evalAnimatedValue(av)(datum)(index);
                                        })(toValues);
                                        var compoundSpec = {
                                            fromValues: evaluatedFroms,
                                            toValues: evaluatedTos,
                                            generator: generator,
                                            duration: config.duration,
                                            easing: config.easing,
                                            delay: config.delay
                                        };
                                        return registerTransitionInternal(manager)(element)(attrName)(new CompoundTransition(compoundSpec))(onComplete);
                                    };
                                };
                            };
                        };
                    };
                };
            };
        };
    };
};
var create = function __do() {
    var ref = Effect_Ref["new"]({
        transitions: Data_Map_Internal.empty,
        nextId: 0,
        elementIds: Data_Map_Internal.empty,
        nextElementId: 0
    })();
    return ref;
};
var clear = function (v) {
    return Effect_Ref.modify_(function (v1) {
        return {
            elementIds: v1.elementIds,
            nextElementId: v1.nextElementId,
            nextId: v1.nextId,
            transitions: Data_Map_Internal.empty
        };
    })(v);
};
var bounceOut = function (t) {
    var $97 = t < 1.0 / 2.75;
    if ($97) {
        return 7.5625 * t * t;
    };
    var $98 = t < 2.0 / 2.75;
    if ($98) {
        var t$prime = t - 1.5 / 2.75;
        return 7.5625 * t$prime * t$prime + 0.75;
    };
    var $99 = t < 2.5 / 2.75;
    if ($99) {
        var t$prime = t - 2.25 / 2.75;
        return 7.5625 * t$prime * t$prime + 0.9375;
    };
    var t$prime = t - 2.625 / 2.75;
    return 7.5625 * t$prime * t$prime + 0.984375;
};
var applyEasing = function (v) {
    return function (v1) {
        if (v instanceof PSD3_Internal_Attribute.Linear) {
            return v1;
        };
        if (v instanceof PSD3_Internal_Attribute.QuadIn) {
            return v1 * v1;
        };
        if (v instanceof PSD3_Internal_Attribute.QuadOut) {
            return v1 * (2.0 - v1);
        };
        if (v instanceof PSD3_Internal_Attribute.QuadInOut) {
            var $102 = v1 < 0.5;
            if ($102) {
                return 2.0 * v1 * v1;
            };
            return -1.0 + (4.0 - 2.0 * v1) * v1;
        };
        if (v instanceof PSD3_Internal_Attribute.CubicIn) {
            return v1 * v1 * v1;
        };
        if (v instanceof PSD3_Internal_Attribute.CubicOut) {
            var t$prime = v1 - 1.0;
            return t$prime * t$prime * t$prime + 1.0;
        };
        if (v instanceof PSD3_Internal_Attribute.CubicInOut) {
            var $103 = v1 < 0.5;
            if ($103) {
                return 4.0 * v1 * v1 * v1;
            };
            return (v1 - 1.0) * (2.0 * v1 - 2.0) * (2.0 * v1 - 2.0) + 1.0;
        };
        if (v instanceof PSD3_Internal_Attribute.SinIn) {
            return 1.0 - $foreign.cos((v1 * pi) / 2.0);
        };
        if (v instanceof PSD3_Internal_Attribute.SinOut) {
            return $foreign.sin((v1 * pi) / 2.0);
        };
        if (v instanceof PSD3_Internal_Attribute.SinInOut) {
            return -($foreign.cos(pi * v1) - 1.0) / 2.0;
        };
        if (v instanceof PSD3_Internal_Attribute.ExpIn) {
            var $104 = v1 === 0.0;
            if ($104) {
                return 0.0;
            };
            return $foreign.pow(2.0)(10.0 * (v1 - 1.0));
        };
        if (v instanceof PSD3_Internal_Attribute.ExpOut) {
            var $105 = v1 === 1.0;
            if ($105) {
                return 1.0;
            };
            return 1.0 - $foreign.pow(2.0)(-10.0 * v1);
        };
        if (v instanceof PSD3_Internal_Attribute.ExpInOut) {
            var $106 = v1 === 0.0;
            if ($106) {
                return 0.0;
            };
            var $107 = v1 === 1.0;
            if ($107) {
                return 1.0;
            };
            var $108 = v1 < 0.5;
            if ($108) {
                return $foreign.pow(2.0)(20.0 * v1 - 10.0) / 2.0;
            };
            return (2.0 - $foreign.pow(2.0)(-20.0 * v1 + 10.0)) / 2.0;
        };
        if (v instanceof PSD3_Internal_Attribute.CircleIn) {
            return 1.0 - $foreign.sqrt(1.0 - v1 * v1);
        };
        if (v instanceof PSD3_Internal_Attribute.CircleOut) {
            return $foreign.sqrt(1.0 - $foreign.pow(v1 - 1.0)(2.0));
        };
        if (v instanceof PSD3_Internal_Attribute.CircleInOut) {
            var $109 = v1 < 0.5;
            if ($109) {
                return (1.0 - $foreign.sqrt(1.0 - $foreign.pow(2.0 * v1)(2.0))) / 2.0;
            };
            return ($foreign.sqrt(1.0 - $foreign.pow(-2.0 * v1 + 2.0)(2.0)) + 1.0) / 2.0;
        };
        if (v instanceof PSD3_Internal_Attribute.BackIn) {
            var c3 = 1.70158 + 1.0;
            return c3 * v1 * v1 * v1 - 1.70158 * v1 * v1;
        };
        if (v instanceof PSD3_Internal_Attribute.BackOut) {
            var t$prime = v1 - 1.0;
            var c3 = 1.70158 + 1.0;
            return 1.0 + c3 * t$prime * t$prime * t$prime + 1.70158 * t$prime * t$prime;
        };
        if (v instanceof PSD3_Internal_Attribute.BackInOut) {
            var c2 = 1.70158 * 1.525;
            var $110 = v1 < 0.5;
            if ($110) {
                return ($foreign.pow(2.0 * v1)(2.0) * ((c2 + 1.0) * 2.0 * v1 - c2)) / 2.0;
            };
            return ($foreign.pow(2.0 * v1 - 2.0)(2.0) * ((c2 + 1.0) * (v1 * 2.0 - 2.0) + c2) + 2.0) / 2.0;
        };
        if (v instanceof PSD3_Internal_Attribute.ElasticIn) {
            var $111 = v1 === 0.0;
            if ($111) {
                return 0.0;
            };
            var $112 = v1 === 1.0;
            if ($112) {
                return 1.0;
            };
            var c4 = (2.0 * pi) / 3.0;
            return -$foreign.pow(2.0)(10.0 * v1 - 10.0) * $foreign.sin((v1 * 10.0 - 10.75) * c4);
        };
        if (v instanceof PSD3_Internal_Attribute.ElasticOut) {
            var $113 = v1 === 0.0;
            if ($113) {
                return 0.0;
            };
            var $114 = v1 === 1.0;
            if ($114) {
                return 1.0;
            };
            var c4 = (2.0 * pi) / 3.0;
            return $foreign.pow(2.0)(-10.0 * v1) * $foreign.sin((v1 * 10.0 - 0.75) * c4) + 1.0;
        };
        if (v instanceof PSD3_Internal_Attribute.ElasticInOut) {
            var $115 = v1 === 0.0;
            if ($115) {
                return 0.0;
            };
            var $116 = v1 === 1.0;
            if ($116) {
                return 1.0;
            };
            var c5 = (2.0 * pi) / 4.5;
            var $117 = v1 < 0.5;
            if ($117) {
                return -($foreign.pow(2.0)(20.0 * v1 - 10.0) * $foreign.sin((20.0 * v1 - 11.125) * c5)) / 2.0;
            };
            return ($foreign.pow(2.0)(-20.0 * v1 + 10.0) * $foreign.sin((20.0 * v1 - 11.125) * c5)) / 2.0 + 1.0;
        };
        if (v instanceof PSD3_Internal_Attribute.BounceIn) {
            return 1.0 - bounceOut(1.0 - v1);
        };
        if (v instanceof PSD3_Internal_Attribute.BounceOut) {
            return bounceOut(v1);
        };
        if (v instanceof PSD3_Internal_Attribute.BounceInOut) {
            var $118 = v1 < 0.5;
            if ($118) {
                return (1.0 - bounceOut(1.0 - 2.0 * v1)) / 2.0;
            };
            return (1.0 + bounceOut(2.0 * v1 - 1.0)) / 2.0;
        };
        throw new Error("Failed pattern match at PSD3.Internal.Transition.Manager (line 395, column 1 - line 395, column 46): " + [ v.constructor.name, v1.constructor.name ]);
    };
};
var tick = function (v) {
    return function (deltaMs) {
        return function __do() {
            var state = Effect_Ref.read(v)();
            var transitions = toUnfoldable(state.transitions);
            var completedIds = Effect_Ref["new"]([  ])();
            for_(transitions)(function (v1) {
                var newElapsed = v1.value1.elapsed + deltaMs;
                var v2 = (function () {
                    if (v1.value1.transitionType instanceof SingleTransition) {
                        return {
                            duration: v1.value1.transitionType.value0.duration,
                            delay: v1.value1.transitionType.value0.delay,
                            easing: v1.value1.transitionType.value0.easing
                        };
                    };
                    if (v1.value1.transitionType instanceof CompoundTransition) {
                        return {
                            duration: v1.value1.transitionType.value0.duration,
                            delay: v1.value1.transitionType.value0.delay,
                            easing: v1.value1.transitionType.value0.easing
                        };
                    };
                    throw new Error("Failed pattern match at PSD3.Internal.Transition.Manager (line 322, column 39 - line 324, column 105): " + [ v1.value1.transitionType.constructor.name ]);
                })();
                var effectiveElapsed = max(0.0)(newElapsed - v2.delay);
                var rawProgress = effectiveElapsed / v2.duration;
                var clampedProgress = min(1.0)(max(0.0)(rawProgress));
                var easedProgress = applyEasing(v2.easing)(clampedProgress);
                return function __do() {
                    (function () {
                        if (v1.value1.transitionType instanceof SingleTransition) {
                            var currentValue = lerp(v1.value1.transitionType.value0.from)(v1.value1.transitionType.value0.to)(easedProgress);
                            return $foreign.setAttribute(v1.value1.element)(v1.value1.attrName)(show1(currentValue))();
                        };
                        if (v1.value1.transitionType instanceof CompoundTransition) {
                            var interpolatedValues = Data_Array.zipWith(function (from) {
                                return function (to) {
                                    return lerp(from)(to)(easedProgress);
                                };
                            })(v1.value1.transitionType.value0.fromValues)(v1.value1.transitionType.value0.toValues);
                            var generatedValue = v1.value1.transitionType.value0.generator(interpolatedValues);
                            return $foreign.setAttribute(v1.value1.element)(v1.value1.attrName)(generatedValue)();
                        };
                        throw new Error("Failed pattern match at PSD3.Internal.Transition.Manager (line 337, column 5 - line 350, column 65): " + [ v1.value1.transitionType.constructor.name ]);
                    })();
                    var isComplete = newElapsed >= v2.duration + v2.delay;
                    if (isComplete) {
                        v1.value1.onComplete();
                        Effect_Ref.modify_(function (ids) {
                            return append1(ids)([ v1.value1.id ]);
                        })(completedIds)();
                        return Effect_Ref.modify_(function (s) {
                            return {
                                elementIds: s.elementIds,
                                nextElementId: s.nextElementId,
                                nextId: s.nextId,
                                transitions: $$delete(v1.value0)(s.transitions)
                            };
                        })(v)();
                    };
                    return Effect_Ref.modify_(function (s) {
                        return {
                            elementIds: s.elementIds,
                            nextElementId: s.nextElementId,
                            nextId: s.nextId,
                            transitions: update(function (t) {
                                return new Data_Maybe.Just({
                                    attrName: t.attrName,
                                    element: t.element,
                                    id: t.id,
                                    onComplete: t.onComplete,
                                    transitionType: t.transitionType,
                                    elapsed: newElapsed
                                });
                            })(v1.value0)(s.transitions)
                        };
                    })(v)();
                };
            })();
            return Effect_Ref.read(completedIds)();
        };
    };
};
var activeCount = function (v) {
    return function __do() {
        var state = Effect_Ref.read(v)();
        return Data_Map_Internal.size(state.transitions);
    };
};
var toCoordinatorConsumer = function (manager) {
    return function (deltaMs) {
        return function __do() {
            tick(manager)(deltaMs)();
            var count = activeCount(manager)();
            var $136 = count === 0;
            if ($136) {
                return PSD3_Transition_Coordinator.Completed.value;
            };
            return PSD3_Transition_Coordinator.StillRunning.value;
        };
    };
};
export {
    create,
    registerTransition,
    registerAnimatedAttr,
    registerAnimatedCompound,
    toCoordinatorConsumer,
    tick,
    activeCount,
    clear,
    eqTransitionId,
    ordTransitionId,
    showTransitionId
};
//# sourceMappingURL=index.js.map
