// Generated by purs version 0.15.15
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Boolean from "../Data.Boolean/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Semigroup from "../Data.Semigroup/index.js";
import * as Data_String_Common from "../Data.String.Common/index.js";
var map = /* #__PURE__ */ Data_Functor.map(Data_Maybe.functorMaybe);
var map1 = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var elem = /* #__PURE__ */ Data_Array.elem(Data_Eq.eqString);
var append1 = /* #__PURE__ */ Data_Semigroup.append(Data_Semigroup.semigroupArray);
var foldl = /* #__PURE__ */ Data_Foldable.foldl(Data_Foldable.foldableArray);
var max = /* #__PURE__ */ Data_Ord.max(Data_Ord.ordInt);
var TreeNode = /* #__PURE__ */ (function () {
    function TreeNode(value0) {
        this.value0 = value0;
    };
    TreeNode.create = function (value0) {
        return new TreeNode(value0);
    };
    return TreeNode;
})();
var showTreeNode = function (dictShow) {
    return {
        show: function (v) {
            return "TreeNode { name: " + (v.value0.name + (", fullName: " + (v.value0.fullName + " }")));
        }
    };
};
var isLeaf = function (v) {
    return Data_Array["null"](v.value0.children);
};
var getTreeNodeName = function (v) {
    return v.value0.name;
};
var getTreeNodeData = function (v) {
    return v.value0.data_;
};
var getTreeNodeChildren = function (v) {
    return v.value0.children;
};
var getFullName = function (v) {
    return v.value0.fullName;
};
var getAncestors = function (root) {
    return function (target) {
        var findPath = function (v) {
            return function (v1) {
                if (v.value0.fullName === v1.value0.fullName) {
                    return new Data_Maybe.Just([ v ]);
                };
                if (Data_Boolean.otherwise) {
                    return Data_Array.findMap(function (child) {
                        return map(Data_Array.cons(v))(findPath(child)(new TreeNode(v1.value0)));
                    })(v.value0.children);
                };
                throw new Error("Failed pattern match at DataViz.Layout.Hierarchy.EdgeBundle.Hierarchy (line 86, column 3 - line 86, column 69): " + [ v.constructor.name, v1.constructor.name ]);
            };
        };
        return Data_Maybe.fromMaybe([  ])(findPath(root)(target));
    };
};
var pathBetween = function (root) {
    return function (source) {
        return function (target) {
            var findLCA = function (as) {
                return function (bs) {
                    var bNames = map1(getFullName)(bs);
                    var common = Data_Array.filter(function (a) {
                        return elem(getFullName(a))(bNames);
                    })(as);
                    return Data_Array.last(common);
                };
            };
            var targetAncestors = getAncestors(root)(target);
            var sourceAncestors = getAncestors(root)(source);
            var lca = findLCA(sourceAncestors)(targetAncestors);
            var lcaToTarget = (function () {
                if (lca instanceof Data_Maybe.Nothing) {
                    return targetAncestors;
                };
                if (lca instanceof Data_Maybe.Just) {
                    var lcaName = getFullName(lca.value0);
                    return Data_Array.dropWhile(function (n) {
                        return getFullName(n) !== lcaName;
                    })(targetAncestors);
                };
                throw new Error("Failed pattern match at DataViz.Layout.Hierarchy.EdgeBundle.Hierarchy (line 119, column 19 - line 125, column 75): " + [ lca.constructor.name ]);
            })();
            var sourceToLCA = (function () {
                if (lca instanceof Data_Maybe.Nothing) {
                    return sourceAncestors;
                };
                if (lca instanceof Data_Maybe.Just) {
                    var lcaName = getFullName(lca.value0);
                    return Data_Array.reverse(Data_Array.takeWhile(function (n) {
                        return getFullName(n) !== lcaName;
                    })(Data_Array.reverse(sourceAncestors)));
                };
                throw new Error("Failed pattern match at DataViz.Layout.Hierarchy.EdgeBundle.Hierarchy (line 110, column 19 - line 116, column 107): " + [ lca.constructor.name ]);
            })();
            return append1(sourceToLCA)(lcaToTarget);
        };
    };
};
var findNode = function (targetName) {
    return function (v) {
        if (v.value0.fullName === targetName) {
            return new Data_Maybe.Just(v);
        };
        if (Data_Boolean.otherwise) {
            return Data_Array.findMap(findNode(targetName))(v.value0.children);
        };
        throw new Error("Failed pattern match at DataViz.Layout.Hierarchy.EdgeBundle.Hierarchy (line 75, column 1 - line 75, column 65): " + [ targetName.constructor.name, v.constructor.name ]);
    };
};
var descendants = function (v) {
    return append1([ v ])(Data_Array.concatMap(descendants)(v.value0.children));
};
var leaves = function (root) {
    return Data_Array.filter(isLeaf)(descendants(root));
};
var computeHeights = function (v) {
    var $58 = Data_Array["null"](v.value0.children);
    if ($58) {
        return new TreeNode({
            name: v.value0.name,
            fullName: v.value0.fullName,
            children: v.value0.children,
            data_: v.value0.data_,
            depth: v.value0.depth,
            height: 0
        });
    };
    var childrenWithHeights = map1(computeHeights)(v.value0.children);
    var maxChildHeight = foldl(function (acc) {
        return function (v1) {
            return max(acc)(v1.value0.height);
        };
    })(0)(childrenWithHeights);
    return new TreeNode({
        name: v.value0.name,
        fullName: v.value0.fullName,
        data_: v.value0.data_,
        depth: v.value0.depth,
        children: childrenWithHeights,
        height: maxChildHeight + 1 | 0
    });
};
var addOrUpdateChild = function (name) {
    return function (newChild) {
        return function (children) {
            var exists = Data_Array.any(function (v) {
                return v.value0.name === name;
            })(children);
            if (exists) {
                return map1(function (v) {
                    var $66 = v.value0.name === name;
                    if ($66) {
                        return newChild;
                    };
                    return v;
                })(children);
            };
            return Data_Array.snoc(children)(newChild);
        };
    };
};
var insertAtPath = function (parts) {
    return function (fullName) {
        return function (nodeData) {
            return function (prefix) {
                return function (v) {
                    var v1 = Data_Array.uncons(parts);
                    if (v1 instanceof Data_Maybe.Nothing) {
                        return new TreeNode(v.value0);
                    };
                    if (v1 instanceof Data_Maybe.Just) {
                        var newPrefix = (function () {
                            var $74 = prefix === "";
                            if ($74) {
                                return v1.value0.head;
                            };
                            return prefix + ("." + v1.value0.head);
                        })();
                        var newDepth = v.value0.depth + 1 | 0;
                        var $75 = Data_Array["null"](v1.value0.tail);
                        if ($75) {
                            var newLeaf = new TreeNode({
                                name: v1.value0.head,
                                fullName: newPrefix,
                                children: [  ],
                                data_: new Data_Maybe.Just(nodeData),
                                depth: newDepth,
                                height: 0
                            });
                            return new TreeNode({
                                name: v.value0.name,
                                fullName: v.value0.fullName,
                                data_: v.value0.data_,
                                depth: v.value0.depth,
                                height: v.value0.height,
                                children: addOrUpdateChild(v1.value0.head)(newLeaf)(v.value0.children)
                            });
                        };
                        var existingChild = Data_Array.find(function (v2) {
                            return v2.value0.name === v1.value0.head;
                        })(v.value0.children);
                        var childNode = (function () {
                            if (existingChild instanceof Data_Maybe.Just) {
                                return existingChild.value0;
                            };
                            if (existingChild instanceof Data_Maybe.Nothing) {
                                return new TreeNode({
                                    name: v1.value0.head,
                                    fullName: newPrefix,
                                    children: [  ],
                                    data_: Data_Maybe.Nothing.value,
                                    depth: newDepth,
                                    height: 0
                                });
                            };
                            throw new Error("Failed pattern match at DataViz.Layout.Hierarchy.EdgeBundle.Hierarchy (line 232, column 25 - line 241, column 18): " + [ existingChild.constructor.name ]);
                        })();
                        var updatedChild = insertAtPath(v1.value0.tail)(fullName)(nodeData)(newPrefix)(childNode);
                        return new TreeNode({
                            name: v.value0.name,
                            fullName: v.value0.fullName,
                            data_: v.value0.data_,
                            depth: v.value0.depth,
                            height: v.value0.height,
                            children: addOrUpdateChild(v1.value0.head)(updatedChild)(v.value0.children)
                        });
                    };
                    throw new Error("Failed pattern match at DataViz.Layout.Hierarchy.EdgeBundle.Hierarchy (line 205, column 3 - line 246, column 92): " + [ v1.constructor.name ]);
                };
            };
        };
    };
};
var insertNode = function (getName) {
    return function (root) {
        return function (nodeData) {
            var fullName = getName(nodeData);
            var parts = Data_String_Common.split(".")(fullName);
            return insertAtPath(parts)(fullName)(nodeData)("")(root);
        };
    };
};
var buildHierarchy = function (config) {
    return function (nodes) {
        var emptyRoot = new TreeNode({
            name: "",
            fullName: "",
            children: [  ],
            data_: Data_Maybe.Nothing.value,
            depth: 0,
            height: 0
        });
        var treeWithNodes = foldl(insertNode(config.getName))(emptyRoot)(nodes);
        var withHeights = computeHeights(treeWithNodes);
        return withHeights;
    };
};
export {
    buildHierarchy,
    TreeNode,
    getTreeNodeName,
    getTreeNodeChildren,
    getTreeNodeData,
    isLeaf,
    leaves,
    descendants,
    findNode,
    getFullName,
    getAncestors,
    pathBetween,
    showTreeNode
};
//# sourceMappingURL=index.js.map
