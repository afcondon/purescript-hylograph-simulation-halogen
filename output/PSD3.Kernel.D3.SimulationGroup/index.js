// Generated by purs version 0.15.15
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Category from "../Control.Category/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Traversable from "../Data.Traversable/index.js";
import * as Data_Tuple from "../Data.Tuple/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Effect from "../Effect/index.js";
import * as Effect_Ref from "../Effect.Ref/index.js";
import * as PSD3_Kernel_D3_Core from "../PSD3.Kernel.D3.Core/index.js";
import * as PSD3_Kernel_D3_Setup from "../PSD3.Kernel.D3.Setup/index.js";
import * as PSD3_Kernel_D3_Simulation from "../PSD3.Kernel.D3.Simulation/index.js";
var $$for = /* #__PURE__ */ Data_Traversable["for"](Effect.applicativeEffect)(Data_Traversable.traversableArray);
var pure = /* #__PURE__ */ Control_Applicative.pure(Effect.applicativeEffect);
var identity = /* #__PURE__ */ Control_Category.identity(Control_Category.categoryFn);
var unless = /* #__PURE__ */ Control_Applicative.unless(Effect.applicativeEffect);
var for_ = /* #__PURE__ */ Data_Foldable.for_(Effect.applicativeEffect)(Data_Foldable.foldableArray);
var when = /* #__PURE__ */ Control_Applicative.when(Effect.applicativeEffect);
var map = /* #__PURE__ */ Data_Functor.map(Effect.functorEffect);
var tickGroup = function (group) {
    return function __do() {
        var activeFlags = Effect_Ref.read(group.activeFlags)();
        var results = $$for(Data_Array.zipWith(Data_Tuple.Tuple.create)(group.simulations)(activeFlags))(function (v) {
            if (v.value1) {
                return function __do() {
                    var alpha = PSD3_Kernel_D3_Simulation.tick(v.value0)();
                    return alpha > 0.0;
                };
            };
            return pure(false);
        })();
        return Data_Array.any(identity)(results);
    };
};
var setSimActive = function (idx) {
    return function (active) {
        return function (group) {
            return function __do() {
                var flags = Effect_Ref.read(group.activeFlags)();
                var v = Data_Array.updateAt(idx)(active)(flags);
                if (v instanceof Data_Maybe.Nothing) {
                    return Data_Unit.unit;
                };
                if (v instanceof Data_Maybe.Just) {
                    return Effect_Ref.write(v.value0)(group.activeFlags)();
                };
                throw new Error("Failed pattern match at PSD3.Kernel.D3.SimulationGroup (line 223, column 3 - line 225, column 58): " + [ v.constructor.name ]);
            };
        };
    };
};
var setNodesAt = function (idx) {
    return function (nodes) {
        return function (group) {
            var v = Data_Array.index(group.simulations)(idx);
            if (v instanceof Data_Maybe.Nothing) {
                return pure(Data_Unit.unit);
            };
            if (v instanceof Data_Maybe.Just) {
                return PSD3_Kernel_D3_Simulation.setNodes(nodes)(v.value0);
            };
            throw new Error("Failed pattern match at PSD3.Kernel.D3.SimulationGroup (line 253, column 30 - line 255, column 37): " + [ v.constructor.name ]);
        };
    };
};
var setLinksAt = function (idx) {
    return function (links) {
        return function (group) {
            var v = Data_Array.index(group.simulations)(idx);
            if (v instanceof Data_Maybe.Nothing) {
                return pure(Data_Unit.unit);
            };
            if (v instanceof Data_Maybe.Just) {
                return PSD3_Kernel_D3_Simulation.setLinks(links)(v.value0);
            };
            throw new Error("Failed pattern match at PSD3.Kernel.D3.SimulationGroup (line 263, column 30 - line 265, column 37): " + [ v.constructor.name ]);
        };
    };
};
var setAllActive = function (active) {
    return function (group) {
        var count = Data_Array.length(group.simulations);
        return Effect_Ref.write(Data_Array.replicate(count)(active))(group.activeFlags);
    };
};
var isSimActive = function (idx) {
    return function (group) {
        return function __do() {
            var flags = Effect_Ref.read(group.activeFlags)();
            return Data_Maybe.fromMaybe(false)(Data_Array.index(flags)(idx));
        };
    };
};
var invokeTickCallback = function (group) {
    if (group.callbacks instanceof Data_Maybe.Nothing) {
        return pure(Data_Unit.unit);
    };
    if (group.callbacks instanceof Data_Maybe.Just) {
        return function __do() {
            var callback = Effect_Ref.read(group.callbacks.value0.onTick)();
            return callback();
        };
    };
    throw new Error("Failed pattern match at PSD3.Kernel.D3.SimulationGroup (line 338, column 28 - line 342, column 13): " + [ group.callbacks.constructor.name ]);
};
var invokeStopCallback = function (group) {
    if (group.callbacks instanceof Data_Maybe.Nothing) {
        return pure(Data_Unit.unit);
    };
    if (group.callbacks instanceof Data_Maybe.Just) {
        return function __do() {
            var callback = Effect_Ref.read(group.callbacks.value0.onStop)();
            return callback();
        };
    };
    throw new Error("Failed pattern match at PSD3.Kernel.D3.SimulationGroup (line 331, column 28 - line 335, column 13): " + [ group.callbacks.constructor.name ]);
};
var stopGroup = function (group) {
    return function __do() {
        Effect_Ref.write(false)(group.running)();
        var cancel = Effect_Ref.read(group.cancelAnimation)();
        cancel();
        return invokeStopCallback(group)();
    };
};
var invokeStartCallback = function (group) {
    if (group.callbacks instanceof Data_Maybe.Nothing) {
        return pure(Data_Unit.unit);
    };
    if (group.callbacks instanceof Data_Maybe.Just) {
        return function __do() {
            var callback = Effect_Ref.read(group.callbacks.value0.onStart)();
            return callback();
        };
    };
    throw new Error("Failed pattern match at PSD3.Kernel.D3.SimulationGroup (line 324, column 29 - line 328, column 13): " + [ group.callbacks.constructor.name ]);
};
var startGroup = function (group) {
    return function __do() {
        var alreadyRunning = Effect_Ref.read(group.running)();
        return unless(alreadyRunning)(function __do() {
            Effect_Ref.write(true)(group.running)();
            invokeStartCallback(group)();
            var cancel = PSD3_Kernel_D3_Core.startAnimation(function (v) {
                return function __do() {
                    var running = Effect_Ref.read(group.running)();
                    if (running) {
                        var anyActive = tickGroup(group)();
                        invokeTickCallback(group)();
                        return anyActive;
                    };
                    return false;
                };
            })();
            return Effect_Ref.write(cancel)(group.cancelAnimation)();
        })();
    };
};
var reheatAll = function (group) {
    return function __do() {
        var activeFlags = Effect_Ref.read(group.activeFlags)();
        for_(Data_Array.zipWith(Data_Tuple.Tuple.create)(group.simulations)(activeFlags))(function (v) {
            return when(v.value1)(Effect_Ref.write(1.0)(v.value0.alpha));
        })();
        var running = Effect_Ref.read(group.running)();
        return unless(running)(startGroup(group))();
    };
};
var reheatAt = function (idx) {
    return function (group) {
        var v = Data_Array.index(group.simulations)(idx);
        if (v instanceof Data_Maybe.Nothing) {
            return pure(Data_Unit.unit);
        };
        if (v instanceof Data_Maybe.Just) {
            return function __do() {
                Effect_Ref.write(1.0)(v.value0.alpha)();
                var running = Effect_Ref.read(group.running)();
                return unless(running)(startGroup(group))();
            };
        };
        throw new Error("Failed pattern match at PSD3.Kernel.D3.SimulationGroup (line 208, column 22 - line 213, column 38): " + [ v.constructor.name ]);
    };
};
var getSimulationCount = function (group) {
    return Data_Array.length(group.simulations);
};
var getSimulationAt = function (idx) {
    return function (group) {
        return Data_Array.index(group.simulations)(idx);
    };
};
var getNodesAt = function (idx) {
    return function (group) {
        var v = Data_Array.index(group.simulations)(idx);
        if (v instanceof Data_Maybe.Nothing) {
            return pure(Data_Maybe.Nothing.value);
        };
        if (v instanceof Data_Maybe.Just) {
            return map(Data_Maybe.Just.create)(PSD3_Kernel_D3_Simulation.getNodes(v.value0));
        };
        throw new Error("Failed pattern match at PSD3.Kernel.D3.SimulationGroup (line 272, column 24 - line 274, column 40): " + [ v.constructor.name ]);
    };
};
var getGroupCallbacks = function (group) {
    return group.callbacks;
};
var getActiveFlags = function (group) {
    return Effect_Ref.read(group.activeFlags);
};
var defaultGroupConfig = {
    count: 1,
    simConfig: PSD3_Kernel_D3_Simulation.defaultConfig
};
var createGroupWithCallbacks = function (count) {
    return function (config) {
        return function (cbs) {
            return function __do() {
                var sims = $$for(Data_Array.range(0)(count - 1 | 0))(function (v) {
                    return PSD3_Kernel_D3_Simulation.create(config);
                })();
                var activeRef = Effect_Ref["new"](Data_Array.replicate(count)(true))();
                var runningRef = Effect_Ref["new"](false)();
                var cancelRef = Effect_Ref["new"](pure(Data_Unit.unit))();
                return {
                    simulations: sims,
                    activeFlags: activeRef,
                    running: runningRef,
                    cancelAnimation: cancelRef,
                    callbacks: new Data_Maybe.Just(cbs)
                };
            };
        };
    };
};
var createGroup = function (count) {
    return function (config) {
        return function __do() {
            var sims = $$for(Data_Array.range(0)(count - 1 | 0))(function (v) {
                return PSD3_Kernel_D3_Simulation.create(config);
            })();
            var activeRef = Effect_Ref["new"](Data_Array.replicate(count)(true))();
            var runningRef = Effect_Ref["new"](false)();
            var cancelRef = Effect_Ref["new"](pure(Data_Unit.unit))();
            return {
                simulations: sims,
                activeFlags: activeRef,
                running: runningRef,
                cancelAnimation: cancelRef,
                callbacks: Data_Maybe.Nothing.value
            };
        };
    };
};
var applySetupAt = function (idx) {
    return function (setup) {
        return function (group) {
            var v = Data_Array.index(group.simulations)(idx);
            if (v instanceof Data_Maybe.Nothing) {
                return pure(Data_Unit.unit);
            };
            if (v instanceof Data_Maybe.Just) {
                return PSD3_Kernel_D3_Setup.applySetup(setup)(v.value0);
            };
            throw new Error("Failed pattern match at PSD3.Kernel.D3.SimulationGroup (line 297, column 32 - line 299, column 41): " + [ v.constructor.name ]);
        };
    };
};
var applySetupAll = function (setup) {
    return function (group) {
        return for_(group.simulations)(function (sim) {
            return PSD3_Kernel_D3_Setup.applySetup(setup)(sim);
        });
    };
};
export {
    defaultGroupConfig,
    createGroup,
    createGroupWithCallbacks,
    startGroup,
    stopGroup,
    tickGroup,
    reheatAll,
    reheatAt,
    setSimActive,
    setAllActive,
    isSimActive,
    getActiveFlags,
    setNodesAt,
    setLinksAt,
    getNodesAt,
    getSimulationAt,
    getSimulationCount,
    applySetupAt,
    applySetupAll,
    getGroupCallbacks
};
//# sourceMappingURL=index.js.map
