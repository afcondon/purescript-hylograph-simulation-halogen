// Generated by purs version 0.15.15
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Control_Monad_State from "../Control.Monad.State/index.js";
import * as Control_Monad_State_Class from "../Control.Monad.State.Class/index.js";
import * as Control_Monad_State_Trans from "../Control.Monad.State.Trans/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Boolean from "../Data.Boolean/index.js";
import * as Data_Eq from "../Data.Eq/index.js";
import * as Data_EuclideanRing from "../Data.EuclideanRing/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Identity from "../Data.Identity/index.js";
import * as Data_Int from "../Data.Int/index.js";
import * as Data_Map_Internal from "../Data.Map.Internal/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Number from "../Data.Number/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Ordering from "../Data.Ordering/index.js";
import * as Data_Semigroup from "../Data.Semigroup/index.js";
import * as Data_Set from "../Data.Set/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as DataViz_Layout_Sankey_Types from "../DataViz.Layout.Sankey.Types/index.js";
import * as Effect from "../Effect/index.js";
import * as Effect_Console from "../Effect.Console/index.js";
import * as Effect_Unsafe from "../Effect.Unsafe/index.js";
var lookup = /* #__PURE__ */ Data_Map_Internal.lookup(DataViz_Layout_Sankey_Types.ordNodeID);
var insert = /* #__PURE__ */ Data_Set.insert(DataViz_Layout_Sankey_Types.ordNodeID);
var insert1 = /* #__PURE__ */ Data_Map_Internal.insert(DataViz_Layout_Sankey_Types.ordNodeID);
var bindStateT = /* #__PURE__ */ Control_Monad_State_Trans.bindStateT(Data_Identity.monadIdentity);
var bind = /* #__PURE__ */ Control_Bind.bind(bindStateT);
var monadStateStateT = /* #__PURE__ */ Control_Monad_State_Trans.monadStateStateT(Data_Identity.monadIdentity);
var get = /* #__PURE__ */ Control_Monad_State_Class.get(monadStateStateT);
var lookup1 = /* #__PURE__ */ Data_Map_Internal.lookup(Data_Ord.ordString);
var modify_ = /* #__PURE__ */ Control_Monad_State_Class.modify_(monadStateStateT);
var insert2 = /* #__PURE__ */ Data_Map_Internal.insert(Data_Ord.ordString);
var append = /* #__PURE__ */ Data_Semigroup.append(Data_Semigroup.semigroupArray);
var map = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var min = /* #__PURE__ */ Data_Ord.min(Data_Ord.ordNumber);
var max = /* #__PURE__ */ Data_Ord.max(Data_Ord.ordInt);
var eq1 = /* #__PURE__ */ Data_Eq.eq(DataViz_Layout_Sankey_Types.eqNodeID);
var append1 = /* #__PURE__ */ Data_Semigroup.append(Data_Ordering.semigroupOrdering);
var compare = /* #__PURE__ */ Data_Ord.compare(Data_Ord.ordNumber);
var compare1 = /* #__PURE__ */ Data_Ord.compare(DataViz_Layout_Sankey_Types.ordLinkID);
var div1 = /* #__PURE__ */ Data_EuclideanRing.div(Data_EuclideanRing.euclideanRingInt);
var max1 = /* #__PURE__ */ Data_Ord.max(Data_Ord.ordNumber);
var member = /* #__PURE__ */ Data_Set.member(DataViz_Layout_Sankey_Types.ordNodeID);
var union = /* #__PURE__ */ Data_Set.union(DataViz_Layout_Sankey_Types.ordNodeID);
var fromFoldable = /* #__PURE__ */ Data_Set.fromFoldable(Data_Foldable.foldableArray)(DataViz_Layout_Sankey_Types.ordNodeID);
var eq2 = /* #__PURE__ */ Data_Eq.eq(DataViz_Layout_Sankey_Types.eqLinkID);
var discard = /* #__PURE__ */ Control_Bind.discard(Control_Bind.discardUnit);
var for_ = /* #__PURE__ */ Data_Foldable.for_(Effect.applicativeEffect)(Data_Foldable.foldableArray);
var show = /* #__PURE__ */ Data_Show.show(Data_Show.showNumber);
var pure = /* #__PURE__ */ Control_Applicative.pure(Effect.applicativeEffect);
var mod = /* #__PURE__ */ Data_EuclideanRing.mod(Data_EuclideanRing.euclideanRingInt);
var show1 = /* #__PURE__ */ Data_Show.show(Data_Show.showInt);
var compare2 = /* #__PURE__ */ Data_Ord.compare(Data_Ord.ordString);
var applicativeStateT = /* #__PURE__ */ Control_Monad_State_Trans.applicativeStateT(Data_Identity.monadIdentity);
var pure1 = /* #__PURE__ */ Control_Applicative.pure(applicativeStateT);
var discard2 = /* #__PURE__ */ discard(bindStateT);
var for_1 = /* #__PURE__ */ Data_Foldable.for_(applicativeStateT)(Data_Foldable.foldableArray);
var unionInsert = function (sid) {
    return function (tid) {
        return function (deps) {
            var targetSet = (function () {
                var v = lookup(sid)(deps);
                if (v instanceof Data_Maybe.Nothing) {
                    return Data_Set.singleton(tid);
                };
                if (v instanceof Data_Maybe.Just) {
                    return insert(tid)(v.value0);
                };
                throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 128, column 5 - line 130, column 47): " + [ v.constructor.name ]);
            })();
            return insert1(sid)(targetSet)(deps);
        };
    };
};
var processCSVLink = function (link) {
    return bind(get)(function (model) {
        var t = lookup1(link.t)(model.nodeNameToID);
        var s = lookup1(link.s)(model.nodeNameToID);
        var v = (function () {
            if (s instanceof Data_Maybe.Just && t instanceof Data_Maybe.Just) {
                return {
                    nodeCount: model.nodeCount,
                    sid: s.value0,
                    tid: t.value0,
                    newNodes: [  ]
                };
            };
            if (s instanceof Data_Maybe.Just && t instanceof Data_Maybe.Nothing) {
                return {
                    nodeCount: model.nodeCount + 1 | 0,
                    sid: s.value0,
                    tid: model.nodeCount,
                    newNodes: [ model.nodeCount ]
                };
            };
            if (s instanceof Data_Maybe.Nothing && t instanceof Data_Maybe.Just) {
                return {
                    nodeCount: model.nodeCount + 1 | 0,
                    sid: model.nodeCount,
                    tid: t.value0,
                    newNodes: [ model.nodeCount ]
                };
            };
            if (s instanceof Data_Maybe.Nothing && t instanceof Data_Maybe.Nothing) {
                return {
                    nodeCount: model.nodeCount + 2 | 0,
                    sid: model.nodeCount,
                    tid: model.nodeCount + 1 | 0,
                    newNodes: [ model.nodeCount, model.nodeCount + 1 | 0 ]
                };
            };
            throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 144, column 7 - line 154, column 177): " + [ s.constructor.name, t.constructor.name ]);
        })();
        return modify_(function (v1) {
            var $137 = {};
            for (var $138 in v1) {
                if ({}.hasOwnProperty.call(v1, $138)) {
                    $137[$138] = v1[$138];
                };
            };
            $137.linkCount = model.linkCount + 1 | 0;
            $137.nodeCount = v.nodeCount;
            $137.nodeNameToID = insert2(link.s)(v.sid)(insert2(link.t)(v.tid)(model.nodeNameToID));
            $137.nodeIDToName = insert1(v.sid)(link.s)(insert1(v.tid)(link.t)(model.nodeIDToName));
            $137.nodeOrder = append(model.nodeOrder)(v.newNodes);
            $137.deps = unionInsert(v.sid)(v.tid)(model.deps);
            $137.sped = unionInsert(v.tid)(v.sid)(model.sped);
            $137.sankeyLinks = Data_Array.snoc(model.sankeyLinks)(DataViz_Layout_Sankey_Types.initialiseSankeyLink({
                source: v.sid,
                target: v.tid,
                value: link.v,
                id: model.linkCount
            }));
            return $137;
        });
    });
};
var initializeNodeBreadths = function (nodes) {
    return function (_links) {
        return function (_config) {
            return function (padding) {
                return function (y0) {
                    return function (y1) {
                        var positionLayer = function (ky) {
                            return function (padding1) {
                                return function (yStart) {
                                    return function (layerNodes) {
                                        var stacked = Data_Array.foldl(function (acc) {
                                            return function (node) {
                                                var nodeHeight = node.value * ky;
                                                var positioned = {
                                                    value: node.value,
                                                    color: node.color,
                                                    depth: node.depth,
                                                    index: node.index,
                                                    layer: node.layer,
                                                    name: node.name,
                                                    nodeHeight: node.nodeHeight,
                                                    sourceLinks: node.sourceLinks,
                                                    targetLinks: node.targetLinks,
                                                    x0: node.x0,
                                                    x1: node.x1,
                                                    y0: acc.y,
                                                    y1: acc.y + nodeHeight
                                                };
                                                return {
                                                    nodes: Data_Array.snoc(acc.nodes)(positioned),
                                                    y: acc.y + nodeHeight + padding1
                                                };
                                            };
                                        })({
                                            nodes: [  ],
                                            y: yStart
                                        })(layerNodes);
                                        var extraSpacing = ((y1 - stacked.y) + padding1) / (Data_Int.toNumber(Data_Array.length(layerNodes)) + 1.0);
                                        var adjusted = Data_Array.mapWithIndex(function (i) {
                                            return function (node) {
                                                var shift = extraSpacing * Data_Int.toNumber(i + 1 | 0);
                                                return {
                                                    color: node.color,
                                                    depth: node.depth,
                                                    index: node.index,
                                                    layer: node.layer,
                                                    name: node.name,
                                                    nodeHeight: node.nodeHeight,
                                                    sourceLinks: node.sourceLinks,
                                                    targetLinks: node.targetLinks,
                                                    value: node.value,
                                                    x0: node.x0,
                                                    x1: node.x1,
                                                    y0: node.y0 + shift,
                                                    y1: node.y1 + shift
                                                };
                                            };
                                        })(stacked.nodes);
                                        return adjusted;
                                    };
                                };
                            };
                        };
                        var calculateKy = function (layers) {
                            return function (height) {
                                return function (padding1) {
                                    var scaleForLayer = function (layerNodes) {
                                        var totalValue = Data_Array.foldl(function (sum) {
                                            return function (node) {
                                                return sum + node.value;
                                            };
                                        })(0.0)(layerNodes);
                                        var numNodes = Data_Int.toNumber(Data_Array.length(layerNodes));
                                        var availableHeight = height - (numNodes - 1.0) * padding1;
                                        var $144 = totalValue > 0.0;
                                        if ($144) {
                                            return availableHeight / totalValue;
                                        };
                                        return 1.0;
                                    };
                                    var scales = map(scaleForLayer)(layers);
                                    var nonEmptyScales = Data_Array.filter(function (s) {
                                        return s > 0.0;
                                    })(scales);
                                    var v = Data_Array.head(nonEmptyScales);
                                    if (v instanceof Data_Maybe.Just) {
                                        return Data_Array.foldl(min)(v.value0)(nonEmptyScales);
                                    };
                                    if (v instanceof Data_Maybe.Nothing) {
                                        return 1.0;
                                    };
                                    throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 467, column 7 - line 469, column 23): " + [ v.constructor.name ]);
                                };
                            };
                        };
                        var totalHeight = y1 - y0;
                        var maxLayer = Data_Array.foldl(function (acc) {
                            return function (node) {
                                return max(acc)(node.layer);
                            };
                        })(0)(nodes);
                        var layers = map(function (layerIdx) {
                            return Data_Array.filter(function (node) {
                                return node.layer === layerIdx;
                            })(nodes);
                        })(Data_Array.range(0)(maxLayer));
                        var ky = calculateKy(layers)(totalHeight)(padding);
                        var positionedLayers = map(positionLayer(ky)(padding)(y0))(layers);
                        var positioned = Data_Array.concat(positionedLayers);
                        return positioned;
                    };
                };
            };
        };
    };
};
var initialiseSankeyNodes = /* #__PURE__ */ bind(get)(function (model) {
    var sankeyNodes = Data_Array.catMaybes(map(DataViz_Layout_Sankey_Types.initialiseSankeyNode(model))(model.nodeOrder));
    return modify_(function (v) {
        var $147 = {};
        for (var $148 in v) {
            if ({}.hasOwnProperty.call(v, $148)) {
                $147[$148] = v[$148];
            };
        };
        $147.sankeyNodes = sankeyNodes;
        return $147;
    });
});
var epsilon = 1.0e-6;
var relaxation = function (nodes) {
    return function (links) {
        return function (config) {
            return function (padding) {
                return function (y0) {
                    return function (y1) {
                        var updateNodes = function (allNodes) {
                            return function (updated) {
                                return map(function (node) {
                                    var v = Data_Array.find(function (u) {
                                        return eq1(u.node.index)(node.index);
                                    })(updated);
                                    if (v instanceof Data_Maybe.Just) {
                                        return v.value0.node;
                                    };
                                    if (v instanceof Data_Maybe.Nothing) {
                                        return node;
                                    };
                                    throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 890, column 11 - line 892, column 28): " + [ v.constructor.name ]);
                                })(allNodes);
                            };
                        };
                        var targetTop = function (source) {
                            return function (target) {
                                return function (_sortedSourceLinks) {
                                    return function (allNodes) {
                                        return function (allLinks) {
                                            return function (py) {
                                                var targetIncoming = Data_Array.sortBy(function (a) {
                                                    return function (b) {
                                                        var v = Data_Array.find(function (n) {
                                                            return eq1(n.index)(b.sourceIndex);
                                                        })(allNodes);
                                                        var v1 = Data_Array.find(function (n) {
                                                            return eq1(n.index)(a.sourceIndex);
                                                        })(allNodes);
                                                        if (v1 instanceof Data_Maybe.Just && v instanceof Data_Maybe.Just) {
                                                            return append1(compare(v1.value0.y0)(v.value0.y0))(compare1(a.index)(b.index));
                                                        };
                                                        return compare1(a.index)(b.index);
                                                    };
                                                })(Data_Array.filter(function (l) {
                                                    return eq1(l.targetIndex)(target.index);
                                                })(allLinks));
                                                var sourceOutgoing = Data_Array.sortBy(function (a) {
                                                    return function (b) {
                                                        var v = Data_Array.find(function (n) {
                                                            return eq1(n.index)(b.targetIndex);
                                                        })(allNodes);
                                                        var v1 = Data_Array.find(function (n) {
                                                            return eq1(n.index)(a.targetIndex);
                                                        })(allNodes);
                                                        if (v1 instanceof Data_Maybe.Just && v instanceof Data_Maybe.Just) {
                                                            return append1(compare(v1.value0.y0)(v.value0.y0))(compare1(a.index)(b.index));
                                                        };
                                                        return compare1(a.index)(b.index);
                                                    };
                                                })(Data_Array.filter(function (l) {
                                                    return eq1(l.sourceIndex)(source.index);
                                                })(allLinks));
                                                var numTargetLinks = Data_Int.toNumber(Data_Array.length(targetIncoming));
                                                var startY = target.y0 - ((numTargetLinks - 1.0) * py) / 2.0;
                                                var yAtTarget = Data_Array.foldl(function (acc) {
                                                    return function (link) {
                                                        if (acc.found) {
                                                            return acc;
                                                        };
                                                        var $161 = eq1(link.sourceIndex)(source.index);
                                                        if ($161) {
                                                            return {
                                                                y: acc.y,
                                                                found: true
                                                            };
                                                        };
                                                        return {
                                                            y: acc.y + link.width + py,
                                                            found: false
                                                        };
                                                    };
                                                })({
                                                    y: startY,
                                                    found: false
                                                })(targetIncoming);
                                                var yFinal = Data_Array.foldl(function (acc) {
                                                    return function (link) {
                                                        if (acc.found) {
                                                            return acc;
                                                        };
                                                        var $163 = eq1(link.targetIndex)(target.index);
                                                        if ($163) {
                                                            return {
                                                                y: acc.y,
                                                                found: true
                                                            };
                                                        };
                                                        return {
                                                            y: acc.y - link.width,
                                                            found: false
                                                        };
                                                    };
                                                })({
                                                    y: yAtTarget.y,
                                                    found: false
                                                })(sourceOutgoing);
                                                return yFinal.y;
                                            };
                                        };
                                    };
                                };
                            };
                        };
                        var sourceTop = function (source) {
                            return function (target) {
                                return function (_sortedTargetLinks) {
                                    return function (allNodes) {
                                        return function (allLinks) {
                                            return function (py) {
                                                var targetIncoming = Data_Array.sortBy(function (a) {
                                                    return function (b) {
                                                        var v = Data_Array.find(function (n) {
                                                            return eq1(n.index)(b.sourceIndex);
                                                        })(allNodes);
                                                        var v1 = Data_Array.find(function (n) {
                                                            return eq1(n.index)(a.sourceIndex);
                                                        })(allNodes);
                                                        if (v1 instanceof Data_Maybe.Just && v instanceof Data_Maybe.Just) {
                                                            return append1(compare(v1.value0.y0)(v.value0.y0))(compare1(a.index)(b.index));
                                                        };
                                                        return compare1(a.index)(b.index);
                                                    };
                                                })(Data_Array.filter(function (l) {
                                                    return eq1(l.targetIndex)(target.index);
                                                })(allLinks));
                                                var sourceOutgoing = Data_Array.sortBy(function (a) {
                                                    return function (b) {
                                                        var v = Data_Array.find(function (n) {
                                                            return eq1(n.index)(b.targetIndex);
                                                        })(allNodes);
                                                        var v1 = Data_Array.find(function (n) {
                                                            return eq1(n.index)(a.targetIndex);
                                                        })(allNodes);
                                                        if (v1 instanceof Data_Maybe.Just && v instanceof Data_Maybe.Just) {
                                                            return append1(compare(v1.value0.y0)(v.value0.y0))(compare1(a.index)(b.index));
                                                        };
                                                        return compare1(a.index)(b.index);
                                                    };
                                                })(Data_Array.filter(function (l) {
                                                    return eq1(l.sourceIndex)(source.index);
                                                })(allLinks));
                                                var numSourceLinks = Data_Int.toNumber(Data_Array.length(sourceOutgoing));
                                                var startY = source.y0 - ((numSourceLinks - 1.0) * py) / 2.0;
                                                var yAtSource = Data_Array.foldl(function (acc) {
                                                    return function (link) {
                                                        if (acc.found) {
                                                            return acc;
                                                        };
                                                        var $173 = eq1(link.targetIndex)(target.index);
                                                        if ($173) {
                                                            return {
                                                                y: acc.y,
                                                                found: true
                                                            };
                                                        };
                                                        return {
                                                            y: acc.y + link.width + py,
                                                            found: false
                                                        };
                                                    };
                                                })({
                                                    y: startY,
                                                    found: false
                                                })(sourceOutgoing);
                                                var yFinal = Data_Array.foldl(function (acc) {
                                                    return function (link) {
                                                        if (acc.found) {
                                                            return acc;
                                                        };
                                                        var $175 = eq1(link.sourceIndex)(source.index);
                                                        if ($175) {
                                                            return {
                                                                y: acc.y,
                                                                found: true
                                                            };
                                                        };
                                                        return {
                                                            y: acc.y - link.width,
                                                            found: false
                                                        };
                                                    };
                                                })({
                                                    y: yAtSource.y,
                                                    found: false
                                                })(targetIncoming);
                                                return yFinal.y;
                                            };
                                        };
                                    };
                                };
                            };
                        };
                        var resolveCollisionsTopToBottom = function (nodes1) {
                            return function (startIdx) {
                                return function (targetY) {
                                    return function (padding1) {
                                        return function (beta) {
                                            var n = Data_Array.length(nodes1);
                                            var go = function ($copy_idx) {
                                                return function ($copy_y) {
                                                    return function ($copy_currentNodes) {
                                                        var $tco_var_idx = $copy_idx;
                                                        var $tco_var_y = $copy_y;
                                                        var $tco_done = false;
                                                        var $tco_result;
                                                        function $tco_loop(idx, y, currentNodes) {
                                                            var $176 = idx >= n;
                                                            if ($176) {
                                                                $tco_done = true;
                                                                return currentNodes;
                                                            };
                                                            var v = Data_Array.index(currentNodes)(idx);
                                                            if (v instanceof Data_Maybe.Nothing) {
                                                                $tco_done = true;
                                                                return currentNodes;
                                                            };
                                                            if (v instanceof Data_Maybe.Just) {
                                                                var dy = (y - v.value0.node.y0) * beta;
                                                                var updated = (function () {
                                                                    var $178 = dy > epsilon;
                                                                    if ($178) {
                                                                        var newNode = {
                                                                            color: v.value0.node.color,
                                                                            depth: v.value0.node.depth,
                                                                            index: v.value0.node.index,
                                                                            layer: v.value0.node.layer,
                                                                            name: v.value0.node.name,
                                                                            nodeHeight: v.value0.node.nodeHeight,
                                                                            sourceLinks: v.value0.node.sourceLinks,
                                                                            targetLinks: v.value0.node.targetLinks,
                                                                            value: v.value0.node.value,
                                                                            x0: v.value0.node.x0,
                                                                            x1: v.value0.node.x1,
                                                                            y0: v.value0.node.y0 + dy,
                                                                            y1: v.value0.node.y1 + dy
                                                                        };
                                                                        return Data_Maybe.fromMaybe(currentNodes)(Data_Array.updateAt(idx)({
                                                                            node: newNode,
                                                                            targetY: v.value0.targetY
                                                                        })(currentNodes));
                                                                    };
                                                                    return currentNodes;
                                                                })();
                                                                var newY = (function () {
                                                                    var v1 = Data_Array.index(updated)(idx);
                                                                    if (v1 instanceof Data_Maybe.Just) {
                                                                        return v1.value0.node.y1 + padding1;
                                                                    };
                                                                    if (v1 instanceof Data_Maybe.Nothing) {
                                                                        return y;
                                                                    };
                                                                    throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 877, column 22 - line 879, column 29): " + [ v1.constructor.name ]);
                                                                })();
                                                                $tco_var_idx = idx + 1 | 0;
                                                                $tco_var_y = newY;
                                                                $copy_currentNodes = updated;
                                                                return;
                                                            };
                                                            throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 864, column 14 - line 881, column 40): " + [ v.constructor.name ]);
                                                        };
                                                        while (!$tco_done) {
                                                            $tco_result = $tco_loop($tco_var_idx, $tco_var_y, $copy_currentNodes);
                                                        };
                                                        return $tco_result;
                                                    };
                                                };
                                            };
                                            return go(startIdx)(targetY)(nodes1);
                                        };
                                    };
                                };
                            };
                        };
                        var resolveCollisionsBottomToTop = function (nodes1) {
                            return function (startIdx) {
                                return function (targetY) {
                                    return function (padding1) {
                                        return function (beta) {
                                            var $182 = startIdx < 0;
                                            if ($182) {
                                                return nodes1;
                                            };
                                            var go = function ($copy_idx) {
                                                return function ($copy_y) {
                                                    return function ($copy_currentNodes) {
                                                        var $tco_var_idx = $copy_idx;
                                                        var $tco_var_y = $copy_y;
                                                        var $tco_done1 = false;
                                                        var $tco_result;
                                                        function $tco_loop(idx, y, currentNodes) {
                                                            var $183 = idx < 0;
                                                            if ($183) {
                                                                $tco_done1 = true;
                                                                return currentNodes;
                                                            };
                                                            var v = Data_Array.index(currentNodes)(idx);
                                                            if (v instanceof Data_Maybe.Nothing) {
                                                                $tco_done1 = true;
                                                                return currentNodes;
                                                            };
                                                            if (v instanceof Data_Maybe.Just) {
                                                                var dy = (v.value0.node.y1 - y) * beta;
                                                                var updated = (function () {
                                                                    var $185 = dy > epsilon;
                                                                    if ($185) {
                                                                        var newNode = {
                                                                            color: v.value0.node.color,
                                                                            depth: v.value0.node.depth,
                                                                            index: v.value0.node.index,
                                                                            layer: v.value0.node.layer,
                                                                            name: v.value0.node.name,
                                                                            nodeHeight: v.value0.node.nodeHeight,
                                                                            sourceLinks: v.value0.node.sourceLinks,
                                                                            targetLinks: v.value0.node.targetLinks,
                                                                            value: v.value0.node.value,
                                                                            x0: v.value0.node.x0,
                                                                            x1: v.value0.node.x1,
                                                                            y0: v.value0.node.y0 - dy,
                                                                            y1: v.value0.node.y1 - dy
                                                                        };
                                                                        return Data_Maybe.fromMaybe(currentNodes)(Data_Array.updateAt(idx)({
                                                                            node: newNode,
                                                                            targetY: v.value0.targetY
                                                                        })(currentNodes));
                                                                    };
                                                                    return currentNodes;
                                                                })();
                                                                var newY = (function () {
                                                                    var v1 = Data_Array.index(updated)(idx);
                                                                    if (v1 instanceof Data_Maybe.Just) {
                                                                        return v1.value0.node.y0 - padding1;
                                                                    };
                                                                    if (v1 instanceof Data_Maybe.Nothing) {
                                                                        return y;
                                                                    };
                                                                    throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 846, column 24 - line 848, column 31): " + [ v1.constructor.name ]);
                                                                })();
                                                                $tco_var_idx = idx - 1 | 0;
                                                                $tco_var_y = newY;
                                                                $copy_currentNodes = updated;
                                                                return;
                                                            };
                                                            throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 833, column 16 - line 850, column 42): " + [ v.constructor.name ]);
                                                        };
                                                        while (!$tco_done1) {
                                                            $tco_result = $tco_loop($tco_var_idx, $tco_var_y, $copy_currentNodes);
                                                        };
                                                        return $tco_result;
                                                    };
                                                };
                                            };
                                            return go(startIdx)(targetY)(nodes1);
                                        };
                                    };
                                };
                            };
                        };
                        var resolveCollisions = function (sorted) {
                            return function (padding1) {
                                return function (yMin) {
                                    return function (yMax) {
                                        return function (beta) {
                                            var $189 = Data_Array["null"](sorted);
                                            if ($189) {
                                                return sorted;
                                            };
                                            var n = Data_Array.length(sorted);
                                            var middleIdx = div1(n)(2);
                                            var middleNode = Data_Array.index(sorted)(middleIdx);
                                            var startYDown = (function () {
                                                if (middleNode instanceof Data_Maybe.Just) {
                                                    return middleNode.value0.node.y1 + padding1;
                                                };
                                                if (middleNode instanceof Data_Maybe.Nothing) {
                                                    return yMin;
                                                };
                                                throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 809, column 22 - line 811, column 26): " + [ middleNode.constructor.name ]);
                                            })();
                                            var startYUp = (function () {
                                                if (middleNode instanceof Data_Maybe.Just) {
                                                    return middleNode.value0.node.y0 - padding1;
                                                };
                                                if (middleNode instanceof Data_Maybe.Nothing) {
                                                    return yMax;
                                                };
                                                throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 801, column 20 - line 803, column 26): " + [ middleNode.constructor.name ]);
                                            })();
                                            var pushedUp = resolveCollisionsBottomToTop(sorted)(middleIdx - 1 | 0)(startYUp)(padding1)(beta);
                                            var pushedUpAndDown = resolveCollisionsTopToBottom(pushedUp)(middleIdx + 1 | 0)(startYDown)(padding1)(beta);
                                            var clampedBottom = resolveCollisionsBottomToTop(pushedUpAndDown)(n - 1 | 0)(yMax)(padding1)(beta);
                                            var clampedTop = resolveCollisionsTopToBottom(clampedBottom)(0)(yMin)(padding1)(beta);
                                            return clampedTop;
                                        };
                                    };
                                };
                            };
                        };
                        var calculateWeightedFromTargets = function (node) {
                            return function (allNodes) {
                                return function (allLinks) {
                                    return function (padding1) {
                                        var outgoingLinks = Data_Array.filter(function (l) {
                                            return eq1(l.sourceIndex)(node.index);
                                        })(allLinks);
                                        var sortedLinks = Data_Array.sortBy(function (a) {
                                            return function (b) {
                                                var v = Data_Array.find(function (n) {
                                                    return eq1(n.index)(b.targetIndex);
                                                })(allNodes);
                                                var v1 = Data_Array.find(function (n) {
                                                    return eq1(n.index)(a.targetIndex);
                                                })(allNodes);
                                                if (v1 instanceof Data_Maybe.Just && v instanceof Data_Maybe.Just) {
                                                    return append1(compare(v1.value0.y0)(v.value0.y0))(compare1(a.index)(b.index));
                                                };
                                                return compare1(a.index)(b.index);
                                            };
                                        })(outgoingLinks);
                                        var result = Data_Array.foldl(function (acc) {
                                            return function (link) {
                                                var v = Data_Array.find(function (n) {
                                                    return eq1(n.index)(link.targetIndex);
                                                })(allNodes);
                                                if (v instanceof Data_Maybe.Just) {
                                                    var layerDist = Data_Int.toNumber(v.value0.layer - node.layer | 0);
                                                    var v1 = link.value * max1(1.0)(layerDist);
                                                    var idealY = targetTop(node)(v.value0)(sortedLinks)(allNodes)(allLinks)(padding1);
                                                    return {
                                                        sum: acc.sum + idealY * v1,
                                                        totalWeight: acc.totalWeight + v1
                                                    };
                                                };
                                                if (v instanceof Data_Maybe.Nothing) {
                                                    return acc;
                                                };
                                                throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 627, column 13 - line 637, column 29): " + [ v.constructor.name ]);
                                            };
                                        })({
                                            sum: 0.0,
                                            totalWeight: 0.0
                                        })(sortedLinks);
                                        var $200 = result.totalWeight > 0.0;
                                        if ($200) {
                                            return result.sum / result.totalWeight;
                                        };
                                        return node.y0;
                                    };
                                };
                            };
                        };
                        var calculateWeightedFromSources = function (node) {
                            return function (allNodes) {
                                return function (allLinks) {
                                    return function (padding1) {
                                        var incomingLinks = Data_Array.filter(function (l) {
                                            return eq1(l.targetIndex)(node.index);
                                        })(allLinks);
                                        var sortedLinks = Data_Array.sortBy(function (a) {
                                            return function (b) {
                                                var v = Data_Array.find(function (n) {
                                                    return eq1(n.index)(b.sourceIndex);
                                                })(allNodes);
                                                var v1 = Data_Array.find(function (n) {
                                                    return eq1(n.index)(a.sourceIndex);
                                                })(allNodes);
                                                if (v1 instanceof Data_Maybe.Just && v instanceof Data_Maybe.Just) {
                                                    return append1(compare(v1.value0.y0)(v.value0.y0))(compare1(a.index)(b.index));
                                                };
                                                return compare1(a.index)(b.index);
                                            };
                                        })(incomingLinks);
                                        var result = Data_Array.foldl(function (acc) {
                                            return function (link) {
                                                var v = Data_Array.find(function (n) {
                                                    return eq1(n.index)(link.sourceIndex);
                                                })(allNodes);
                                                if (v instanceof Data_Maybe.Just) {
                                                    var layerDist = Data_Int.toNumber(node.layer - v.value0.layer | 0);
                                                    var v1 = link.value * max1(1.0)(layerDist);
                                                    var idealY = sourceTop(v.value0)(node)(sortedLinks)(allNodes)(allLinks)(padding1);
                                                    return {
                                                        sum: acc.sum + idealY * v1,
                                                        totalWeight: acc.totalWeight + v1
                                                    };
                                                };
                                                if (v instanceof Data_Maybe.Nothing) {
                                                    return acc;
                                                };
                                                throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 665, column 13 - line 674, column 29): " + [ v.constructor.name ]);
                                            };
                                        })({
                                            sum: 0.0,
                                            totalWeight: 0.0
                                        })(sortedLinks);
                                        var $207 = result.totalWeight > 0.0;
                                        if ($207) {
                                            return result.sum / result.totalWeight;
                                        };
                                        return node.y0;
                                    };
                                };
                            };
                        };
                        var relaxLayer = function (currentNodes) {
                            return function (allLinks) {
                                return function (layerIdx) {
                                    return function (padding1) {
                                        return function (ascending) {
                                            return function (alpha) {
                                                return function (beta) {
                                                    var layerNodes = Data_Array.filter(function (n) {
                                                        return n.layer === layerIdx;
                                                    })(currentNodes);
                                                    var sortedLayerNodes = Data_Array.sortBy(function (a) {
                                                        return function (b) {
                                                            return compare(a.y0)(b.y0);
                                                        };
                                                    })(layerNodes);
                                                    var layerNodeIndices = map(function (v) {
                                                        return v.index;
                                                    })(sortedLayerNodes);
                                                    var nodesAfterRelax = Data_Array.foldl(function (nodes1) {
                                                        return function (nodeIdx) {
                                                            var v = Data_Array.find(function (n) {
                                                                return eq1(n.index)(nodeIdx);
                                                            })(nodes1);
                                                            if (v instanceof Data_Maybe.Nothing) {
                                                                return nodes1;
                                                            };
                                                            if (v instanceof Data_Maybe.Just) {
                                                                var weightedY = (function () {
                                                                    if (ascending) {
                                                                        return calculateWeightedFromSources(v.value0)(nodes1)(allLinks)(padding1);
                                                                    };
                                                                    return calculateWeightedFromTargets(v.value0)(nodes1)(allLinks)(padding1);
                                                                })();
                                                                var dy = (weightedY - v.value0.y0) * alpha;
                                                                var newY0 = v.value0.y0 + dy;
                                                                var newY1 = v.value0.y1 + dy;
                                                                var updatedNode = {
                                                                    color: v.value0.color,
                                                                    depth: v.value0.depth,
                                                                    index: v.value0.index,
                                                                    layer: v.value0.layer,
                                                                    name: v.value0.name,
                                                                    nodeHeight: v.value0.nodeHeight,
                                                                    sourceLinks: v.value0.sourceLinks,
                                                                    targetLinks: v.value0.targetLinks,
                                                                    value: v.value0.value,
                                                                    x0: v.value0.x0,
                                                                    x1: v.value0.x1,
                                                                    y0: newY0,
                                                                    y1: newY1
                                                                };
                                                                return map(function (n) {
                                                                    var $210 = eq1(n.index)(nodeIdx);
                                                                    if ($210) {
                                                                        return updatedNode;
                                                                    };
                                                                    return n;
                                                                })(nodes1);
                                                            };
                                                            throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 570, column 13 - line 587, column 82): " + [ v.constructor.name ]);
                                                        };
                                                    })(currentNodes)(layerNodeIndices);
                                                    var layerNodesUpdated = Data_Array.filter(function (n) {
                                                        return n.layer === layerIdx;
                                                    })(nodesAfterRelax);
                                                    var sorted = Data_Array.sortBy(function (a) {
                                                        return function (b) {
                                                            return compare(a.y0)(b.y0);
                                                        };
                                                    })(layerNodesUpdated);
                                                    var sortedWithTarget = map(function (node) {
                                                        return {
                                                            node: node,
                                                            targetY: node.y0
                                                        };
                                                    })(sorted);
                                                    var resolved = resolveCollisions(sortedWithTarget)(padding1)(y0)(y1)(beta);
                                                    return updateNodes(nodesAfterRelax)(resolved);
                                                };
                                            };
                                        };
                                    };
                                };
                            };
                        };
                        var relaxByLayer = function (currentNodes) {
                            return function (allLinks) {
                                return function (padding1) {
                                    return function (ascending) {
                                        return function (alpha) {
                                            return function (beta) {
                                                var maxLayer = Data_Array.foldl(function (acc) {
                                                    return function (node) {
                                                        return max(acc)(node.layer);
                                                    };
                                                })(0)(currentNodes);
                                                var layerIndices = (function () {
                                                    if (ascending) {
                                                        return Data_Array.range(1)(maxLayer);
                                                    };
                                                    return Data_Array.reverse(Data_Array.range(0)(maxLayer - 1 | 0));
                                                })();
                                                var relaxed = Data_Array.foldl(function (nodes1) {
                                                    return function (layerIdx) {
                                                        return relaxLayer(nodes1)(allLinks)(layerIdx)(padding1)(ascending)(alpha)(beta);
                                                    };
                                                })(currentNodes)(layerIndices);
                                                return relaxed;
                                            };
                                        };
                                    };
                                };
                            };
                        };
                        var $213 = config.iterations <= 0;
                        if ($213) {
                            return nodes;
                        };
                        return Data_Array.foldl(function (currentNodes) {
                            return function (i) {
                                var alpha = Data_Number.pow(0.99)(Data_Int.toNumber(i));
                                var beta = max1(1.0 - alpha)(Data_Int.toNumber(i + 1 | 0) / Data_Int.toNumber(config.iterations));
                                var rtl = relaxByLayer(currentNodes)(links)(padding)(false)(alpha)(beta);
                                var ltr = relaxByLayer(rtl)(links)(padding)(true)(alpha)(beta);
                                return ltr;
                            };
                        })(nodes)(Data_Array.range(0)(config.iterations - 1 | 0));
                    };
                };
            };
        };
    };
};
var computeNodeValues = /* #__PURE__ */ (function () {
    var setNodeValue = function (links) {
        return function (n) {
            var totalOut = Data_Array.foldl(function (sum) {
                return function (link) {
                    return sum + link.value;
                };
            })(0.0)(Data_Array.filter(function (l) {
                return eq1(l.sourceIndex)(n.index);
            })(links));
            var totalIn = Data_Array.foldl(function (sum) {
                return function (link) {
                    return sum + link.value;
                };
            })(0.0)(Data_Array.filter(function (l) {
                return eq1(l.targetIndex)(n.index);
            })(links));
            return {
                name: n.name,
                x0: n.x0,
                y0: n.y0,
                x1: n.x1,
                y1: n.y1,
                depth: n.depth,
                nodeHeight: n.nodeHeight,
                layer: n.layer,
                index: n.index,
                color: n.color,
                sourceLinks: n.sourceLinks,
                targetLinks: n.targetLinks,
                value: max1(totalIn)(totalOut)
            };
        };
    };
    return bind(get)(function (model) {
        var updatedNodes = map(setNodeValue(model.sankeyLinks))(model.sankeyNodes);
        return modify_(function (v) {
            var $214 = {};
            for (var $215 in v) {
                if ({}.hasOwnProperty.call(v, $215)) {
                    $214[$215] = v[$215];
                };
            };
            $214.sankeyNodes = updatedNodes;
            return $214;
        });
    });
})();
var computeNodeHeights = /* #__PURE__ */ (function () {
    var bfsHeight = function ($copy_nodes) {
        return function ($copy_height) {
            return function ($copy_current) {
                return function ($copy_maxHeight) {
                    var $tco_var_nodes = $copy_nodes;
                    var $tco_var_height = $copy_height;
                    var $tco_var_current = $copy_current;
                    var $tco_done = false;
                    var $tco_result;
                    function $tco_loop(nodes, height, current, maxHeight) {
                        if (Data_Set.isEmpty(current)) {
                            $tco_done = true;
                            return nodes;
                        };
                        if (height > maxHeight) {
                            $tco_done = true;
                            return nodes;
                        };
                        if (Data_Boolean.otherwise) {
                            var nodesWithHeight = map(function (node) {
                                var $221 = member(node.index)(current);
                                if ($221) {
                                    return {
                                        index: node.index,
                                        color: node.color,
                                        depth: node.depth,
                                        layer: node.layer,
                                        name: node.name,
                                        sourceLinks: node.sourceLinks,
                                        targetLinks: node.targetLinks,
                                        value: node.value,
                                        x0: node.x0,
                                        x1: node.x1,
                                        y0: node.y0,
                                        y1: node.y1,
                                        nodeHeight: height
                                    };
                                };
                                return node;
                            })(nodes);
                            var next = Data_Array.foldl(function (acc) {
                                return function (node) {
                                    var $222 = member(node.index)(current);
                                    if ($222) {
                                        return union(acc)(node.targetLinks);
                                    };
                                    return acc;
                                };
                            })(Data_Set.empty)(nodes);
                            $tco_var_nodes = nodesWithHeight;
                            $tco_var_height = height + 1 | 0;
                            $tco_var_current = next;
                            $copy_maxHeight = maxHeight;
                            return;
                        };
                        throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 262, column 3 - line 262, column 84): " + [ nodes.constructor.name, height.constructor.name, current.constructor.name, maxHeight.constructor.name ]);
                    };
                    while (!$tco_done) {
                        $tco_result = $tco_loop($tco_var_nodes, $tco_var_height, $tco_var_current, $copy_maxHeight);
                    };
                    return $tco_result;
                };
            };
        };
    };
    return bind(get)(function (model) {
        var n = Data_Array.length(model.sankeyNodes);
        var sinkNodes = Data_Array.filter(function (node) {
            return Data_Set.isEmpty(node.sourceLinks);
        })(model.sankeyNodes);
        var initialCurrent = fromFoldable(map(function (v) {
            return v.index;
        })(sinkNodes));
        var result = bfsHeight(model.sankeyNodes)(0)(initialCurrent)(n);
        return modify_(function (v) {
            var $223 = {};
            for (var $224 in v) {
                if ({}.hasOwnProperty.call(v, $224)) {
                    $223[$224] = v[$224];
                };
            };
            $223.sankeyNodes = result;
            return $223;
        });
    });
})();
var computeNodeDepths = /* #__PURE__ */ (function () {
    var bfsDepth = function ($copy_nodes) {
        return function ($copy_depth) {
            return function ($copy_current) {
                return function ($copy_maxDepth) {
                    var $tco_var_nodes = $copy_nodes;
                    var $tco_var_depth = $copy_depth;
                    var $tco_var_current = $copy_current;
                    var $tco_done = false;
                    var $tco_result;
                    function $tco_loop(nodes, depth, current, maxDepth) {
                        if (Data_Set.isEmpty(current)) {
                            $tco_done = true;
                            return nodes;
                        };
                        if (depth > maxDepth) {
                            $tco_done = true;
                            return nodes;
                        };
                        if (Data_Boolean.otherwise) {
                            var nodesWithDepth = map(function (node) {
                                var $230 = member(node.index)(current);
                                if ($230) {
                                    return {
                                        index: node.index,
                                        color: node.color,
                                        layer: node.layer,
                                        name: node.name,
                                        nodeHeight: node.nodeHeight,
                                        sourceLinks: node.sourceLinks,
                                        targetLinks: node.targetLinks,
                                        value: node.value,
                                        x0: node.x0,
                                        x1: node.x1,
                                        y0: node.y0,
                                        y1: node.y1,
                                        depth: depth
                                    };
                                };
                                return node;
                            })(nodes);
                            var next = Data_Array.foldl(function (acc) {
                                return function (node) {
                                    var $231 = member(node.index)(current);
                                    if ($231) {
                                        return union(acc)(node.sourceLinks);
                                    };
                                    return acc;
                                };
                            })(Data_Set.empty)(nodes);
                            $tco_var_nodes = nodesWithDepth;
                            $tco_var_depth = depth + 1 | 0;
                            $tco_var_current = next;
                            $copy_maxDepth = maxDepth;
                            return;
                        };
                        throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 220, column 3 - line 220, column 83): " + [ nodes.constructor.name, depth.constructor.name, current.constructor.name, maxDepth.constructor.name ]);
                    };
                    while (!$tco_done) {
                        $tco_result = $tco_loop($tco_var_nodes, $tco_var_depth, $tco_var_current, $copy_maxDepth);
                    };
                    return $tco_result;
                };
            };
        };
    };
    return bind(get)(function (model) {
        var n = Data_Array.length(model.sankeyNodes);
        var sourceNodes = Data_Array.filter(function (node) {
            return Data_Set.isEmpty(node.targetLinks);
        })(model.sankeyNodes);
        var initialCurrent = fromFoldable(map(function (v) {
            return v.index;
        })(sourceNodes));
        var result = bfsDepth(model.sankeyNodes)(0)(initialCurrent)(n);
        return modify_(function (v) {
            var $232 = {};
            for (var $233 in v) {
                if ({}.hasOwnProperty.call(v, $233)) {
                    $232[$233] = v[$233];
                };
            };
            $232.sankeyNodes = result;
            return $232;
        });
    });
})();
var computeLinkBreadths = /* #__PURE__ */ (function () {
    var calculateLinkYPositions = function (nodes) {
        return function (links) {
            var linksWithY0 = Data_Array.foldl(function (currentLinks) {
                return function (node) {
                    var outgoingLinks = Data_Array.filter(function (link) {
                        return eq1(link.sourceIndex)(node.index);
                    })(currentLinks);
                    var sorted = Data_Array.sortBy(function (a) {
                        return function (b) {
                            var v = Data_Array.find(function (n) {
                                return eq1(n.index)(b.targetIndex);
                            })(nodes);
                            var v1 = Data_Array.find(function (n) {
                                return eq1(n.index)(a.targetIndex);
                            })(nodes);
                            if (v1 instanceof Data_Maybe.Just && v instanceof Data_Maybe.Just) {
                                return append1(compare(v1.value0.y0)(v.value0.y0))(compare1(a.index)(b.index));
                            };
                            return compare1(a.index)(b.index);
                        };
                    })(outgoingLinks);
                    var withY0 = Data_Array.foldl(function (acc) {
                        return function (link) {
                            var y = acc.y + link.width / 2.0;
                            var updated = {
                                width: link.width,
                                index: link.index,
                                sourceIndex: link.sourceIndex,
                                targetIndex: link.targetIndex,
                                color: link.color,
                                value: link.value,
                                y1: link.y1,
                                y0: y
                            };
                            return {
                                y: acc.y + link.width,
                                links: Data_Array.snoc(acc.links)(updated)
                            };
                        };
                    })({
                        y: node.y0,
                        links: [  ]
                    })(sorted);
                    return map(function (link) {
                        var v = Data_Array.find(function (l) {
                            return eq2(l.index)(link.index);
                        })(withY0.links);
                        if (v instanceof Data_Maybe.Just) {
                            return v.value0;
                        };
                        if (v instanceof Data_Maybe.Nothing) {
                            return link;
                        };
                        throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 988, column 21 - line 990, column 38): " + [ v.constructor.name ]);
                    })(currentLinks);
                };
            })(links)(nodes);
            var linksWithY1 = Data_Array.foldl(function (currentLinks) {
                return function (node) {
                    var incomingLinks = Data_Array.filter(function (link) {
                        return eq1(link.targetIndex)(node.index);
                    })(currentLinks);
                    var sorted = Data_Array.sortBy(function (a) {
                        return function (b) {
                            var v = Data_Array.find(function (n) {
                                return eq1(n.index)(b.sourceIndex);
                            })(nodes);
                            var v1 = Data_Array.find(function (n) {
                                return eq1(n.index)(a.sourceIndex);
                            })(nodes);
                            if (v1 instanceof Data_Maybe.Just && v instanceof Data_Maybe.Just) {
                                return append1(compare(v1.value0.y0)(v.value0.y0))(compare1(a.index)(b.index));
                            };
                            return compare1(a.index)(b.index);
                        };
                    })(incomingLinks);
                    var withY1 = Data_Array.foldl(function (acc) {
                        return function (link) {
                            var y = acc.y + link.width / 2.0;
                            var updated = {
                                width: link.width,
                                index: link.index,
                                sourceIndex: link.sourceIndex,
                                targetIndex: link.targetIndex,
                                color: link.color,
                                value: link.value,
                                y0: link.y0,
                                y1: y
                            };
                            return {
                                y: acc.y + link.width,
                                links: Data_Array.snoc(acc.links)(updated)
                            };
                        };
                    })({
                        y: node.y0,
                        links: [  ]
                    })(sorted);
                    return map(function (link) {
                        var v = Data_Array.find(function (l) {
                            return eq2(l.index)(link.index);
                        })(withY1.links);
                        if (v instanceof Data_Maybe.Just) {
                            return v.value0;
                        };
                        if (v instanceof Data_Maybe.Nothing) {
                            return link;
                        };
                        throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 1029, column 21 - line 1031, column 38): " + [ v.constructor.name ]);
                    })(currentLinks);
                };
            })(linksWithY0)(nodes);
            return linksWithY1;
        };
    };
    var calculateGlobalKy1 = function (nodes) {
        return function (y0) {
            return function (y1) {
                return function (padding) {
                    var scaleForLayer = function (layerNodes) {
                        var totalValue = Data_Array.foldl(function (sum) {
                            return function (node) {
                                return sum + node.value;
                            };
                        })(0.0)(layerNodes);
                        var numNodes = Data_Int.toNumber(Data_Array.length(layerNodes));
                        var availableHeight = y1 - y0 - (numNodes - 1.0) * padding;
                        var $247 = totalValue > 0.0;
                        if ($247) {
                            return availableHeight / totalValue;
                        };
                        return 1.0;
                    };
                    var maxLayer = Data_Array.foldl(function (acc) {
                        return function (node) {
                            return max(acc)(node.layer);
                        };
                    })(0)(nodes);
                    var layers = map(function (layerIdx) {
                        return Data_Array.filter(function (node) {
                            return node.layer === layerIdx;
                        })(nodes);
                    })(Data_Array.range(0)(maxLayer));
                    var scales = map(scaleForLayer)(layers);
                    var nonEmptyScales = Data_Array.filter(function (s) {
                        return s > 0.0;
                    })(scales);
                    var v = Data_Array.head(nonEmptyScales);
                    if (v instanceof Data_Maybe.Just) {
                        return Data_Array.foldl(min)(v.value0)(nonEmptyScales);
                    };
                    if (v instanceof Data_Maybe.Nothing) {
                        return 1.0;
                    };
                    throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 948, column 7 - line 950, column 23): " + [ v.constructor.name ]);
                };
            };
        };
    };
    return bind(get)(function (model) {
        var ky = calculateGlobalKy1(model.sankeyNodes)(model.config.extent.y0)(model.config.extent.y1)(model.config.nodePadding);
        var linksWithWidth = map(function (link) {
            return {
                value: link.value,
                color: link.color,
                index: link.index,
                sourceIndex: link.sourceIndex,
                targetIndex: link.targetIndex,
                y0: link.y0,
                y1: link.y1,
                width: link.value * ky
            };
        })(model.sankeyLinks);
        var linksWithY = calculateLinkYPositions(model.sankeyNodes)(linksWithWidth);
        var v = Effect_Unsafe.unsafePerformEffect(function __do() {
            Effect_Console.log("\x0a=== After computeLinkBreadths ===")();
            return for_(linksWithY)(function (link) {
                var v1 = Data_Array.find(function (n) {
                    return eq1(n.index)(link.targetIndex);
                })(model.sankeyNodes);
                var v2 = Data_Array.find(function (n) {
                    return eq1(n.index)(link.sourceIndex);
                })(model.sankeyNodes);
                if (v2 instanceof Data_Maybe.Just && v1 instanceof Data_Maybe.Just) {
                    return Effect_Console.log("  " + (v2.value0.name + (" -> " + (v1.value0.name + (" | y0=" + (show(link.y0) + (" | y1=" + (show(link.y1) + (" | width=" + show(link.width))))))))));
                };
                return pure(Data_Unit.unit);
            })();
        });
        return modify_(function (v1) {
            var $254 = {};
            for (var $255 in v1) {
                if ({}.hasOwnProperty.call(v1, $255)) {
                    $254[$255] = v1[$255];
                };
            };
            $254.sankeyLinks = linksWithY;
            return $254;
        });
    });
})();
var calculateGlobalKy = function (nodes) {
    return function (y0) {
        return function (y1) {
            return function (padding) {
                var scaleForLayer = function (layerNodes) {
                    var totalValue = Data_Array.foldl(function (sum) {
                        return function (node) {
                            return sum + node.value;
                        };
                    })(0.0)(layerNodes);
                    var numNodes = Data_Int.toNumber(Data_Array.length(layerNodes));
                    var availableHeight = y1 - y0 - (numNodes - 1.0) * padding;
                    var $257 = totalValue > 0.0;
                    if ($257) {
                        return availableHeight / totalValue;
                    };
                    return 1.0;
                };
                var maxLayer = Data_Array.foldl(function (acc) {
                    return function (node) {
                        return max(acc)(node.layer);
                    };
                })(0)(nodes);
                var layers = map(function (layerIdx) {
                    return Data_Array.filter(function (node) {
                        return node.layer === layerIdx;
                    })(nodes);
                })(Data_Array.range(0)(maxLayer));
                var scales = map(scaleForLayer)(layers);
                var nonEmptyScales = Data_Array.filter(function (s) {
                    return s > 0.0;
                })(scales);
                var v = Data_Array.head(nonEmptyScales);
                if (v instanceof Data_Maybe.Just) {
                    return Data_Array.foldl(min)(v.value0)(nonEmptyScales);
                };
                if (v instanceof Data_Maybe.Nothing) {
                    return 1.0;
                };
                throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 311, column 5 - line 313, column 21): " + [ v.constructor.name ]);
            };
        };
    };
};
var assignColors = /* #__PURE__ */ bind(get)(function (model) {
    var colors = [ "#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd", "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf" ];
    var nodesWithColor = Data_Array.mapWithIndex(function (i) {
        return function (node) {
            return {
                depth: node.depth,
                index: node.index,
                layer: node.layer,
                name: node.name,
                nodeHeight: node.nodeHeight,
                sourceLinks: node.sourceLinks,
                targetLinks: node.targetLinks,
                value: node.value,
                x0: node.x0,
                x1: node.x1,
                y0: node.y0,
                y1: node.y1,
                color: Data_Maybe.fromMaybe("#999")(Data_Array.index(colors)(mod(i)(Data_Array.length(colors))))
            };
        };
    })(model.sankeyNodes);
    var assignLinkColor = function (nodes) {
        return function (mode) {
            return function (link) {
                if (mode instanceof DataViz_Layout_Sankey_Types.SourceColor) {
                    var sourceNode = Data_Array.find(function (n) {
                        return eq1(n.index)(link.sourceIndex);
                    })(nodes);
                    return {
                        sourceIndex: link.sourceIndex,
                        targetIndex: link.targetIndex,
                        value: link.value,
                        width: link.width,
                        y0: link.y0,
                        y1: link.y1,
                        index: link.index,
                        color: Data_Maybe.maybe("#999")(function (n) {
                            return n.color;
                        })(sourceNode)
                    };
                };
                if (mode instanceof DataViz_Layout_Sankey_Types.TargetColor) {
                    var targetNode = Data_Array.find(function (n) {
                        return eq1(n.index)(link.targetIndex);
                    })(nodes);
                    return {
                        sourceIndex: link.sourceIndex,
                        targetIndex: link.targetIndex,
                        value: link.value,
                        width: link.width,
                        y0: link.y0,
                        y1: link.y1,
                        index: link.index,
                        color: Data_Maybe.maybe("#999")(function (n) {
                            return n.color;
                        })(targetNode)
                    };
                };
                if (mode instanceof DataViz_Layout_Sankey_Types.SourceTargetGradient) {
                    return {
                        sourceIndex: link.sourceIndex,
                        targetIndex: link.targetIndex,
                        value: link.value,
                        width: link.width,
                        y0: link.y0,
                        y1: link.y1,
                        index: link.index,
                        color: "url(#sankey-gradient-" + (show1(link.index) + ")")
                    };
                };
                if (mode instanceof DataViz_Layout_Sankey_Types.StaticColor) {
                    return {
                        sourceIndex: link.sourceIndex,
                        targetIndex: link.targetIndex,
                        value: link.value,
                        width: link.width,
                        y0: link.y0,
                        y1: link.y1,
                        index: link.index,
                        color: mode.value0
                    };
                };
                throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 1074, column 7 - line 1089, column 29): " + [ mode.constructor.name ]);
            };
        };
    };
    var linksWithColor = map(assignLinkColor(nodesWithColor)(model.config.linkColorMode))(model.sankeyLinks);
    return modify_(function (v) {
        var $263 = {};
        for (var $264 in v) {
            if ({}.hasOwnProperty.call(v, $264)) {
                $263[$264] = v[$264];
            };
        };
        $263.sankeyNodes = nodesWithColor;
        $263.sankeyLinks = linksWithColor;
        return $263;
    });
});
var alignNodeToLayer = function (alignment) {
    return function (node) {
        return function (numLayers) {
            if (alignment instanceof DataViz_Layout_Sankey_Types.Left) {
                return node.depth;
            };
            if (alignment instanceof DataViz_Layout_Sankey_Types.Right) {
                return max(0)((numLayers - 1 | 0) - node.nodeHeight | 0);
            };
            if (alignment instanceof DataViz_Layout_Sankey_Types.Justify) {
                var $267 = Data_Set.isEmpty(node.sourceLinks);
                if ($267) {
                    return numLayers - 1 | 0;
                };
                return node.depth;
            };
            if (alignment instanceof DataViz_Layout_Sankey_Types.Center) {
                var $268 = !Data_Set.isEmpty(node.targetLinks);
                if ($268) {
                    return node.depth;
                };
                return 0;
            };
            throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 412, column 3 - line 422, column 13): " + [ alignment.constructor.name ]);
        };
    };
};
var computeNodeLayers = function (nodes) {
    return function (config) {
        return function (x0) {
            return function (x1) {
                var maxDepth = Data_Array.foldl(function (acc) {
                    return function (node) {
                        return max(acc)(node.depth);
                    };
                })(0)(nodes);
                var numLayers = maxDepth + 1 | 0;
                var nodesWithLayer = map(function (node) {
                    var layer = alignNodeToLayer(config.alignment)(node)(numLayers);
                    return {
                        color: node.color,
                        depth: node.depth,
                        index: node.index,
                        name: node.name,
                        nodeHeight: node.nodeHeight,
                        sourceLinks: node.sourceLinks,
                        targetLinks: node.targetLinks,
                        value: node.value,
                        x0: node.x0,
                        x1: node.x1,
                        y0: node.y0,
                        y1: node.y1,
                        layer: layer
                    };
                })(nodes);
                var kx = (x1 - x0 - config.nodeWidth) / max1(1.0)(Data_Int.toNumber(numLayers - 1 | 0));
                var nodesWithX = map(function (node) {
                    var x0Pos = x0 + Data_Int.toNumber(node.layer) * kx;
                    return {
                        layer: node.layer,
                        color: node.color,
                        depth: node.depth,
                        index: node.index,
                        name: node.name,
                        nodeHeight: node.nodeHeight,
                        sourceLinks: node.sourceLinks,
                        targetLinks: node.targetLinks,
                        value: node.value,
                        y0: node.y0,
                        y1: node.y1,
                        x0: x0Pos,
                        x1: x0Pos + config.nodeWidth
                    };
                })(nodesWithLayer);
                return nodesWithX;
            };
        };
    };
};
var computeNodeBreadths = /* #__PURE__ */ bind(get)(function (model) {
    var nodesWithLayers = computeNodeLayers(model.sankeyNodes)(model.config)(model.config.extent.x0)(model.config.extent.x1);
    var totalHeight = model.config.extent.y1 - model.config.extent.y0;
    var maxLayer = Data_Array.foldl(function (acc) {
        return function (node) {
            return max(acc)(node.layer);
        };
    })(0)(nodesWithLayers);
    var layers = map(function (layerIdx) {
        return Data_Array.filter(function (node) {
            return node.layer === layerIdx;
        })(nodesWithLayers);
    })(Data_Array.range(0)(maxLayer));
    var maxNodesInLayer = Data_Array.foldl(function (acc) {
        return function (layer) {
            return max(acc)(Data_Array.length(layer));
        };
    })(0)(layers);
    var adjustedPadding = (function () {
        var $269 = maxNodesInLayer > 1;
        if ($269) {
            return min(model.config.nodePadding)(totalHeight / (Data_Int.toNumber(maxNodesInLayer) - 1.0));
        };
        return model.config.nodePadding;
    })();
    var nodesWithY = initializeNodeBreadths(nodesWithLayers)(model.sankeyLinks)(model.config)(adjustedPadding)(model.config.extent.y0)(model.config.extent.y1);
    var ky = calculateGlobalKy(nodesWithY)(model.config.extent.y0)(model.config.extent.y1)(adjustedPadding);
    var linksWithWidth = map(function (link) {
        return {
            value: link.value,
            color: link.color,
            index: link.index,
            sourceIndex: link.sourceIndex,
            targetIndex: link.targetIndex,
            y0: link.y0,
            y1: link.y1,
            width: link.value * ky
        };
    })(model.sankeyLinks);
    var v = Effect_Unsafe.unsafePerformEffect(function __do() {
        Effect_Console.log("\x0a=== After initializeNodeBreadths (ky=" + (show(ky) + (", adjustedPadding=" + (show(adjustedPadding) + ") ==="))))();
        var maxLayer$prime = Data_Array.foldl(function (acc) {
            return function (node) {
                return max(acc)(node.layer);
            };
        })(0)(nodesWithY);
        return for_(Data_Array.range(0)(maxLayer$prime))(function (layerIdx) {
            var layerNodes = Data_Array.sortBy(function (a) {
                return function (b) {
                    return compare(a.y0)(b.y0);
                };
            })(Data_Array.filter(function (n) {
                return n.layer === layerIdx;
            })(nodesWithY));
            return function __do() {
                Effect_Console.log("  Layer " + (show1(layerIdx) + ":"))();
                return for_(layerNodes)(function (n) {
                    return Effect_Console.log("    " + (n.name + (" | y0=" + (show(n.y0) + (" | y1=" + (show(n.y1) + (" | value=" + show(n.value))))))));
                })();
            };
        })();
    });
    var relaxedNodes = relaxation(nodesWithY)(linksWithWidth)(model.config)(adjustedPadding)(model.config.extent.y0)(model.config.extent.y1);
    var v1 = Effect_Unsafe.unsafePerformEffect(function __do() {
        (function () {
            var v2 = Data_Array.find(function (n) {
                return n.name === "Nuclear";
            })(relaxedNodes);
            if (v2 instanceof Data_Maybe.Just) {
                return Effect_Console.log("AFTER relaxation - Nuclear: y0=" + (show(v2.value0.y0) + (", y1=" + show(v2.value0.y1))))();
            };
            if (v2 instanceof Data_Maybe.Nothing) {
                return Data_Unit.unit;
            };
            throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 366, column 7 - line 368, column 29): " + [ v2.constructor.name ]);
        })();
        (function () {
            var v2 = Data_Array.find(function (n) {
                return n.name === "Thermal generation";
            })(relaxedNodes);
            if (v2 instanceof Data_Maybe.Just) {
                return Effect_Console.log("AFTER relaxation - Thermal generation: y0=" + (show(v2.value0.y0) + (", y1=" + show(v2.value0.y1))))();
            };
            if (v2 instanceof Data_Maybe.Nothing) {
                return Data_Unit.unit;
            };
            throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 369, column 7 - line 371, column 29): " + [ v2.constructor.name ]);
        })();
        var v2 = Data_Array.find(function (n) {
            return n.name === "Losses";
        })(relaxedNodes);
        if (v2 instanceof Data_Maybe.Just) {
            return Effect_Console.log("AFTER relaxation - Losses: y0=" + (show(v2.value0.y0) + (", y1=" + show(v2.value0.y1))))();
        };
        if (v2 instanceof Data_Maybe.Nothing) {
            return Data_Unit.unit;
        };
        throw new Error("Failed pattern match at DataViz.Layout.Sankey.Compute (line 372, column 7 - line 374, column 29): " + [ v2.constructor.name ]);
    });
    return modify_(function (v2) {
        var $276 = {};
        for (var $277 in v2) {
            if ({}.hasOwnProperty.call(v2, $277)) {
                $276[$277] = v2[$277];
            };
        };
        $276.sankeyNodes = relaxedNodes;
        $276.sankeyLinks = linksWithWidth;
        return $276;
    });
});
var computeLayoutWithConfig = function (linkInputs) {
    return function (config) {
        var logStep = function (stepName) {
            return bind(get)(function (model) {
                var v = Effect_Unsafe.unsafePerformEffect(function __do() {
                    Effect_Console.log("\x0a=== " + (stepName + " ==="))();
                    return for_(Data_Array.sortBy(function (a) {
                        return function (b) {
                            return compare2(a.name)(b.name);
                        };
                    })(model.sankeyNodes))(function (n) {
                        return Effect_Console.log("  " + (n.name + (" | layer=" + (show1(n.layer) + (" | depth=" + (show1(n.depth) + (" | height=" + (show1(n.nodeHeight) + (" | value=" + (show(n.value) + (" | y0=" + (show(n.y0) + (" | y1=" + show(n.y1))))))))))))));
                    })();
                });
                return pure1(Data_Unit.unit);
            });
        };
        var computeSankeyLayout = discard2(for_1(linkInputs)(processCSVLink))(function () {
            return discard2(initialiseSankeyNodes)(function () {
                return discard2(logStep("After initialiseSankeyNodes (nodeLinks)"))(function () {
                    return discard2(computeNodeValues)(function () {
                        return discard2(logStep("After computeNodeValues"))(function () {
                            return discard2(computeNodeDepths)(function () {
                                return discard2(logStep("After computeNodeDepths"))(function () {
                                    return discard2(computeNodeHeights)(function () {
                                        return discard2(logStep("After computeNodeHeights"))(function () {
                                            return discard2(computeNodeBreadths)(function () {
                                                return discard2(logStep("After computeNodeBreadths (FINAL)"))(function () {
                                                    return discard2(computeLinkBreadths)(function () {
                                                        return assignColors;
                                                    });
                                                });
                                            });
                                        });
                                    });
                                });
                            });
                        });
                    });
                });
            });
        });
        var finalModel = Control_Monad_State.execState(computeSankeyLayout)(DataViz_Layout_Sankey_Types.initialSankeyGraphModel(config));
        return {
            nodes: finalModel.sankeyNodes,
            links: finalModel.sankeyLinks
        };
    };
};
var computeLayout = function (linkInputs) {
    return function (width) {
        return function (height) {
            return computeLayoutWithConfig(linkInputs)(DataViz_Layout_Sankey_Types.defaultSankeyConfig(width)(height));
        };
    };
};
export {
    epsilon,
    computeLayout,
    computeLayoutWithConfig
};
//# sourceMappingURL=index.js.map
