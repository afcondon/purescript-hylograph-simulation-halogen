// Generated by purs version 0.15.15
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Control_Bind from "../Control.Bind/index.js";
import * as Control_Comonad_Cofree from "../Control.Comonad.Cofree/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Function from "../Data.Function/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Graph_Layout from "../Data.Graph.Layout/index.js";
import * as Data_Int from "../Data.Int/index.js";
import * as Data_List from "../Data.List/index.js";
import * as Data_List_Types from "../Data.List.Types/index.js";
import * as Data_Map_Internal from "../Data.Map.Internal/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Semigroup from "../Data.Semigroup/index.js";
import * as Data_Tree from "../Data.Tree/index.js";
import * as Data_Unfoldable from "../Data.Unfoldable/index.js";
var bind = /* #__PURE__ */ Control_Bind.bind(Data_Maybe.bindMaybe);
var pure = /* #__PURE__ */ Control_Applicative.pure(Data_Maybe.applicativeMaybe);
var foldl = /* #__PURE__ */ Data_Foldable.foldl(Data_Foldable.foldableArray);
var max = /* #__PURE__ */ Data_Ord.max(Data_Ord.ordInt);
var map = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var toUnfoldable = /* #__PURE__ */ Data_List.toUnfoldable(Data_Unfoldable.unfoldableArray);
var append = /* #__PURE__ */ Data_Semigroup.append(Data_Semigroup.semigroupArray);
var resolveExtraLinks = function (dictOrd) {
    var lookup = Data_Map_Internal.lookup(dictOrd);
    return function (links) {
        return function (nodeMap) {
            var resolve = function (link) {
                return bind(lookup(link.source)(nodeMap))(function (source) {
                    return bind(lookup(link.target)(nodeMap))(function (target) {
                        return pure({
                            source: source,
                            target: target,
                            linkType: link.linkType
                        });
                    });
                });
            };
            return Data_Array.mapMaybe(resolve)(links);
        };
    };
};
var maxDepth = function (tree) {
    var go = function (d) {
        return function (t) {
            var children = Control_Comonad_Cofree.tail(t);
            var v = Data_List.uncons(children);
            if (v instanceof Data_Maybe.Nothing) {
                return d;
            };
            if (v instanceof Data_Maybe.Just) {
                return foldl(max)(d)(map(go(d + 1 | 0))(toUnfoldable(children)));
            };
            throw new Error("Failed pattern match at PSD3.Data.DAGTree (line 251, column 10 - line 253, column 89): " + [ v.constructor.name ]);
        };
    };
    return go(0)(tree);
};
var layoutTree = function (layout) {
    return function (size) {
        return function (tree) {
            var go = function (depth) {
                return function (xMin) {
                    return function (xMax) {
                        return function (t) {
                            var xFraction = (xMin + xMax) / 2.0;
                            var y = (function () {
                                if (layout instanceof Data_Graph_Layout.Vertical) {
                                    return Data_Int.toNumber(depth) * (size.height / Data_Int.toNumber(maxDepth(tree) + 1 | 0));
                                };
                                if (layout instanceof Data_Graph_Layout.Horizontal) {
                                    return xFraction * size.height;
                                };
                                if (layout instanceof Data_Graph_Layout.Radial) {
                                    return Data_Int.toNumber(depth) * 50.0;
                                };
                                throw new Error("Failed pattern match at PSD3.Data.DAGTree (line 220, column 13 - line 223, column 44): " + [ layout.constructor.name ]);
                            })();
                            var x = (function () {
                                if (layout instanceof Data_Graph_Layout.Vertical) {
                                    return xFraction * size.width;
                                };
                                if (layout instanceof Data_Graph_Layout.Horizontal) {
                                    return Data_Int.toNumber(depth) * (size.width / Data_Int.toNumber(maxDepth(tree) + 1 | 0));
                                };
                                if (layout instanceof Data_Graph_Layout.Radial) {
                                    return xFraction * size.width;
                                };
                                throw new Error("Failed pattern match at PSD3.Data.DAGTree (line 216, column 13 - line 219, column 43): " + [ layout.constructor.name ]);
                            })();
                            var datum = Control_Comonad_Cofree.head(t);
                            var positioned = {
                                datum: datum,
                                x: x,
                                y: y,
                                depth: depth
                            };
                            var children = Control_Comonad_Cofree.tail(t);
                            var childCount = Data_List.length(children);
                            var childWidth = (xMax - xMin) / Data_Int.toNumber(max(1)(childCount));
                            var layoutChildren = function (v) {
                                return function (v1) {
                                    if (v1 instanceof Data_List_Types.Nil) {
                                        return Data_List_Types.Nil.value;
                                    };
                                    if (v1 instanceof Data_List_Types.Cons) {
                                        var childXMin = xMin + Data_Int.toNumber(v) * childWidth;
                                        var childXMax = childXMin + childWidth;
                                        var positioned$prime = go(depth + 1 | 0)(childXMin)(childXMax)(v1.value0);
                                        return new Data_List_Types.Cons(positioned$prime, layoutChildren(v + 1 | 0)(v1.value1));
                                    };
                                    throw new Error("Failed pattern match at PSD3.Data.DAGTree (line 231, column 9 - line 231, column 89): " + [ v.constructor.name, v1.constructor.name ]);
                                };
                            };
                            var positionedChildren = layoutChildren(0)(children);
                            return Data_Tree.mkTree(positioned)(positionedChildren);
                        };
                    };
                };
            };
            return go(0)(0.0)(1.0)(tree);
        };
    };
};
var getNodePosition = function (dictOrd) {
    var lookup = Data_Map_Internal.lookup(dictOrd);
    return function (nodeId) {
        return function (dag) {
            return bind(lookup(nodeId)(dag.nodeMap))(function (node) {
                return pure({
                    x: node.x,
                    y: node.y
                });
            });
        };
    };
};
var getExtraLinkPositions = function (dag) {
    var toPositions = function (link) {
        return {
            sourceX: link.source.x,
            sourceY: link.source.y,
            targetX: link.target.x,
            targetY: link.target.y,
            linkType: link.linkType
        };
    };
    return map(toPositions)(dag.extraLinks);
};
var flattenPositioned = function (tree) {
    var go = function (acc) {
        return function (t) {
            var node = Control_Comonad_Cofree.head(t);
            var children = Control_Comonad_Cofree.tail(t);
            var childArray = toUnfoldable(children);
            return append(acc)(append([ node ])(Data_Array.concatMap(go([  ]))(childArray)));
        };
    };
    return go([  ])(tree);
};
var dagTree = function (dictOrd) {
    return function (tree) {
        return function (getId) {
            return {
                tree: tree,
                extraLinks: [  ],
                getId: getId
            };
        };
    };
};
var buildTreeLinks = function (tree) {
    var go = function (acc) {
        return function (t) {
            var parent = Control_Comonad_Cofree.head(t);
            var children = Control_Comonad_Cofree.tail(t);
            var childArray = toUnfoldable(children);
            var childLinks = Data_Array.concatMap(go([  ]))(childArray);
            var newLinks = map(function (child) {
                return {
                    source: parent,
                    target: Control_Comonad_Cofree.head(child)
                };
            })(childArray);
            return append(acc)(append(newLinks)(childLinks));
        };
    };
    return go([  ])(tree);
};
var buildNodeMap = function (dictOrd) {
    var insert = Data_Map_Internal.insert(dictOrd);
    return function (getId) {
        return function (tree) {
            var go = function (acc) {
                return function (t) {
                    var node = Control_Comonad_Cofree.head(t);
                    var nodeId = getId(node.datum);
                    var children = Control_Comonad_Cofree.tail(t);
                    var acc$prime = insert(nodeId)(node)(acc);
                    return foldl(go)(acc$prime)(toUnfoldable(children));
                };
            };
            return go(Data_Map_Internal.empty)(tree);
        };
    };
};
var layoutDAGTree = function (dictOrd) {
    var buildNodeMap1 = buildNodeMap(dictOrd);
    var resolveExtraLinks1 = resolveExtraLinks(dictOrd);
    return function (layout) {
        return function (size) {
            return function (dag) {
                var positioned = layoutTree(layout)(size)(dag.tree);
                var treeLinks = buildTreeLinks(positioned);
                var nodeMap = buildNodeMap1(dag.getId)(positioned);
                var extraLinks = resolveExtraLinks1(dag.extraLinks)(nodeMap);
                return {
                    nodes: flattenPositioned(positioned),
                    treeLinks: treeLinks,
                    extraLinks: extraLinks,
                    nodeMap: nodeMap
                };
            };
        };
    };
};
var addLink = function (link) {
    return function (dag) {
        return {
            tree: dag.tree,
            getId: dag.getId,
            extraLinks: Data_Array.snoc(dag.extraLinks)(link)
        };
    };
};
var addLinks = function (dictFoldable) {
    var foldl1 = Data_Foldable.foldl(dictFoldable);
    return function (links) {
        return function (dag) {
            return foldl1(Data_Function.flip(addLink))(dag)(links);
        };
    };
};
export {
    dagTree,
    addLink,
    addLinks,
    layoutDAGTree,
    getNodePosition,
    getExtraLinkPositions
};
//# sourceMappingURL=index.js.map
