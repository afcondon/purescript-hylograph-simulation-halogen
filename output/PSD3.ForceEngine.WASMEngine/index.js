// Generated by purs version 0.15.15
import * as $foreign from "./foreign.js";
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Foldable from "../Data.Foldable/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as Data_Traversable from "../Data.Traversable/index.js";
import * as Data_Tuple from "../Data.Tuple/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Effect from "../Effect/index.js";
import * as Effect_Ref from "../Effect.Ref/index.js";
import * as Foreign_Object from "../Foreign.Object/index.js";
import * as PSD3_ForceEngine_WASM from "../PSD3.ForceEngine.WASM/index.js";
var show = /* #__PURE__ */ Data_Show.show(Data_Show.showInt);
var map = /* #__PURE__ */ Data_Functor.map(Data_Functor.functorArray);
var pure = /* #__PURE__ */ Control_Applicative.pure(Effect.applicativeEffect);
var $$void = /* #__PURE__ */ Data_Functor["void"](Effect.functorEffect);
var traverse = /* #__PURE__ */ Data_Traversable.traverse(Data_Traversable.traversableArray)(Effect.applicativeEffect);
var fromFoldable = /* #__PURE__ */ Foreign_Object.fromFoldable(Data_Foldable.foldableArray);
var updateNodePosition = function (positions) {
    return function (node) {
        var v = Foreign_Object.lookup(show(node.id))(positions);
        if (v instanceof Data_Maybe.Just) {
            var $28 = {};
            for (var $29 in node) {
                if ({}.hasOwnProperty.call(node, $29)) {
                    $28[$29] = node[$29];
                };
            };
            $28.x = v.value0.x;
            $28.y = v.value0.y;
            return $28;
        };
        if (v instanceof Data_Maybe.Nothing) {
            return node;
        };
        throw new Error("Failed pattern match at PSD3.ForceEngine.WASMEngine (line 278, column 3 - line 280, column 20): " + [ v.constructor.name ]);
    };
};
var updatePositions = function (sim) {
    return function (positions) {
        return function __do() {
            var nodes = Effect_Ref.read(sim.nodesRef)();
            var updatedNodes = map(updateNodePosition(positions))(nodes);
            Effect_Ref.write(updatedNodes)(sim.nodesRef)();
            return PSD3_ForceEngine_WASM.syncPositionsToWasm(sim.wasmSim)(updatedNodes)();
        };
    };
};
var tickN = function (n) {
    return function (sim) {
        return function __do() {
            var alpha = PSD3_ForceEngine_WASM.tickN(sim.wasmSim)(n)();
            var nodes = Effect_Ref.read(sim.nodesRef)();
            var updatedNodes = PSD3_ForceEngine_WASM.syncPositionsFromWasm(sim.wasmSim)(nodes)();
            Effect_Ref.write(updatedNodes)(sim.nodesRef)();
            return alpha;
        };
    };
};
var tick = function (sim) {
    return function __do() {
        var alpha = PSD3_ForceEngine_WASM.tick(sim.wasmSim)();
        var nodes = Effect_Ref.read(sim.nodesRef)();
        var updatedNodes = PSD3_ForceEngine_WASM.syncPositionsFromWasm(sim.wasmSim)(nodes)();
        Effect_Ref.write(updatedNodes)(sim.nodesRef)();
        return alpha;
    };
};
var syncFixedNodes = function (wasmSim) {
    return function (nodes) {
        var syncFixedNode = function (wasm) {
            return function (v) {
                var $34 = $foreign["isFinite"](v.value1.fx) && $foreign["isFinite"](v.value1.fy);
                if ($34) {
                    return PSD3_ForceEngine_WASM.fixNode(wasm)(v.value0)(v.value1.fx)(v.value1.fy);
                };
                return PSD3_ForceEngine_WASM.unfixNode(wasm)(v.value0);
            };
        };
        var indexed = Data_Array.mapWithIndex(Data_Tuple.Tuple.create)(nodes);
        return $$void(traverse(syncFixedNode(wasmSim))(indexed));
    };
};
var setNodes = function (nodes) {
    return function (sim) {
        return function __do() {
            PSD3_ForceEngine_WASM.setNodeCount(sim.wasmSim)(Data_Array.length(nodes))();
            PSD3_ForceEngine_WASM.syncPositionsToWasm(sim.wasmSim)(nodes)();
            return Effect_Ref.write(nodes)(sim.nodesRef)();
        };
    };
};
var setLinks = function (links) {
    return function (sim) {
        return function __do() {
            PSD3_ForceEngine_WASM.setLinksFromRecords(sim.wasmSim)(links)();
            return Effect_Ref.write(links)(sim.linksRef)();
        };
    };
};
var reheat = function (sim) {
    return PSD3_ForceEngine_WASM.reheat(sim.wasmSim);
};
var isWasmReady = PSD3_ForceEngine_WASM.isWasmReady;
var isRunning = function (sim) {
    return PSD3_ForceEngine_WASM.isRunning(sim.wasmSim);
};
var interpolateNode = function (startPositions) {
    return function (targetPositions) {
        return function (progress) {
            return function (node) {
                var key = show(node.id);
                var newX = (function () {
                    var v = Foreign_Object.lookup(key)(targetPositions);
                    var v1 = Foreign_Object.lookup(key)(startPositions);
                    if (v1 instanceof Data_Maybe.Just && v instanceof Data_Maybe.Just) {
                        return v1.value0.x + (v.value0.x - v1.value0.x) * progress;
                    };
                    if (v instanceof Data_Maybe.Just) {
                        return v.value0.x;
                    };
                    if (v1 instanceof Data_Maybe.Just) {
                        return v1.value0.x;
                    };
                    return node.x;
                })();
                var newY = (function () {
                    var v = Foreign_Object.lookup(key)(targetPositions);
                    var v1 = Foreign_Object.lookup(key)(startPositions);
                    if (v1 instanceof Data_Maybe.Just && v instanceof Data_Maybe.Just) {
                        return v1.value0.y + (v.value0.y - v1.value0.y) * progress;
                    };
                    if (v instanceof Data_Maybe.Just) {
                        return v.value0.y;
                    };
                    if (v1 instanceof Data_Maybe.Just) {
                        return v1.value0.y;
                    };
                    return node.y;
                })();
                var $49 = {};
                for (var $50 in node) {
                    if ({}.hasOwnProperty.call(node, $50)) {
                        $49[$50] = node[$50];
                    };
                };
                $49.x = newX;
                $49.y = newY;
                return $49;
            };
        };
    };
};
var interpolatePositions = function (sim) {
    return function (startPositions) {
        return function (targetPositions) {
            return function (progress) {
                return function __do() {
                    var nodes = Effect_Ref.read(sim.nodesRef)();
                    var updatedNodes = map(interpolateNode(startPositions)(targetPositions)(progress))(nodes);
                    Effect_Ref.write(updatedNodes)(sim.nodesRef)();
                    return PSD3_ForceEngine_WASM.syncPositionsToWasm(sim.wasmSim)(updatedNodes)();
                };
            };
        };
    };
};
var initWasm = PSD3_ForceEngine_WASM.initWasm;
var getNodes = function (sim) {
    return function __do() {
        var nodes = Effect_Ref.read(sim.nodesRef)();
        return PSD3_ForceEngine_WASM.syncPositionsFromWasm(sim.wasmSim)(nodes)();
    };
};
var free = function (sim) {
    return PSD3_ForceEngine_WASM.free(sim.wasmSim);
};
var enableForces = function (sim) {
    return PSD3_ForceEngine_WASM.enableForces(sim.wasmSim);
};
var defaultConfig = /* #__PURE__ */ (function () {
    return {
        manyBody: {
            strength: -30.0,
            theta: 0.9,
            distanceMin: 1.0,
            distanceMax: 10000.0
        },
        links: {
            distance: 30.0,
            strength: 1.0,
            iterations: 1
        },
        center: {
            x: 0.0,
            y: 0.0,
            strength: 1.0
        },
        enableManyBody: true,
        enableLinks: true,
        enableCenter: true
    };
})();
var create = function (nodes) {
    return function (links) {
        return function (config) {
            return function __do() {
                var wasmSim = PSD3_ForceEngine_WASM.create(Data_Array.length(nodes))();
                PSD3_ForceEngine_WASM.configureManyBody(wasmSim)(config.manyBody)();
                PSD3_ForceEngine_WASM.configureLinks(wasmSim)(config.links)();
                PSD3_ForceEngine_WASM.configureCenter(wasmSim)(config.center)();
                PSD3_ForceEngine_WASM.enableForces(wasmSim)({
                    manyBody: config.enableManyBody,
                    links: config.enableLinks,
                    center: config.enableCenter
                })();
                PSD3_ForceEngine_WASM.setLinksFromRecords(wasmSim)(links)();
                PSD3_ForceEngine_WASM.syncPositionsToWasm(wasmSim)(nodes)();
                var nodesRef = Effect_Ref["new"](nodes)();
                var linksRef = Effect_Ref["new"](links)();
                return {
                    wasmSim: wasmSim,
                    nodesRef: nodesRef,
                    linksRef: linksRef
                };
            };
        };
    };
};
var configureManyBody = function (sim) {
    return function (config) {
        return PSD3_ForceEngine_WASM.configureManyBody(sim.wasmSim)(config);
    };
};
var configureLinks = function (sim) {
    return function (config) {
        return PSD3_ForceEngine_WASM.configureLinks(sim.wasmSim)(config);
    };
};
var configureCenter = function (sim) {
    return function (config) {
        return PSD3_ForceEngine_WASM.configureCenter(sim.wasmSim)(config);
    };
};
var capturePositions = function (nodes) {
    return fromFoldable(map(function (n) {
        return new Data_Tuple.Tuple(show(n.id), {
            x: n.x,
            y: n.y
        });
    })(nodes));
};
var applyFirstMatchingRule = function (rules) {
    return function (node) {
        var v = Data_Array.find(function ($54) {
            return (function (v1) {
                return v1(node);
            })((function (v1) {
                return v1.select;
            })($54));
        })(rules);
        if (v instanceof Data_Maybe.Just) {
            return v.value0.apply(node);
        };
        if (v instanceof Data_Maybe.Nothing) {
            return node;
        };
        throw new Error("Failed pattern match at PSD3.ForceEngine.WASMEngine (line 303, column 3 - line 305, column 20): " + [ v.constructor.name ]);
    };
};
var applyRulesInPlace = function (sim) {
    return function (rules) {
        return function __do() {
            var nodes = Effect_Ref.read(sim.nodesRef)();
            var updatedNodes = map(applyFirstMatchingRule(rules))(nodes);
            Effect_Ref.write(updatedNodes)(sim.nodesRef)();
            return syncFixedNodes(sim.wasmSim)(updatedNodes)();
        };
    };
};
var mkAdapter = function (sim) {
    return {
        getNodes: getNodes(sim),
        capturePositions: capturePositions,
        interpolatePositions: interpolatePositions(sim),
        updatePositions: updatePositions(sim),
        applyRulesInPlace: applyRulesInPlace(sim),
        reinitializeForces: pure(Data_Unit.unit),
        reheat: reheat(sim)
    };
};
export {
    defaultConfig,
    initWasm,
    isWasmReady,
    create,
    free,
    setNodes,
    setLinks,
    mkAdapter,
    tick,
    tickN,
    getNodes,
    reheat,
    isRunning,
    configureManyBody,
    configureLinks,
    configureCenter,
    enableForces
};
//# sourceMappingURL=index.js.map
