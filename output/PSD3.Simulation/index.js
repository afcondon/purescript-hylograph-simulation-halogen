// Generated by purs version 0.15.15
import * as Control_Applicative from "../Control.Applicative/index.js";
import * as Data_Array from "../Data.Array/index.js";
import * as Data_Functor from "../Data.Functor/index.js";
import * as Data_Maybe from "../Data.Maybe/index.js";
import * as Data_Ord from "../Data.Ord/index.js";
import * as Data_Show from "../Data.Show/index.js";
import * as Data_Unit from "../Data.Unit/index.js";
import * as Effect from "../Effect/index.js";
import * as Effect_Class from "../Effect.Class/index.js";
import * as Effect_Ref from "../Effect.Ref/index.js";
import * as PSD3_AST from "../PSD3.AST/index.js";
import * as PSD3_ForceEngine_Setup from "../PSD3.ForceEngine.Setup/index.js";
import * as PSD3_ForceEngine_Setup_WASM from "../PSD3.ForceEngine.Setup.WASM/index.js";
import * as PSD3_ForceEngine_Simulation from "../PSD3.ForceEngine.Simulation/index.js";
import * as PSD3_Internal_Selection_Operations from "../PSD3.Internal.Selection.Operations/index.js";
import * as PSD3_Simulation_Emitter from "../PSD3.Simulation.Emitter/index.js";
import * as PSD3_Transition_Coordinator from "../PSD3.Transition.Coordinator/index.js";
var pure = /* #__PURE__ */ Control_Applicative.pure(Effect.applicativeEffect);
var when = /* #__PURE__ */ Control_Applicative.when(Effect.applicativeEffect);
var select = /* #__PURE__ */ PSD3_Internal_Selection_Operations.select(Effect_Class.monadEffectEffect);
var $$void = /* #__PURE__ */ Data_Functor["void"](Effect.functorEffect);
var show = /* #__PURE__ */ Data_Show.show(Data_Show.showInt);
var unless = /* #__PURE__ */ Control_Applicative.unless(Effect.applicativeEffect);
var compare = /* #__PURE__ */ Data_Ord.compare(Data_Ord.ordInt);
var KeyedNode = /* #__PURE__ */ (function () {
    function KeyedNode(value0, value1) {
        this.value0 = value0;
        this.value1 = value1;
    };
    KeyedNode.create = function (value0) {
        return function (value1) {
            return new KeyedNode(value0, value1);
        };
    };
    return KeyedNode;
})();
var D3 = /* #__PURE__ */ (function () {
    function D3() {

    };
    D3.value = new D3();
    return D3;
})();
var WASM = /* #__PURE__ */ (function () {
    function WASM() {

    };
    WASM.value = new WASM();
    return WASM;
})();
var wasmConsumer = function (sim) {
    return function (emitterHandle) {
        return function (alphaRef) {
            return function (alphaMin) {
                return function (onTick) {
                    return function (_deltaMs) {
                        return function __do() {
                            var alpha = PSD3_ForceEngine_Setup_WASM.tick(sim)();
                            Effect_Ref.write(alpha)(alphaRef)();
                            var nodes = PSD3_ForceEngine_Setup_WASM.getNodes(sim)();
                            PSD3_Simulation_Emitter.emit(emitterHandle)(new PSD3_Simulation_Emitter.Tick({
                                alpha: alpha,
                                nodeCount: Data_Array.length(nodes)
                            }))();
                            onTick();
                            var $23 = alpha < alphaMin;
                            if ($23) {
                                return PSD3_Transition_Coordinator.Completed.value;
                            };
                            return new PSD3_Transition_Coordinator.Converged(alpha);
                        };
                    };
                };
            };
        };
    };
};
var unkeyNode = function (v) {
    return v.value1;
};
var renderWASMNodes = function (config) {
    return function (sim) {
        return when(config.renderNodes)(function __do() {
            var nodes = PSD3_ForceEngine_Setup_WASM.getNodes(sim)();
            var container = select(config.container)();
            return $$void(PSD3_Internal_Selection_Operations.renderTreeKeyed(container)(PSD3_AST.updateJoin("sim-nodes")(config.nodeElement)(nodes)(config.nodeTemplate)({
                enter: Data_Maybe.Nothing.value,
                update: Data_Maybe.Nothing.value,
                exit: Data_Maybe.Nothing.value,
                keyFn: new Data_Maybe.Just(function (n) {
                    return show(n.id);
                })
            })))();
        });
    };
};
var runWASMSimulation = function (config) {
    return function __do() {
        var v = PSD3_Simulation_Emitter.create();
        var sim = PSD3_ForceEngine_Setup_WASM.create(config.nodes)(config.links)();
        PSD3_ForceEngine_Setup_WASM.applySetupWithData(config.setup)(config.nodes)(config.links)(sim)();
        var setupRef = Effect_Ref["new"](config.setup)();
        var alphaRef = Effect_Ref["new"](1.0)();
        var coord = PSD3_Transition_Coordinator.create();
        var coordRef = Effect_Ref["new"](coord)();
        renderWASMNodes(config)(sim)();
        var runningRef = Effect_Ref["new"](true)();
        PSD3_Simulation_Emitter.emit(v.handle)(PSD3_Simulation_Emitter.Started.value)();
        PSD3_Transition_Coordinator.register(coord)({
            tick: wasmConsumer(sim)(v.handle)(alphaRef)(config.alphaMin)(renderWASMNodes(config)(sim)),
            onComplete: function __do() {
                Effect_Ref.write(false)(runningRef)();
                return PSD3_Simulation_Emitter.emit(v.handle)(PSD3_Simulation_Emitter.Completed.value)();
            }
        })();
        PSD3_Transition_Coordinator.start(coord)();
        return {
            events: v.emitter,
            handle: {
                updateData: function (nodes) {
                    return function (links) {
                        return function __do() {
                            var currentSetup = Effect_Ref.read(setupRef)();
                            var result = PSD3_ForceEngine_Setup_WASM.applySetupWithData(currentSetup)(nodes)(links)(sim)();
                            PSD3_ForceEngine_Setup_WASM.reheat(sim)();
                            Effect_Ref.write(1.0)(alphaRef)();
                            PSD3_Simulation_Emitter.emit(v.handle)(PSD3_Simulation_Emitter.Started.value)();
                            renderWASMNodes(config)(sim)();
                            var running = Effect_Ref.read(runningRef)();
                            unless(running)(function __do() {
                                Effect_Ref.write(true)(runningRef)();
                                var oldCoord = Effect_Ref.read(coordRef)();
                                PSD3_Transition_Coordinator.stop(oldCoord)();
                                var c = PSD3_Transition_Coordinator.create();
                                Effect_Ref.write(c)(coordRef)();
                                PSD3_Transition_Coordinator.register(c)({
                                    tick: wasmConsumer(sim)(v.handle)(alphaRef)(config.alphaMin)(renderWASMNodes(config)(sim)),
                                    onComplete: function __do() {
                                        Effect_Ref.write(false)(runningRef)();
                                        return PSD3_Simulation_Emitter.emit(v.handle)(PSD3_Simulation_Emitter.Completed.value)();
                                    }
                                })();
                                return PSD3_Transition_Coordinator.start(c)();
                            })();
                            return result;
                        };
                    };
                },
                updateSetup: function (newSetup) {
                    return function __do() {
                        Effect_Ref.write(newSetup)(setupRef)();
                        PSD3_ForceEngine_Setup_WASM.applySetup(newSetup)(sim)();
                        PSD3_ForceEngine_Setup_WASM.reheat(sim)();
                        Effect_Ref.write(1.0)(alphaRef)();
                        PSD3_Simulation_Emitter.emit(v.handle)(PSD3_Simulation_Emitter.Started.value)();
                        var running = Effect_Ref.read(runningRef)();
                        return unless(running)(function __do() {
                            Effect_Ref.write(true)(runningRef)();
                            var oldCoord = Effect_Ref.read(coordRef)();
                            PSD3_Transition_Coordinator.stop(oldCoord)();
                            var c = PSD3_Transition_Coordinator.create();
                            Effect_Ref.write(c)(coordRef)();
                            PSD3_Transition_Coordinator.register(c)({
                                tick: wasmConsumer(sim)(v.handle)(alphaRef)(config.alphaMin)(renderWASMNodes(config)(sim)),
                                onComplete: function __do() {
                                    Effect_Ref.write(false)(runningRef)();
                                    return PSD3_Simulation_Emitter.emit(v.handle)(PSD3_Simulation_Emitter.Completed.value)();
                                }
                            })();
                            return PSD3_Transition_Coordinator.start(c)();
                        })();
                    };
                },
                getNodes: PSD3_ForceEngine_Setup_WASM.getNodes(sim),
                getAlpha: Effect_Ref.read(alphaRef),
                stop: function __do() {
                    var running = Effect_Ref.read(runningRef)();
                    return when(running)(function __do() {
                        Effect_Ref.write(false)(runningRef)();
                        return PSD3_Simulation_Emitter.emit(v.handle)(PSD3_Simulation_Emitter.Stopped.value)();
                    })();
                },
                start: function __do() {
                    var running = Effect_Ref.read(runningRef)();
                    return unless(running)(function __do() {
                        PSD3_ForceEngine_Setup_WASM.reheat(sim)();
                        Effect_Ref.write(1.0)(alphaRef)();
                        Effect_Ref.write(true)(runningRef)();
                        PSD3_Simulation_Emitter.emit(v.handle)(PSD3_Simulation_Emitter.Started.value)();
                        var oldCoord = Effect_Ref.read(coordRef)();
                        PSD3_Transition_Coordinator.stop(oldCoord)();
                        var c = PSD3_Transition_Coordinator.create();
                        Effect_Ref.write(c)(coordRef)();
                        PSD3_Transition_Coordinator.register(c)({
                            tick: wasmConsumer(sim)(v.handle)(alphaRef)(config.alphaMin)(renderWASMNodes(config)(sim)),
                            onComplete: function __do() {
                                Effect_Ref.write(false)(runningRef)();
                                return PSD3_Simulation_Emitter.emit(v.handle)(PSD3_Simulation_Emitter.Completed.value)();
                            }
                        })();
                        return PSD3_Transition_Coordinator.start(c)();
                    })();
                },
                reheat: function __do() {
                    PSD3_ForceEngine_Setup_WASM.reheat(sim)();
                    Effect_Ref.write(1.0)(alphaRef)();
                    return PSD3_Simulation_Emitter.emit(v.handle)(PSD3_Simulation_Emitter.Started.value)();
                },
                interpolatePositions: function (v1) {
                    return function (v2) {
                        return function (v3) {
                            return pure(Data_Unit.unit);
                        };
                    };
                },
                pinNodes: pure(Data_Unit.unit),
                unpinNodes: pure(Data_Unit.unit)
            }
        };
    };
};
var renderNodes = function (config) {
    return function (sim) {
        return when(config.renderNodes)(function __do() {
            var nodes = PSD3_ForceEngine_Simulation.getNodes(sim)();
            var container = select(config.container)();
            return $$void(PSD3_Internal_Selection_Operations.renderTreeKeyed(container)(PSD3_AST.updateJoin("sim-nodes")(config.nodeElement)(nodes)(config.nodeTemplate)({
                enter: Data_Maybe.Nothing.value,
                update: Data_Maybe.Nothing.value,
                exit: Data_Maybe.Nothing.value,
                keyFn: new Data_Maybe.Just(function (n) {
                    return show(n.id);
                })
            })))();
        });
    };
};
var keyNode = function (n) {
    return new KeyedNode(n.id, n);
};
var initWASM = PSD3_ForceEngine_Setup_WASM.initWasm;
var eqKeyedNode = {
    eq: function (v) {
        return function (v1) {
            return v.value0 === v1.value0;
        };
    }
};
var ordKeyedNode = {
    compare: function (v) {
        return function (v1) {
            return compare(v.value0)(v1.value0);
        };
    },
    Eq0: function () {
        return eqKeyedNode;
    }
};
var d3Consumer = function (sim) {
    return function (emitterHandle) {
        return function (alphaRef) {
            return function (alphaMin) {
                return function (onTick) {
                    return function (_deltaMs) {
                        return function __do() {
                            var alpha = PSD3_ForceEngine_Simulation.tick(sim)();
                            Effect_Ref.write(alpha)(alphaRef)();
                            var nodes = PSD3_ForceEngine_Simulation.getNodes(sim)();
                            PSD3_Simulation_Emitter.emit(emitterHandle)(new PSD3_Simulation_Emitter.Tick({
                                alpha: alpha,
                                nodeCount: Data_Array.length(nodes)
                            }))();
                            onTick();
                            var $42 = alpha < alphaMin;
                            if ($42) {
                                return PSD3_Transition_Coordinator.Completed.value;
                            };
                            return new PSD3_Transition_Coordinator.Converged(alpha);
                        };
                    };
                };
            };
        };
    };
};
var runD3Simulation = function (config) {
    return function __do() {
        var v = PSD3_Simulation_Emitter.create();
        var simConfig = {
            alphaTarget: PSD3_ForceEngine_Simulation.defaultConfig.alphaTarget,
            velocityDecay: PSD3_ForceEngine_Simulation.defaultConfig.velocityDecay,
            alphaDecay: config.setup.params.alphaDecay,
            alphaMin: config.alphaMin
        };
        var sim = PSD3_ForceEngine_Simulation.create(simConfig)();
        PSD3_ForceEngine_Setup.applySetupWithData(config.setup)(config.nodes)(config.links)(sim)();
        var setupRef = Effect_Ref["new"](config.setup)();
        var alphaRef = Effect_Ref["new"](1.0)();
        var coord = PSD3_Transition_Coordinator.create();
        var coordRef = Effect_Ref["new"](coord)();
        renderNodes(config)(sim)();
        var runningRef = Effect_Ref["new"](true)();
        PSD3_Simulation_Emitter.emit(v.handle)(PSD3_Simulation_Emitter.Started.value)();
        PSD3_Transition_Coordinator.register(coord)({
            tick: d3Consumer(sim)(v.handle)(alphaRef)(config.alphaMin)(renderNodes(config)(sim)),
            onComplete: function __do() {
                Effect_Ref.write(false)(runningRef)();
                return PSD3_Simulation_Emitter.emit(v.handle)(PSD3_Simulation_Emitter.Completed.value)();
            }
        })();
        PSD3_Transition_Coordinator.start(coord)();
        return {
            events: v.emitter,
            handle: {
                updateData: function (nodes) {
                    return function (links) {
                        return function __do() {
                            var currentSetup = Effect_Ref.read(setupRef)();
                            var result = PSD3_ForceEngine_Setup.applySetupWithData(currentSetup)(nodes)(links)(sim)();
                            PSD3_ForceEngine_Simulation.reheat(sim)();
                            Effect_Ref.write(1.0)(alphaRef)();
                            PSD3_Simulation_Emitter.emit(v.handle)(PSD3_Simulation_Emitter.Started.value)();
                            renderNodes(config)(sim)();
                            var running = Effect_Ref.read(runningRef)();
                            unless(running)(function __do() {
                                Effect_Ref.write(true)(runningRef)();
                                var oldCoord = Effect_Ref.read(coordRef)();
                                PSD3_Transition_Coordinator.stop(oldCoord)();
                                var c = PSD3_Transition_Coordinator.create();
                                Effect_Ref.write(c)(coordRef)();
                                PSD3_Transition_Coordinator.register(c)({
                                    tick: d3Consumer(sim)(v.handle)(alphaRef)(config.alphaMin)(renderNodes(config)(sim)),
                                    onComplete: function __do() {
                                        Effect_Ref.write(false)(runningRef)();
                                        return PSD3_Simulation_Emitter.emit(v.handle)(PSD3_Simulation_Emitter.Completed.value)();
                                    }
                                })();
                                return PSD3_Transition_Coordinator.start(c)();
                            })();
                            return result;
                        };
                    };
                },
                updateSetup: function (newSetup) {
                    return function __do() {
                        Effect_Ref.write(newSetup)(setupRef)();
                        PSD3_ForceEngine_Setup.applySetup(newSetup)(sim)();
                        PSD3_ForceEngine_Simulation.reheat(sim)();
                        Effect_Ref.write(1.0)(alphaRef)();
                        PSD3_Simulation_Emitter.emit(v.handle)(PSD3_Simulation_Emitter.Started.value)();
                        var running = Effect_Ref.read(runningRef)();
                        return unless(running)(function __do() {
                            Effect_Ref.write(true)(runningRef)();
                            var oldCoord = Effect_Ref.read(coordRef)();
                            PSD3_Transition_Coordinator.stop(oldCoord)();
                            var c = PSD3_Transition_Coordinator.create();
                            Effect_Ref.write(c)(coordRef)();
                            PSD3_Transition_Coordinator.register(c)({
                                tick: d3Consumer(sim)(v.handle)(alphaRef)(config.alphaMin)(renderNodes(config)(sim)),
                                onComplete: function __do() {
                                    Effect_Ref.write(false)(runningRef)();
                                    return PSD3_Simulation_Emitter.emit(v.handle)(PSD3_Simulation_Emitter.Completed.value)();
                                }
                            })();
                            return PSD3_Transition_Coordinator.start(c)();
                        })();
                    };
                },
                getNodes: PSD3_ForceEngine_Simulation.getNodes(sim),
                getAlpha: Effect_Ref.read(alphaRef),
                stop: function __do() {
                    var running = Effect_Ref.read(runningRef)();
                    return when(running)(function __do() {
                        Effect_Ref.write(false)(runningRef)();
                        return PSD3_Simulation_Emitter.emit(v.handle)(PSD3_Simulation_Emitter.Stopped.value)();
                    })();
                },
                start: function __do() {
                    var running = Effect_Ref.read(runningRef)();
                    return unless(running)(function __do() {
                        PSD3_ForceEngine_Simulation.reheat(sim)();
                        Effect_Ref.write(1.0)(alphaRef)();
                        Effect_Ref.write(true)(runningRef)();
                        PSD3_Simulation_Emitter.emit(v.handle)(PSD3_Simulation_Emitter.Started.value)();
                        var oldCoord = Effect_Ref.read(coordRef)();
                        PSD3_Transition_Coordinator.stop(oldCoord)();
                        var c = PSD3_Transition_Coordinator.create();
                        Effect_Ref.write(c)(coordRef)();
                        PSD3_Transition_Coordinator.register(c)({
                            tick: d3Consumer(sim)(v.handle)(alphaRef)(config.alphaMin)(renderNodes(config)(sim)),
                            onComplete: function __do() {
                                Effect_Ref.write(false)(runningRef)();
                                return PSD3_Simulation_Emitter.emit(v.handle)(PSD3_Simulation_Emitter.Completed.value)();
                            }
                        })();
                        return PSD3_Transition_Coordinator.start(c)();
                    })();
                },
                reheat: function __do() {
                    PSD3_ForceEngine_Simulation.reheat(sim)();
                    Effect_Ref.write(1.0)(alphaRef)();
                    return PSD3_Simulation_Emitter.emit(v.handle)(PSD3_Simulation_Emitter.Started.value)();
                },
                interpolatePositions: function (startPos) {
                    return function (targetPos) {
                        return function (progress) {
                            return PSD3_ForceEngine_Simulation.interpolatePositionsInPlace(startPos)(targetPos)(progress)(sim);
                        };
                    };
                },
                pinNodes: PSD3_ForceEngine_Simulation.pinNodesInPlace(sim),
                unpinNodes: PSD3_ForceEngine_Simulation.unpinNodesInPlace(sim)
            }
        };
    };
};
var runSimulation = function (config) {
    if (config.engine instanceof D3) {
        return runD3Simulation(config);
    };
    if (config.engine instanceof WASM) {
        return runWASMSimulation(config);
    };
    throw new Error("Failed pattern match at PSD3.Simulation (line 259, column 24 - line 261, column 35): " + [ config.engine.constructor.name ]);
};
export {
    runSimulation,
    D3,
    WASM,
    initWASM
};
export {
    center,
    collide,
    dynamic,
    link,
    manyBody,
    positionX,
    positionY,
    radial,
    setup,
    static,
    withDistance,
    withDistanceMax,
    withDistanceMin,
    withFilter,
    withIterations,
    withRadius,
    withStrength,
    withTheta,
    withX,
    withY
} from "../PSD3.ForceEngine.Setup/index.js";
export {
    Completed,
    Started,
    Stopped,
    Tick,
    subscribe
} from "../PSD3.Simulation.Emitter/index.js";
//# sourceMappingURL=index.js.map
